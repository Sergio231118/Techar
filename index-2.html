<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0d1117">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="TechAr">
<link rel="manifest" id="pwa-manifest">
<link rel="apple-touch-icon" id="pwa-icon">
<script>
// ‚îÄ‚îÄ PWA MANIFEST (inline, single-file) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const icon192 = 'data:image/png;base64,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';
const icon512 = 'data:image/png;base64,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/eWuXYtfeeX1Zcu4QIQWEACAzux2+0Vjx1519dVnDx1q1hh65eY+/Mgjt8+atfiVV/76yitHjx41ayRIZtwFBOjpvDFjVrz11u+fecbE7l8nMzNzxsyZa99//xe33pqWlmb2cJB0CABAH2eeeebiJUuee/75M3r1MnssUbxe7+2zZr31zjvnjB5t9liQXAgAIF5ut/u+uXP/9tprZ+Xnmz2WZnXr1u2FF1/83wUL2rZta/ZYkCwIACAuef36vb5ixfU33GCz2cweS+vGjhu3bPnyXrm5Zg8ESYFFYCB2191ww+x773U4HLpUC4VCn3322b9Wrizcvn3//v3l5eVOpzMjI+O0nj0HDBw4dty4vLy81qu0plv37n//xz8efOCBN5Yvj78aUhoBAMTC4XDMuf/+yN33uvjg/fefnDfvq6++qv+j3++vrq4uLS39+KOPnn/uuUGDB8++775BgwbFeSyv1/vkU091ysr60/PPx1kKKY1LQIBmXq/3D88+q1f3D4VCjz/22M9uuqlB929sy+bNV0+d+sfnntPluL+8555p06frUgopihkAoI3X631p0aJBgwfrUi0cDt8/d+7S115TuX0wGPztU09VVVbOuuuu+I8+6667HE7nwgUL4i+FVMQMANDA6XQuWLhQr+6vKMqil19W3/3rPPfss2+uWKHLAGbefvvkKVN0KYWUQwAAatlstifmzx91zjl6Fdy3d+/T8+fHtu/DDz545PBhXYbxq4cein9dAamIAADUuvueey4dP17Hgr99+mmfzxfbvuXl5f+3cKEuw3C5XAsWLuyUlaVLNaQQAgBQZfS559508806Fty7Z8+qlSvjqfD3V1/V6yU/nbKynlmwwG6nIcjCf2+gdZ2ysuY9+aS+j3r9bcmSOCv4/X4d7+UfPGTIVVdfrVc1pAQCAGiFzWZ76umnMzMzdawZDof/+fbb8dfRayk44s67787OztaxIJIcAQC0YuKkScOGD9e35o7CwtLS0vjrfLFjx5EjR+KvE5Genv7gww/rVQ3JjwAAWuL1eu+8+27dy65fv16XOuFw+KMNG3QpFfHj888vGDVKx4JIZgQA0JJbpk3LMuD2mC2bN+tVatu2bXqVirht5kx9CyJpEQBAs7Kzs2+86SYjKm/dskWvUroHwKBBg0YWFOhbE8mJAACadc2113o8Ht3LlpaWlpWV6VXty127wuGwXtUibpsxQ9+CSE4EANA0t9s9eepUIyrvbu2lb5rU1NR8c+iQjgUVRRk8ZEh+En/cBnohAICmXTZhQrt27YyovGfPHn0Lfv311/oWVBTlJ5Mn614TyYYAAJp27U9/alDlQ8XF+hYsKirSt6CiKBeNHZuenq57WSQVAgBoQs+ePXN79zao+CG9r9iUfvutvgUVRfF6veMuvlj3skgqBADQhPMvuMC44iUlJUleMOKKn/zEiLJIHgQA0ARDA0CvN7jV0eWh4sYGDxnCK0KtjQAAGsrKyuo/YIBx9XW8BzTixIkT+hasM4qngi2NAAAaGj5ihL4v/qwvGAyeOH5c35rH9U6UOrwWwtoIAKChAQMHGle8qqpK9+e2jhkWACMLCvhIgIXxnxZoaICR139qqqt1r1lVWal7zYh27dr179/foOIwHQEARHG5XL379DGufpUBARAIBILBoO5lIwYPGWJQZZiOAACi9MrNTUtLM66+ETMARVFqamqMKKsoSl5enkGVYToCAIjSvXt3Q+sHjDlVr66qMqKsoih9+/UzqDJMRwAAUTqfcoqh9UPGBIBBuaIoSo8ePbxer0HFYS4CAIhyisEBYFCnNihXFEWx2+19+vY1qDjMRQAAUYyeAYRDISPKBo0pG9GrVy/jisNEBAAQpXPnzmYPIRbGzQAURenSpYtxxWEip9kDAJJLRkaGofUHDxmya/duQw+huy5du5o9BBiCGQAQxeN2mz2EpEMAWBUBAETxcMdLI10MXheBWQgAIIoRX4FPdR07dTL04TiYhQAAfuBwOJxOFsYastlsmZmZZo8C+iMAALTO6LVxmIIAAH4QDAYDgYDZo0hGbQkAKyIAgCjGvVUtpTEDsCQCAIhCADSJALAkAgCI4qutNXsIyeikk04yewjQHzc8AFEqKioMrb9506Yrp0wx9BCASswAgCglJSWG1rc7HIbWB9QjAIAo33zzjaH1XTxngKRBAABRSgwOAB40Q/IgAIAohs8AXC5D6wPqEQBAlKKDBw2tz/2USB4EABBl586d4XDYuPoZ3E+JpEEAAFEqKir279tnXH2Px8ObNZEkCACgoe3btxtav3379obWB1QiAICGdhQWGlo/RT87DOshAICGNm7caGj9znxgC8mBW5KBhnYUFh4uLe2UlWVQ/VNSMwB814+tvemS5v6pff+36dc8msjxIH4EANBQOBx+7733Jhv2xp6ePXsaVFm9Rx57TOW/4AVjxhw4cECx233jR7SwWahbdnDQGY4tX+k0QCQCl4CAJqxds8a44rm9extXXKV+/fur2ezgwYMHDhxQFCUwIi+c1cratW9igQ4jQwIRAEATPtywobKy0qDip59xht1u5v/1vF5vr1691Gy57oMPIn/wq2jugXMGhjN5yiGVEABAE2pra99Yvtyg4h6Pp7epk4Chw4apfCXRuvffVxQl1LlDIL9P61s7Hf5Lh8c5NiQSAQA0bfFf/mJc8aHDhhlXvFXnjB6tZrMTx4+vW7dOURT/hJGK3aZmF/9lIxVTJzfQhP9UQNN279796SefGFTcxABwOBwXjR2rZsu3337b7/crLof/ErXn9aHs9oHhfeMYHRKKAACa9edFiwyqPGLkyPT0dIOKt2xkQUHHjh3VbBm5COYffWa4XVv19f0TR8U2MCQeAQA0a/W7727//HMjKrvd7h+ff74RlVt13fXXq9nsPzt3btm8WdHe0ANn9wl17hDDwJB4BADQrHA4/MTjjxtUfOKkSQZVbkHvPn0KRqlq6H964QVFUUI9OgcHanxqwW7zTxgZw9iQeAQA0JKNGzeufvddIyqPLChI/AMB98yerWazQ8XF/3z7bSXWW/v9lwxXXHz6OAUQAEArnpw3r6amxojKP7vlFiPKNueCCy8cWaCqof9hwYJgMBj2pAUuyo/hQOF2bf3nDophRyQYAQC0Yv/+/fN+8xsjKl86fvygwYONqNxYhw4dfv2oqnf1FG7fvmzpUkVRAhecFU73xnY4NQ+OwXQEANC6JX/965rVq3Uva7PZHnr44QR8JdjpdP7+mWcyMzPVbPzoI49EvokWTxMPDugZOi0l33knCgEAqDLn3ntLS0t1L9u7T59fPfSQ7mXrs9vtv5k37+yhQ9Vs/OdFiyI3/wT7dAv2OjWe4/JqoORHAACqlJWVTfvZz4x4QdDkKVNuNmwxwOFwPDl//oSJE9VsvOs//5n/xBORP/snNbxZyF5yVNOhAxedHfa6Ne2CBCMAALV27Ngx/ec/9/l8ulf+5T33zJg5U/eyHTt2fPkvfxk/YYKajauqqu68447Iv104o41/TNTihH1fifuZpZqOHm7jDlx4lqZdkGB8DwDQ4JOPP777zjt//8wzur/O87aZM/v26zf33nuPHtV2ot2ccRdffP+vfqXyod9gMDjj1lt3794d+at/3FDFHbUy4Vq+zrmh0Ha4LNypnfox+CaOcr2xQf32iRfucFJg1MBgnx+FTu8S6nCyku4Jp7kUf8BWWW07Xmk7Vm4/csJ2+Jhj29fOj3aYPVj92TLaZ5s9BiSdfv37L339dbNHEZdDxcXnqXvlWQwuGjt2/tNPu936X984evToc88+u2Tx4njmGWfl599+xx0qL/pH3Dd7duTOn4jKxQ+EfvTDB9FsNb70iXNtlTW1N17su2GcpsG0mf5bR+FeTbs0VnvrJN/UMTHvbi8+kj714QY/Bgf2rL1hXHBQLzXvuXOu2ex96KWYB5C0uAQEaLZq5crrrrnm2LFjulfOzMycM3fumn//e9Zdd/U47TRN+3bKyrrq6quXLV++eMkS9d0/GAzeP2dO/e4fHNyrfvdXFMX57me2yhpFUdLe/FAJhTSNKgnvBw1ntKl+9OaqP9wRHJKr8i2nVsUlICAWW7ZsmXzFFS+8+GL3Hj10L56VlTVt+vRp06cXFRVt/PTT7Z9/vn///qKiouNlZTU1NbW1tS6Xy+12Z3bokJOT07179959+gwaNKh3HxWv7I/m8/nuvOOOd//1r6gfGy3/pr2+LvIH2+Ey54c7AgWqviYW4R8z2L1gme24UV/X0Sp0WufqJ6aFclTdEWt5BAAQowMHDkyaMGH2ffdNvfJKgw7RtWvXrl27Trr8ciOKFxcVzbr99m3bttX/MZx5UoP+7tixz/5VUd1fXW+s1xQAisvpv3hY2hIDP7GpXujUrKrfzQhnZpg9kGTBJSAgdlVVVQ8+8MBN119fUlJi9li0WbVy5YTx4xt0f0VR/OOHK86o1/i4lq+r/1fnpzvt33yn6Vj+CQWKzfwrLeE27uqnptP962MGAMRr/fr1l44bd9vMmVdedZURK8P6OlRcPO/xx1etXNnEP7Pb/OOjXuRpO1HlWrslaptQ2PXmh7W3jFd/xFCXjoH8XOen/4lluIqiKIp74evuhQ3vSqj885xQj87qi9TOmhw6RdU9UXIQAIAOysvLH3/ssZdefPG2mTMvv+IKhyMZ34VZXl6+6KWXXnj++ebebRcYnhfKbl//F9c/P1Z8/gabud76qPbGixtMFFrmnzgqngCIX3DQGf6xZ9f/xfHFPtc7nzi2fW375jtbMBg+uW2wdzf/2PzAOQOTYb6SGAQAoJuSkpL758z50wsvXHf99eMvuywjI1muNhwuLV20aNGSxYsrKipa2Kzht1/CYdcb6xtvZjtW7lz3eeA8De/7DIzsF+7Uzna4TP0u+qqddlndn20nqjzzlzj/vbX+BrYjx53rP3eu/zwwPK/m1zeGPWmJHqIZWAMAdLZv796HH3xw1IgR982eHXmvjlkCgcCa1atn3nbbeaNHv/DHP7bc/UM5mYGzo+4jcm7cZS863OTGacubCIaW2O2+y0Zo20U/oVM6BPt2j/zZ9t2JNtOebtD963N+tMP9u9cSMzDTMQMADFFdXb1s6dJlS5d26dr1nNGjR48ePWz4cK83xrcra3Ls2LEPN2xYv27d2jVrysrKVO7ln1DQ4Kb4Bsu/9Tk2f2k/UNrgcYFW6l86wv3ySiWo7TECfdRd0vEH2vzyWfvBVl7q53rnE9+UMaHTNCwwpCgCAE0o3L499/TTzR6FRRQXFS1ZvHjJ4sVpaWln5ecPHDiwT9++ffr2PfXUU206XWsOBoO7v/qqcPv2wsLCbVu3fvHFF5H3OWvgcvgvGVb/B9vhMueGwpb2WLGh9jYNX7UMdzw5UDDA+f5WbQPTlXvRyvq3tDYrHHat/kzTQneKIgCABPH5fB9u2PDhhu/fjdO2bdteubldunbNzs7OycnJzs7OzsnJaNvW4/Gkud1ut9vj8TidzmAw6Pf7/T6fz++vrKwsKys7dvRoWVnZd999V3Twe8VFRX5/w6VaTfyjzwy3j1qxSFvRykO/rnc+rr3lUiVNw8cMfJMKTAwA29Fy16vvqdzYse1rQweTJAgAwBwVFRWbN23avGmT2QNRlMbLv8GQ660PW97FdqLK9e+t/gs1fDMyOLhX6NSsVq/AGCRtyWpbjdo3LNmLm178sBgCAJAu1D0nOLBn/V+c6z+3HTne6o6u5es1BYBis/knFrgXLNM6Qh2Ew641Ghbkbd+dyBg1w7jhJAnuAgKka3j6ryhpr6u6ycexfY99zyFtx2r0ounEcOzcb+JNqEmLAABEC3vS/GOjzuLtB0sdm79UuXuaxtf9N/7UTGI4TH0MLWkRAIBogfPPCqdH3ZzqWr5eUX0TkXPVp+ovrEc0/thkAjj2fpP4gyY/AgAQzT8p+n39tX7XO5+o391WWeNcrW0dO/7PzcfATgA0hQAA5Grci11rNtnKqzQVaeF5seY0TB3jNfdIs3AEACBX4891ubS+40FRHLsOOnYd1LRL4+tOxvIHFX8gcYdLHQQAIFS4rdf/4yH1f3HsOujYuT+GUlpjI+xJa/BuTkPZqpp++yl4DgAQyn/xsAZ3ZAZzTy1ftyBBR59YkLb0/cQcy1Zdm5gDpRxmAIBQ/glmfq491D0neGai3jdlyhvoUgEBAEgUHHyGpnd5GsHX6AE0JBgBAEiUDM03MHogX+g1FwEAiBPOzAiMGmD2KBTF6fBfMtzsQYjGIjAgjv/SEQ2+6Ot55M+uf22Mt26aq+L1R8MntdEwkstGpi1+Vwlp/HoBdMIMABDGbvNfNrL+D7byKlfzn0jUwOfXmiKhnMzAsDwdDo2YEACALIHheaHs9vV/ca38VPHF9T2ZH0q9qe3dcEpTD6MhYQgAQJbGd3+6Vmju2s2x7/nG8cU+TbsEhvYN5WTqNQBoQgAAgoRyMgND+9b/xbF9j31fiY6HcL3ZyqfEGrLbzH0iQTICABDEP6FAsUd9iV7H0/8I5+pNtiptT976LxmmuBytbwe9EQCAGC6H/5Jh9X+wlVe53tui70FsNT7nGm0viA63z/CPPlPfYUANAkCzhL0sBdBX4Jwzw+2jHrxyrdqo1Oqz/BtVVutVoKY+S4kEsE4AJKYvR45Svm4BMYCU42v0Fn7dr/9EOHbut39drGmX4MCeoR6djRgMWmCFAKhrxwluysQAUkioe05wYNTL1xyFe437TlYMkwAf94MmXGoHQIJbcJPHIgaQEpr49osxp//fF1+1UeuzBYGLzg570gwaD5qUqgHQXNs1pRdnjJqR+IMC6jX+AIutotq1drNxR7RVVGt9ujic7glcmG/McNC0VA2AxPdcTvORuhp/gtGg5d+oQ6zgKlCys2W0zzZ7DDFqoSMbEQ/NHY7TfySh6kdvCmi/sdKxfU+bX/wutiOGO7WrWPZIbPu2wHa0vO2EOeHMkyreeEz34vaSo+n/86DuZVNIqs4AlMR2Xk7/AVhPCgdACxLWrzn9B5C6UjsAWui/OmYAp/8ALCm1AyABErzSAAAJk8KLwHUM7dEEAACrssIMwLhGTPcHYGFWCIAWGHT5nu4PwAIsEgCJvPEfAKzBIgHQAt37OKf/AKzBOgGg7y2hnP4DsDzrBICOWPsFIIGlAiAxz4UBgDVYKgAUbvwHANWsFgAtiHMSQPcHYDEWDIB4LgRxpQiAHBYMACNw+g/AeqwZALFNAjj9ByCKNQNA0fWcndN/AJZk2QBoQfJ8TR4ATGTlAFB/5s6tnwAEsnIAtIDzfQCweACoWQ3m9B+ATBYPgHjQ/QFYmxU+Cdmq2C74EAAArE3EDCCGVk73B2B5IgIAANCYlADQdEbP6T8ACaQEAACgAUEBoPK8ntN/AEKYfxeQ8GeyyBsAZhE0AwAA1EcAAIBQBAAACEUAAIBQBAAACEUAAIBQBAAACGX+cwCJofVpA27PB2B5zAAAQCgRARDDw8bCn08GIIGIAGhOxqgZXOoBIJb1AyDmc3kmAQCszeIBoOaD72o+HA8A1mPxAAAANMfKAaDm9L/Jv6osAgApzcoB0Jwm2z2rwQCksWwA6HjmziQAgCVZNgCa08KZPpMAAKJYMwB0P2dnEgDAeqwZAM1p9Ryf1WAAclgwAOjUAKCG1QJA/a2fMWxGtACwEqsFgC5YDQYggaUCIP7T/3gOAQCpxVIB0JwYuj8XggBYnnUCgL4MAJpYJwCaE/PFHyYBAKzNIgFgUEdmNRiAhVkhABKw9qvpoACQEqwQAIZiEgDAqlI+AEw5/W/10ACQ/FI+AJqjY/dnNRiAJaV2ANB/ASBmqR0AzdH94g+TAADWk8IBkODOy2owAItJ4QBoTuI7NZMAAKkoVQPAlJ7LJACAlaRqAGSMmtFkOzarRzMJAJBybBnts80eQ7zqN98EBEDjXs/MAEAqcpo9AB1E+m/5ugWJb8S0fgCpywozgMQzJWwAQF8EAAAIlaqLwACAOBEAACAUAQAAQhEAACAUAQAAQtnLj31r9hgAAIlWfuxbZgAAIBQBAABCEQAAIBQBAABCEQAAIJRdURRuBAIAUSJtnxkAAAhFAACAUAQAAAj1fQCwDAAAQtQ1fGYAACAUAQAAQv0QAFwFAgDLq9/qmQEAgFAEAAAIFRUAXAUCAAtr0OSZAQCAUA0DgEkAAFhS4/bODAAAhCIAAECoJgKAq0AAYDFNNnZmAAAgVNMBwCQAACyjuZbe7AyADAAAC2ihmXMJCACEaikAmAQAQEpruY0zAwAAoVoJACYBAJCiWm3grc8AyAAASDlqWreqS0BkAACkEJVNmzUAABBKbQAwCQCAlKC+XWuYAZABAJDkNDVqbZeAyAAASFpaW7TmNQAyAACSUAzNOZZFYDIAAJJKbG2Zu4AAQKgYA4BJAAAkiZgbsi3OA2e0z46zAgAgNnGei8d7CYipAACYIv72q8MaABkAAAmmS+PVZxGYDACAhNGr5ep2FxAZAAAJoGOzjXcRuDGWhQHACLqfZ+v/HABTAQDQnRGt1ZAHwcgAANCRQU1V/0tA9XE5CADiYej5tLEBEEEMAIBWCbiUkoh3AXFFCAA0SUzbTMQMoA5TAQBoWSLPmBMaAHVIAgCoz5QrJeYEQAQxAAAmXiQ3MwDqkAQApEmGxdGkCIA6JAEAa0uGvl8nuQKgPsIAgDUkVdOvL3kDoDEiAUDyS9p239j/A1iou8UIcyOoAAAAAElFTkSuQmCC';

const manifest = {
  name: 'TechAr ‚Äî Laudos & PMOC',
  short_name: 'TechAr',
  description: 'Sistema de Laudos T√©cnicos e PMOC para Engenharia HVAC',
  start_url: '.',
  display: 'standalone',
  background_color: '#0d1117',
  theme_color: '#00d4aa',
  orientation: 'portrait-primary',
  icons: [
    { src: icon192, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
    { src: icon512, sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
  ]
};
const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(blob);
document.getElementById('pwa-manifest').setAttribute('href', manifestURL);
document.getElementById('pwa-icon').setAttribute('href', icon192);

// ‚îÄ‚îÄ SERVICE WORKER (inline via blob) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'techar-v1';
    self.addEventListener('install', e => {
      self.skipWaiting();
    });
    self.addEventListener('activate', e => {
      e.waitUntil(caches.keys().then(keys =>
        Promise.all(keys.filter(k => k !== CACHE).map(k => caches.delete(k)))
      ));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
    });
  `;
  const swBlob = new Blob([swCode], {type: 'application/javascript'});
  const swURL = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swURL, {scope: './'}); 
}
</script>

<title>TechAr ‚Äî Sistema de Laudos & PMOC</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Sora:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d1117;
    --bg2: #161b22;
    --bg3: #21262d;
    --border: #30363d;
    --accent: #00d4aa;
    --accent2: #0099ff;
    --accent3: #ff6b35;
    --text: #e6edf3;
    --text2: #8b949e;
    --text3: #484f58;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Sora', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* GRID BACKGROUND */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,170,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,170,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* NAV */
  nav {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(13,17,23,0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 1.2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 1.4rem;
    color: var(--accent);
    letter-spacing: -0.5px;
    flex-shrink: 0;
  }
  .logo span { color: var(--text2); font-size: 0.62rem; display: block; font-family: 'Sora'; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; }

  /* HAMBURGER BUTTON */
  .ham-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text2);
    width: 40px; height: 40px;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 5px; cursor: pointer; flex-shrink: 0;
    transition: all 0.2s;
  }
  .ham-btn:hover { border-color: var(--accent); color: var(--accent); }
  .ham-btn span { display: block; width: 18px; height: 2px; background: currentColor; border-radius: 2px; transition: all 0.25s; }
  .ham-btn.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
  .ham-btn.open span:nth-child(2) { opacity: 0; transform: scaleX(0); }
  .ham-btn.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

  /* DRAWER MENU */
  .nav-drawer {
    position: fixed;
    top: 56px; right: 0; bottom: 0;
    width: min(280px, 85vw);
    background: var(--bg2);
    border-left: 1px solid var(--border);
    z-index: 99;
    transform: translateX(100%);
    transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
    overflow-y: auto;
    padding: 1rem 0.8rem;
    display: flex; flex-direction: column; gap: 0.3rem;
  }
  .nav-drawer.open { transform: translateX(0); }

  .nav-overlay {
    position: fixed; inset: 0; top: 56px;
    background: rgba(0,0,0,0.5);
    z-index: 98;
    opacity: 0; pointer-events: none;
    transition: opacity 0.28s;
  }
  .nav-overlay.open { opacity: 1; pointer-events: all; }

  .drawer-section {
    font-family: 'DM Mono'; font-size: 0.6rem; color: var(--text3);
    letter-spacing: 1.5px; text-transform: uppercase;
    padding: 0.6rem 0.5rem 0.2rem;
    margin-top: 0.5rem;
  }

  .nav-btn {
    background: none;
    border: 1px solid transparent;
    color: var(--text2);
    padding: 0.7rem 0.9rem;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'Sora', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 0.6rem;
    text-align: left; width: 100%;
  }
  .nav-btn:hover { background: var(--bg3); color: var(--text); }
  .nav-btn.active {
    background: rgba(0,212,170,0.1);
    border-color: rgba(0,212,170,0.25);
    color: var(--accent);
  }
  .nav-btn .nav-badge {
    margin-left: auto;
    font-size: 0.58rem; font-family: 'DM Mono';
    background: var(--bg3); border: 1px solid var(--border);
    color: var(--text3); padding: 0.1rem 0.35rem; border-radius: 3px;
    letter-spacing: 0.5px;
  }
  .nav-btn.active .nav-badge { background: rgba(0,212,170,0.1); border-color: rgba(0,212,170,0.2); color: var(--accent); }



  /* MAIN */
  main {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  /* SECTIONS */
  .section { display: none; animation: fadeIn 0.3s ease; }
  .section.active { display: block; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .section-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }
  .section-header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    color: var(--text);
    margin-bottom: 0.3rem;
  }
  .section-header p { color: var(--text2); font-size: 0.85rem; font-weight: 300; }
  .badge {
    display: inline-block;
    background: rgba(0,212,170,0.1);
    border: 1px solid rgba(0,212,170,0.2);
    color: var(--accent);
    font-family: 'DM Mono';
    font-size: 0.65rem;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    letter-spacing: 1px;
    margin-bottom: 0.5rem;
  }

  /* FORM STYLES */
  .card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .card-title {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--accent);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  .form-grid.three { grid-template-columns: 1fr 1fr 1fr; }
  .form-grid.full { grid-template-columns: 1fr; }

  .field { display: flex; flex-direction: column; gap: 0.4rem; }
  .field.span2 { grid-column: span 2; }
  .field.span3 { grid-column: span 3; }

  label {
    font-size: 0.72rem;
    color: var(--text2);
    font-weight: 500;
    letter-spacing: 0.3px;
  }

  input, select, textarea {
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.6rem 0.8rem;
    border-radius: 8px;
    font-family: 'Sora';
    font-size: 0.82rem;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
  }
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,212,170,0.1);
  }
  select option { background: var(--bg3); }
  textarea { resize: vertical; min-height: 80px; }

  /* CHECKLIST */
  .check-group { margin-bottom: 1.2rem; }
  .check-group-title {
    font-size: 0.72rem;
    color: var(--accent);
    font-family: 'DM Mono';
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 0.7rem;
  }
  .check-item {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    padding: 0.6rem 0.8rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.15s;
    border: 1px solid transparent;
  }
  .check-item:hover { background: var(--bg3); border-color: var(--border); }
  .check-item.ok { border-color: rgba(0,212,170,0.2); background: rgba(0,212,170,0.04); }
  .check-item.nok { border-color: rgba(255,107,53,0.25); background: rgba(255,107,53,0.04); }
  .check-item.na { border-color: rgba(139,148,158,0.2); background: rgba(139,148,158,0.03); }

  .check-label { flex: 1; font-size: 0.82rem; color: var(--text); }
  .check-status {
    display: flex;
    gap: 0.4rem;
  }
  .status-btn {
    padding: 0.2rem 0.6rem;
    border-radius: 5px;
    border: 1px solid var(--border);
    background: none;
    cursor: pointer;
    font-size: 0.68rem;
    font-family: 'DM Mono';
    color: var(--text2);
    transition: all 0.15s;
  }
  .status-btn.ok-btn.selected { background: rgba(0,212,170,0.15); border-color: var(--accent); color: var(--accent); }
  .status-btn.nok-btn.selected { background: rgba(255,107,53,0.15); border-color: var(--accent3); color: var(--accent3); }
  .status-btn.na-btn.selected { background: rgba(139,148,158,0.12); border-color: var(--text3); color: var(--text2); }

  /* BUTTONS */
  .btn-primary {
    background: var(--accent);
    color: #0d1117;
    border: none;
    padding: 0.8rem 2rem;
    border-radius: 8px;
    font-family: 'Sora';
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-primary:hover { background: #00f0c0; transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,212,170,0.3); }

  .btn-secondary {
    background: none;
    color: var(--text2);
    border: 1px solid var(--border);
    padding: 0.8rem 2rem;
    border-radius: 8px;
    font-family: 'Sora';
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-secondary:hover { border-color: var(--text2); color: var(--text); }

  .btn-danger {
    background: none;
    color: var(--accent3);
    border: 1px solid rgba(255,107,53,0.3);
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Sora';
  }
  .btn-danger:hover { background: rgba(255,107,53,0.1); }

  .actions { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }

  /* PREVIEW / OUTPUT */
  .preview-box {
    background: #fff;
    color: #111;
    border-radius: 12px;
    padding: 3rem;
    margin-top: 1.5rem;
    font-family: 'Times New Roman', serif;
    line-height: 1.8;
    font-size: 0.95rem;
    display: none;
    position: relative;
  }
  .preview-box.show { display: block; }

  .preview-box h2 {
    text-align: center;
    font-size: 1.1rem;
    margin-bottom: 0.3rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .preview-box .preview-subtitle {
    text-align: center;
    font-size: 0.8rem;
    color: #555;
    margin-bottom: 2rem;
    border-bottom: 2px solid #333;
    padding-bottom: 1rem;
  }
  .preview-box .preview-section-title {
    font-weight: bold;
    font-size: 0.9rem;
    text-transform: uppercase;
    background: #f0f0f0;
    padding: 0.3rem 0.6rem;
    margin: 1.2rem 0 0.5rem;
    border-left: 4px solid #333;
  }
  .preview-box .preview-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-bottom: 0.3rem;
    font-size: 0.88rem;
  }
  .preview-box .preview-row span:first-child { color: #555; font-size: 0.8rem; }
  .preview-box .preview-full { font-size: 0.88rem; margin-bottom: 0.5rem; }
  .preview-box .preview-full span { color: #555; font-size: 0.8rem; display: block; }
  .preview-box .signature-area {
    margin-top: 3rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    text-align: center;
    font-size: 0.82rem;
  }
  .preview-box .sig-line {
    border-top: 1px solid #333;
    padding-top: 0.4rem;
    margin-top: 2rem;
  }

  .print-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #333;
    color: #fff;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  .print-btn:hover { background: #000; }

  .doc-actions-bar {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: flex-end;
  }
  .wa-btn {
    background: #25D366;
    color: #fff;
    border: none;
    padding: 0.4rem 0.9rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    font-family: 'Sora', sans-serif;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    transition: background 0.2s;
  }
  .wa-btn:hover { background: #1da851; }
  .pdf-btn {
    background: #e53935;
    color: #fff;
    border: none;
    padding: 0.4rem 0.9rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.75rem;
    font-family: 'Sora', sans-serif;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    transition: background 0.2s;
  }
  .pdf-btn:hover { background: #b71c1c; }

  /* PMOC TABLE */
  .pmoc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
    background: white;
    color: #111;
    margin-top: 1rem;
  }
  .pmoc-table th {
    background: #1a1a2e;
    color: white;
    padding: 0.5rem;
    text-align: left;
    font-size: 0.72rem;
    letter-spacing: 0.5px;
  }
  .pmoc-table td {
    padding: 0.45rem 0.5rem;
    border-bottom: 1px solid #e5e5e5;
    vertical-align: top;
  }
  .pmoc-table tr:nth-child(even) td { background: #f9f9f9; }
  .freq-cell { display: flex; gap: 4px; flex-wrap: wrap; }
  .freq-tag {
    background: #e8f5e9;
    color: #2e7d32;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 0.65rem;
  }

  /* EQUIPAMENTO CARD */
  .equip-card {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.8rem;
    position: relative;
  }
  .equip-card .remove-equip {
    position: absolute;
    top: 0.8rem;
    right: 0.8rem;
    background: none;
    border: none;
    color: var(--text3);
    cursor: pointer;
    font-size: 1rem;
    transition: color 0.15s;
  }
  .equip-card .remove-equip:hover { color: var(--accent3); }
  .equip-num {
    font-family: 'DM Mono';
    font-size: 0.65rem;
    color: var(--accent);
    margin-bottom: 0.7rem;
  }

  /* SUMMARY STATS */
  .stats-bar {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
  }
  .stat-number { font-family: 'DM Serif Display'; font-size: 2rem; color: var(--accent); }
  .stat-label { font-size: 0.7rem; color: var(--text2); margin-top: 0.2rem; text-transform: uppercase; letter-spacing: 1px; }

  /* CHECKLIST SUMMARY */
  .check-summary {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    font-size: 0.75rem;
    font-family: 'DM Mono';
  }
  .cs-ok { color: var(--accent); }
  .cs-nok { color: var(--accent3); }
  .cs-na { color: var(--text2); }

  @media (max-width: 600px) {
    .form-grid { grid-template-columns: 1fr; }
    .form-grid.three { grid-template-columns: 1fr; }
    .field.span2, .field.span3 { grid-column: span 1; }
    .stats-bar { grid-template-columns: 1fr; }
    nav { gap: 0.5rem; padding: 0 1rem; }
    .nav-btn { padding: 0.3rem 0.6rem; font-size: 0.65rem; }
    .preview-box { padding: 1.5rem; }
  }

  @media print {
    body { background: white; }
    body::before { display: none; }
    nav { display: none; }
    .actions { display: none; }
    .print-btn { display: none; }
    .section-header { display: none; }
    .card { display: none; }
    .preview-box { display: block !important; box-shadow: none; }
  }

  /* FOTOS */
  #foto-dropzone:hover { border-color: var(--accent); background: rgba(0,212,170,0.03); }
  #foto-dropzone:active { transform: scale(0.99); }
  .foto-item {
    position: relative; border-radius: 10px; overflow: hidden;
    border: 1px solid var(--border); background: var(--bg3); aspect-ratio: 4/3;
  }
  .foto-item img { width:100%; height:100%; object-fit:cover; display:block; }
  .foto-item .foto-overlay {
    position:absolute; inset:0; background:rgba(0,0,0,0.65);
    display:flex; flex-direction:column; justify-content:flex-end;
    opacity:0; transition:opacity 0.2s; padding:0.5rem;
  }
  .foto-item:hover .foto-overlay, .foto-item:active .foto-overlay { opacity:1; }
  .foto-legenda {
    background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.15);
    border-radius:5px; color:#fff; font-size:0.68rem; padding:0.25rem 0.4rem;
    width:100%; font-family:'Sora'; margin-bottom:0.4rem;
    placeholder-color: #aaa;
  }
  .foto-remove {
    background:rgba(255,107,53,0.85); border:none; color:#fff;
    border-radius:5px; font-size:0.7rem; padding:0.3rem 0.6rem;
    cursor:pointer; width:100%; font-family:'Sora';
  }
  .foto-num {
    position:absolute; top:0.4rem; left:0.4rem;
    background:rgba(0,212,170,0.9); color:#0d1117;
    font-family:'DM Mono'; font-size:0.6rem; font-weight:500;
    padding:0.15rem 0.4rem; border-radius:4px;
  }
  /* LOGO & ASSINATURA */
  .config-preview-logo {
    width:120px; height:60px; object-fit:contain;
    border:1px solid var(--border); border-radius:8px; background:var(--bg3); padding:4px;
  }
  .sig-canvas-wrap { background:white; border-radius:10px; overflow:hidden; border:1px solid var(--border); touch-action:none; }
  canvas { display:block; cursor:crosshair; }
  .sig-actions { display:flex; gap:0.5rem; margin-top:0.5rem; }
  .sig-clear { background:none; border:1px solid var(--border); color:var(--text2); padding:0.4rem 0.9rem; border-radius:6px; cursor:pointer; font-size:0.75rem; font-family:'Sora'; }
  .sig-clear:hover { border-color:var(--accent3); color:var(--accent3); }
  .sig-save { background:var(--accent); border:none; color:#0d1117; padding:0.4rem 1rem; border-radius:6px; cursor:pointer; font-size:0.75rem; font-weight:600; font-family:'Sora'; }
  /* LOGIN */
  #login-screen {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    padding: 1.5rem;
  }
  #login-screen.hide { display: none; }
  .login-box {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 20px; padding: 2.5rem 2rem;
    width: 100%; max-width: 360px; text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .login-logo {
    font-family: 'DM Serif Display'; font-size: 2.2rem;
    color: var(--accent); margin-bottom: 0.2rem;
  }
  .login-sub {
    font-size: 0.7rem; color: var(--text3); text-transform: uppercase;
    letter-spacing: 2px; margin-bottom: 2rem;
  }
  .login-input {
    width: 100%; background: var(--bg3); border: 1px solid var(--border);
    border-radius: 10px; padding: 0.85rem 1rem;
    color: var(--text); font-size: 1rem; font-family: 'Sora';
    text-align: center; letter-spacing: 3px;
    transition: border-color 0.2s; margin-bottom: 1rem;
  }
  .login-input:focus { outline: none; border-color: var(--accent); }
  .login-input.erro { border-color: #ff6b35; animation: shake 0.4s ease; }
  .login-btn {
    width: 100%; background: var(--accent); border: none; color: #0d1117;
    padding: 0.9rem; border-radius: 10px; font-family: 'Sora';
    font-weight: 700; font-size: 0.95rem; cursor: pointer;
    transition: all 0.2s; margin-bottom: 0.8rem;
  }
  .login-btn:hover { background: #00f0c0; transform: translateY(-1px); }
  .login-btn:active { transform: translateY(0); }
  .login-erro { color: #ff6b35; font-size: 0.78rem; min-height: 1.2rem; margin-bottom: 0.5rem; }
  .login-versao { font-size: 0.65rem; color: var(--text3); margin-top: 1.5rem; }
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-5px); }
    80% { transform: translateX(5px); }
  }
  /* esconde app enquanto n√£o logado */
  body.locked nav, body.locked .nav-drawer, body.locked .nav-overlay, body.locked main { display: none !important; }
</style>
<body class="locked">

<!-- TELA DE LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">TechAr</div>
    <div class="login-sub">Engenharia HVAC</div>
    <input type="password" id="login-senha" class="login-input"
      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="30"
      onkeydown="if(event.key==='Enter') tentarLogin()"
      oninput="document.getElementById('login-msg').textContent=''">
    <div class="login-erro" id="login-msg"></div>
    <button class="login-btn" onclick="tentarLogin()">Entrar ‚Üí</button>
    <div class="login-versao">TechAr v2.0 ‚Äî Acesso restrito</div>
  </div>
</div>

<nav>
  <div class="logo">TechAr <span>Engenharia HVAC</span></div>
  <button class="ham-btn" id="ham-btn" onclick="toggleDrawer()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
</nav>

<div class="nav-overlay" id="nav-overlay" onclick="closeDrawer()"></div>

<div class="nav-drawer" id="nav-drawer">
  <div class="drawer-section">Documentos</div>
  <button class="nav-btn active" id="nb-laudo"    onclick="showSection('laudo')">    üìÑ Laudo T√©cnico       <span class="nav-badge">M01</span></button>
  <button class="nav-btn"        id="nb-visita"   onclick="showSection('visita')">   üîß Visita T√©cnica      <span class="nav-badge">M05</span></button>
  <button class="nav-btn"        id="nb-orcamento"onclick="showSection('orcamento')">üí∞ Or√ßamento           <span class="nav-badge">M06</span></button>
  <div class="drawer-section">Manuten√ß√£o</div>
  <button class="nav-btn"        id="nb-pmoc"     onclick="showSection('pmoc')">     üìã PMOC Geral          <span class="nav-badge">M02</span></button>
  <button class="nav-btn"        id="nb-odonto"   onclick="showSection('odonto')">   üè• PMOC Sa√∫de          <span class="nav-badge">M04</span></button>
  <button class="nav-btn"        id="nb-checklist"onclick="showSection('checklist')">‚úÖ Checklist Vistoria  <span class="nav-badge">M03</span></button>
  <div class="drawer-section">Ferramentas</div>
  <button class="nav-btn"        id="nb-carga"    onclick="showSection('carga')">    ‚ùÑÔ∏è Carga T√©rmica       <span class="nav-badge">M07</span></button>
  <button class="nav-btn"        id="nb-historico"onclick="showSection('historico')">üìÅ Hist√≥rico           <span class="nav-badge">M08</span></button>
  <button class="nav-btn"        id="nb-relatorios"onclick="showSection('relatorios')">üìä Relat√≥rios         <span class="nav-badge">M09</span></button>
  <div class="drawer-section">Configura√ß√µes</div>
  <button class="nav-btn" id="nb-config" onclick="showSection('config')" style="color:#ff6b35;">‚öôÔ∏è Minha Empresa</button>
  <button class="nav-btn" onclick="fazerLogout()" style="color:#ff4444;margin-top:0.5rem;border-color:rgba(255,68,68,0.2);">üîí Sair do App</button>
</div>

<main>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LAUDO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section active" id="section-laudo">
    <div class="section-header">
      <div class="badge">M√ìDULO 01</div>
      <h1>Laudo T√©cnico de Instala√ß√£o</h1>
      <p>Preencha os dados abaixo para gerar o laudo de vistoria de ar condicionado</p>
    </div>

    <div class="card">
      <div class="card-title">Identifica√ß√£o do Respons√°vel</div>
      <div class="form-grid">
        <div class="field">
          <label>Nome do Engenheiro</label>
          <input type="text" id="l_eng" placeholder="Eng. Jo√£o da Silva">
        </div>
        <div class="field">
          <label>CREA / CFM</label>
          <input type="text" id="l_crea" placeholder="CREA-XX 000000">
        </div>
        <div class="field">
          <label>ART N¬∫</label>
          <input type="text" id="l_art" placeholder="N¬∫ da ART">
        </div>
        <div class="field">
          <label>Data do Laudo</label>
          <input type="date" id="l_data">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Dados do Cliente / Local</div>
      <div class="form-grid">
        <div class="field span2">
          <label>Raz√£o Social / Nome do Cliente</label>
          <input type="text" id="l_cliente" placeholder="Empresa Ltda. ou Nome Completo">
        </div>
        <div class="field span2">
          <label>Endere√ßo Completo</label>
          <input type="text" id="l_endereco" placeholder="Rua, n√∫mero, bairro, cidade - UF">
        </div>
        <div class="field">
          <label>CNPJ / CPF</label>
          <input type="text" id="l_cnpj" placeholder="00.000.000/0000-00">
        </div>
        <div class="field">
          <label>N¬∫ do Laudo</label>
          <input type="text" id="l_numero" placeholder="LT-001/2025">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Dados do Equipamento</div>
      <div class="form-grid three">
        <div class="field">
          <label>Fabricante</label>
          <input type="text" id="l_fab" placeholder="Daikin, Hitachi...">
        </div>
        <div class="field">
          <label>Modelo</label>
          <input type="text" id="l_modelo" placeholder="Split Hi-Wall">
        </div>
        <div class="field">
          <label>Capacidade (BTU/h)</label>
          <select id="l_btu">
            <option value="">Selecione</option>
            <option>7.000 BTU/h</option>
            <option>9.000 BTU/h</option>
            <option>12.000 BTU/h</option>
            <option>18.000 BTU/h</option>
            <option>24.000 BTU/h</option>
            <option>30.000 BTU/h</option>
            <option>36.000 BTU/h</option>
            <option>48.000 BTU/h</option>
            <option>60.000 BTU/h</option>
          </select>
        </div>
        <div class="field">
          <label>N¬∫ de S√©rie (Evaporadora)</label>
          <input type="text" id="l_serie_e" placeholder="SN-EVAP-00000">
        </div>
        <div class="field">
          <label>N¬∫ de S√©rie (Condensadora)</label>
          <input type="text" id="l_serie_c" placeholder="SN-COND-00000">
        </div>
        <div class="field">
          <label>Tens√£o</label>
          <select id="l_tensao">
            <option value="">Selecione</option>
            <option>127V Monof√°sico</option>
            <option>220V Monof√°sico</option>
            <option>220V Trif√°sico</option>
            <option>380V Trif√°sico</option>
          </select>
        </div>
        <div class="field">
          <label>Tipo de Fluido Refrigerante</label>
          <select id="l_fluido">
            <option value="">Selecione</option>
            <option>R-22</option>
            <option>R-410A</option>
            <option>R-32</option>
            <option>R-407C</option>
          </select>
        </div>
        <div class="field">
          <label>Tipo de Instala√ß√£o</label>
          <select id="l_tipo">
            <option value="">Selecione</option>
            <option>Split Hi-Wall</option>
            <option>Split Cassete</option>
            <option>Split Piso-Teto</option>
            <option>Split Duto</option>
            <option>Split Multi</option>
            <option>VRF</option>
            <option>Self-Contained</option>
          </select>
        </div>
        <div class="field">
          <label>Classe de Efici√™ncia</label>
          <select id="l_efic">
            <option value="">Selecione</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Condi√ß√µes da Instala√ß√£o</div>
      <div class="form-grid">
        <div class="field">
          <label>Comprimento da Tubula√ß√£o (m)</label>
          <input type="number" id="l_tubo" placeholder="10">
        </div>
        <div class="field">
          <label>Diferen√ßa de N√≠vel (m)</label>
          <input type="number" id="l_nivel" placeholder="3">
        </div>
        <div class="field">
          <label>Press√£o do Sistema (Verificada)</label>
          <select id="l_pressao">
            <option value="">Selecione</option>
            <option>Conforme especifica√ß√£o</option>
            <option>Baixa ‚Äî necessita carga</option>
            <option>Alta ‚Äî necessita ajuste</option>
          </select>
        </div>
        <div class="field">
          <label>Dreno / Condensado</label>
          <select id="l_dreno">
            <option value="">Selecione</option>
            <option>Adequado com destino correto</option>
            <option>Sem desvio ‚Äî OK</option>
            <option>Com desvio ‚Äî necessita ajuste</option>
            <option>Ausente ‚Äî n√£o instalado</option>
          </select>
        </div>
        <div class="field">
          <label>Isolamento T√©rmico</label>
          <select id="l_iso">
            <option value="">Selecione</option>
            <option>√çntegro e conforme norma</option>
            <option>Parcialmente danificado</option>
            <option>Ausente</option>
          </select>
        </div>
        <div class="field">
          <label>Suporte da Condensadora</label>
          <select id="l_suporte">
            <option value="">Selecione</option>
            <option>Adequado ‚Äî fixa√ß√£o segura</option>
            <option>Irregular ‚Äî necessita refor√ßo</option>
            <option>Ausente</option>
          </select>
        </div>
      </div>
      <div class="form-grid full" style="margin-top: 1rem;">
        <div class="field">
          <label>Observa√ß√µes / N√£o Conformidades</label>
          <textarea id="l_obs" placeholder="Descreva n√£o conformidades, pend√™ncias ou observa√ß√µes relevantes..."></textarea>
        </div>
        <div class="field">
          <label>Conclus√£o / Parecer T√©cnico</label>
          <textarea id="l_conclusao" placeholder="Ex: A instala√ß√£o encontra-se em conformidade com as normas NBR 16411 e NBR 16755..."></textarea>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Registro Fotogr√°fico</div>
      <p style="font-size:0.78rem;color:var(--text2);margin-bottom:1.2rem;">Adicione fotos da instala√ß√£o ‚Äî tire pela c√¢mera ou selecione da galeria. As imagens aparecem no laudo gerado.</p>

      <!-- Upload area -->
      <div id="foto-dropzone" onclick="document.getElementById('foto-input').click()"
        style="border:2px dashed var(--border);border-radius:12px;padding:2rem;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:1.2rem;">
        <div style="font-size:2rem;margin-bottom:0.5rem;">üì∑</div>
        <div style="font-size:0.85rem;color:var(--text2);margin-bottom:0.3rem;">Toque para tirar foto ou escolher da galeria</div>
        <div style="font-size:0.72rem;color:var(--text3);">Aceita JPG, PNG ‚Äî m√∫ltiplas fotos</div>
      </div>
      <input type="file" id="foto-input" accept="image/*" multiple capture="environment"
        style="display:none" onchange="adicionarFotos(this)">

      <!-- Grid de fotos -->
      <div id="fotos-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.8rem;"></div>
    </div>

    <div class="card">
      <div class="card-title">Assinatura Digital</div>
      <p style="font-size:0.78rem;color:var(--text2);margin-bottom:1rem;">Assine com o dedo ou mouse. A assinatura ser√° inclu√≠da no laudo gerado.</p>
      <div class="sig-canvas-wrap">
        <canvas id="sig-canvas" width="800" height="180" style="width:100%;height:140px;"></canvas>
      </div>
      <div class="sig-actions">
        <button class="sig-clear" onclick="limparAssinatura()">üóë Limpar</button>
        <button class="sig-save" onclick="salvarAssinatura()">‚úì Confirmar Assinatura</button>
        <span id="sig-status" style="font-size:0.72rem;color:var(--text2);align-self:center;margin-left:0.3rem;"></span>
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" onclick="gerarLaudo()">‚ö° Gerar Laudo</button>
      <button class="btn-secondary" onclick="limparLaudo()">Limpar</button>
    </div>

    <div class="preview-box" id="laudo-preview">
      <div class="doc-actions-bar"><button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button><button class="wa-btn" onclick="enviarWA('laudo')">üì≤ WhatsApp</button></div>
      <div id="laudo-content"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section" id="section-config">
    <div class="section-header">
      <div class="badge" style="background:rgba(255,107,53,0.1);border-color:rgba(255,107,53,0.3);color:#ff6b35;">CONFIGURA√á√ïES</div>
      <h1>Minha Empresa</h1>
      <p>Dados e logo que aparecem em todos os documentos gerados ‚Äî configure uma vez e pronto</p>
    </div>

    <div class="card">
      <div class="card-title" style="color:#ff6b35;">Logo da Empresa</div>
      <p style="font-size:0.78rem;color:var(--text2);margin-bottom:1.2rem;">A logo aparece no cabe√ßalho de todos os documentos (Laudo, PMOC e Checklist).</p>
      <div style="display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;">
        <div id="logo-preview-wrap" style="display:none;">
          <img id="logo-preview-img" class="config-preview-logo">
        </div>
        <div id="logo-placeholder" style="width:120px;height:60px;border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:0.72rem;">
          Sem logo
        </div>
        <div style="display:flex;flex-direction:column;gap:0.5rem;">
          <button class="btn-secondary" style="font-size:0.78rem;padding:0.5rem 1rem;" onclick="document.getElementById('logo-input').click()">üìÅ Escolher Logo</button>
          <button class="btn-danger" onclick="removerLogo()" id="btn-remove-logo" style="display:none;font-size:0.75rem;padding:0.4rem 0.8rem;">Remover</button>
        </div>
        <input type="file" id="logo-input" accept="image/*" style="display:none" onchange="carregarLogo(this)">
      </div>
      <p style="font-size:0.72rem;color:var(--text3);margin-top:1rem;">Recomendado: PNG com fundo transparente, propor√ß√£o horizontal. Tamanho m√°ximo 2MB.</p>
    </div>

    <div class="card">
      <div class="card-title" style="color:#ff6b35;">Dados da Empresa</div>
      <p style="font-size:0.78rem;color:var(--text2);margin-bottom:1.2rem;">Preencha uma vez ‚Äî aparece automaticamente no rodap√© de todos os documentos.</p>
      <div class="form-grid">
        <div class="field">
          <label>Raz√£o Social / Nome Fantasia</label>
          <input type="text" id="cfg_empresa" placeholder="Climatizar Engenharia Ltda.">
        </div>
        <div class="field">
          <label>CNPJ</label>
          <input type="text" id="cfg_cnpj" placeholder="00.000.000/0001-00">
        </div>
        <div class="field">
          <label>Endere√ßo</label>
          <input type="text" id="cfg_end" placeholder="Rua, n¬∫, Cidade ‚Äî UF">
        </div>
        <div class="field">
          <label>Telefone / WhatsApp</label>
          <input type="text" id="cfg_tel" placeholder="(11) 99999-9999">
        </div>
        <div class="field">
          <label>E-mail</label>
          <input type="text" id="cfg_email" placeholder="contato@empresa.com.br">
        </div>
        <div class="field">
          <label>Site (opcional)</label>
          <input type="text" id="cfg_site" placeholder="www.empresa.com.br">
        </div>
        <div class="field">
          <label>Slogan (opcional)</label>
          <input type="text" id="cfg_slogan" placeholder="Ex: Excel√™ncia em climatiza√ß√£o">
        </div>
        <div class="field">
          <label>Cor principal da marca</label>
          <input type="color" id="cfg_cor" value="#0d3b6e" style="height:42px;padding:4px;">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="color:#ff6b35;">Pr√©via do Cabe√ßalho</div>
      <p style="font-size:0.78rem;color:var(--text2);margin-bottom:1rem;">Assim ficar√° o topo dos seus documentos.</p>
      <div id="header-preview" style="background:white;border-radius:8px;padding:1rem;color:#111;font-family:serif;border:1px solid var(--border);"></div>
      <button class="btn-primary" style="margin-top:1rem;" onclick="salvarConfig()">üíæ Salvar Configura√ß√µes</button>
      <span id="cfg-saved" style="font-size:0.78rem;color:var(--accent);margin-left:1rem;display:none;">‚úì Salvo com sucesso!</span>
    </div>

    <div class="card">
      <div class="card-title" style="color:#ff4444;">üîí Seguran√ßa ‚Äî Alterar Senha</div>
      <p style="font-size:0.78rem;color:var(--text2);margin-bottom:1.2rem;">Troque a senha de acesso ao TechAr sempre que quiser.</p>
      <div class="form-grid">
        <div class="field">
          <label>Senha Atual</label>
          <input type="password" id="seg_atual" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <div class="field">
          <label>Nova Senha</label>
          <input type="password" id="seg_nova" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="4">
        </div>
        <div class="field">
          <label>Confirmar Nova Senha</label>
          <input type="password" id="seg_conf" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
      </div>
      <div style="margin-top:1rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
        <button class="btn-primary" style="background:#ff4444;" onclick="alterarSenha()">üîí Alterar Senha</button>
        <span id="seg-msg" style="font-size:0.78rem;min-height:1.2rem;"></span>
      </div>
      <div style="margin-top:1rem;background:var(--bg3);border-radius:8px;padding:0.8rem;font-size:0.75rem;color:var(--text2);">
        üí° <strong>Dica:</strong> Use uma senha com pelo menos 6 caracteres misturando letras e n√∫meros. Anote em um local seguro ‚Äî sem ela n√£o √© poss√≠vel acessar o app.
      </div>
    </div>
  </div>
  <div class="section" id="section-pmoc">
    <div class="section-header">
      <div class="badge">M√ìDULO 02</div>
      <h1>PMOC ‚Äî Plano de Manuten√ß√£o</h1>
      <p>Programa completo de Manuten√ß√£o, Opera√ß√£o e Controle conforme Lei 13.589/2018 ¬∑ Portaria MS 3.523/1998 ¬∑ ABNT NBR 16401</p>
    </div>

    <!-- 1. EMPRESA EXECUTANTE -->
    <div class="card">
      <div class="card-title">Empresa Executante dos Servi√ßos</div>
      <div class="form-grid">
        <div class="field">
          <label>Raz√£o Social da Empresa</label>
          <input type="text" id="p_empresa" placeholder="Climatizar Engenharia Ltda.">
        </div>
        <div class="field">
          <label>CNPJ da Empresa</label>
          <input type="text" id="p_cnpj_emp" placeholder="00.000.000/0001-00">
        </div>
        <div class="field">
          <label>Endere√ßo da Empresa</label>
          <input type="text" id="p_end_emp" placeholder="Rua, n¬∫, Bairro ‚Äî Cidade/UF">
        </div>
        <div class="field">
          <label>Telefone / E-mail</label>
          <input type="text" id="p_contato_emp" placeholder="(11) 99999-9999 | empresa@email.com">
        </div>
      </div>
    </div>

    <!-- 2. RESPONS√ÅVEL T√âCNICO -->
    <div class="card">
      <div class="card-title">Respons√°vel T√©cnico</div>
      <div class="form-grid three">
        <div class="field">
          <label>Nome do Engenheiro</label>
          <input type="text" id="p_resp" placeholder="Eng. Jo√£o da Silva">
        </div>
        <div class="field">
          <label>CREA</label>
          <input type="text" id="p_crea" placeholder="CREA-SP 000000">
        </div>
        <div class="field">
          <label>ART N¬∫</label>
          <input type="text" id="p_art" placeholder="N¬∫ da ART">
        </div>
        <div class="field">
          <label>Especialidade</label>
          <select id="p_espec">
            <option>Engenheiro Mec√¢nico</option>
            <option>Engenheiro Civil</option>
            <option>T√©cnico em Refrigera√ß√£o</option>
          </select>
        </div>
        <div class="field">
          <label>Telefone do RT</label>
          <input type="text" id="p_tel_resp" placeholder="(11) 99999-9999">
        </div>
        <div class="field">
          <label>E-mail do RT</label>
          <input type="text" id="p_email_resp" placeholder="engenheiro@email.com">
        </div>
      </div>
    </div>

    <!-- 3. DADOS DO CONTRATANTE -->
    <div class="card">
      <div class="card-title">Dados do Contratante / Estabelecimento</div>
      <div class="form-grid">
        <div class="field">
          <label>Raz√£o Social / Nome</label>
          <input type="text" id="p_local" placeholder="Cl√≠nica S√£o Lucas / Escrit√≥rio ABC">
        </div>
        <div class="field">
          <label>CNPJ / CPF</label>
          <input type="text" id="p_cnpj">
        </div>
        <div class="field span2">
          <label>Endere√ßo Completo</label>
          <input type="text" id="p_end" placeholder="Rua, n¬∫, Bairro, Cidade ‚Äî UF, CEP">
        </div>
        <div class="field">
          <label>Tipo de Estabelecimento</label>
          <select id="p_tipo_local">
            <option>Cl√≠nica / Ambulat√≥rio</option>
            <option>Hospital</option>
            <option>Escrit√≥rio Comercial</option>
            <option>Loja / Com√©rcio</option>
            <option>Ind√∫stria</option>
            <option>Resid√™ncia</option>
            <option>Edif√≠cio Corporativo</option>
            <option>Academia / Esporte</option>
            <option>Restaurante / Food Service</option>
          </select>
        </div>
        <div class="field">
          <label>Nome do Respons√°vel no Local</label>
          <input type="text" id="p_resp_local" placeholder="Nome do gestor/respons√°vel">
        </div>
        <div class="field">
          <label>Vig√™ncia do PMOC ‚Äî In√≠cio</label>
          <input type="date" id="p_ini">
        </div>
        <div class="field">
          <label>Vig√™ncia do PMOC ‚Äî Fim</label>
          <input type="date" id="p_fim">
        </div>
      </div>
    </div>

    <!-- 4. EQUIPAMENTOS -->
    <div class="card">
      <div class="card-title">Invent√°rio de Equipamentos</div>
      <div id="equipamentos-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem; font-size:0.8rem; padding:0.6rem 1.2rem;" onclick="addEquipamento()">+ Adicionar Equipamento</button>
    </div>

    <!-- 5. REGISTRO DE EXECU√á√ÉO -->
    <div class="card">
      <div class="card-title">Registros de Execu√ß√£o dos Servi√ßos</div>
      <div id="registros-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem; font-size:0.8rem; padding:0.6rem 1.2rem;" onclick="addRegistro()">+ Adicionar Registro de Servi√ßo</button>
    </div>

    <!-- 6. OBSERVA√á√ïES -->
    <div class="card">
      <div class="card-title">Observa√ß√µes Gerais</div>
      <div class="form-grid full">
        <div class="field">
          <label>Condi√ß√µes Especiais / Recomenda√ß√µes</label>
          <textarea id="p_obs" placeholder="Ex: √Årea de sala cir√∫rgica exige aten√ß√£o especial √† qualidade do ar. Recomenda-se uso de filtros HEPA..."></textarea>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" onclick="gerarPMOC()">‚ö° Gerar PMOC Completo</button>
      <button class="btn-primary" onclick="abrirLivro('pmoc')" style="background:#2e7d32;" onmouseover="this.style.background='#388e3c'" onmouseout="this.style.background='#2e7d32'">üìí Livro de Registro</button>
      <button class="btn-secondary" onclick="limparPMOC()">Limpar</button>
    </div>

    <div class="preview-box" id="pmoc-preview">
      <div class="doc-actions-bar"><button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button><button class="wa-btn" onclick="enviarWA('pmoc')">üì≤ WhatsApp</button></div>
      <div id="pmoc-content"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHECKLIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section" id="section-checklist">
    <div class="section-header">
      <div class="badge">M√ìDULO 03</div>
      <h1>Checklist de Vistoria</h1>
      <p>Avalia√ß√£o sistem√°tica das condi√ß√µes da instala√ß√£o em campo</p>
    </div>

    <div class="card">
      <div class="card-title">Identifica√ß√£o da Vistoria</div>
      <div class="form-grid">
        <div class="field">
          <label>Local / Cliente</label>
          <input type="text" id="c_local" placeholder="Nome do cliente / local">
        </div>
        <div class="field">
          <label>Data da Vistoria</label>
          <input type="date" id="c_data">
        </div>
        <div class="field">
          <label>T√©cnico Respons√°vel</label>
          <input type="text" id="c_tec" placeholder="Nome do t√©cnico/engenheiro">
        </div>
        <div class="field">
          <label>Equipamento Identificado</label>
          <input type="text" id="c_equip" placeholder="Modelo / Localiza√ß√£o">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Itens de Verifica√ß√£o</div>
      <div class="check-summary" id="check-summary">
        <span class="cs-ok">‚úì OK: 0</span>
        <span class="cs-nok">‚úó NOK: 0</span>
        <span class="cs-na">‚Äî N/A: 0</span>
        <span style="color:var(--text3)">‚óã Pendente: 0</span>
      </div>
      <div id="checklist-items"></div>
    </div>

    <div class="card">
      <div class="card-title">Observa√ß√µes Gerais</div>
      <div class="form-grid full">
        <div class="field">
          <label>Pend√™ncias / N√£o Conformidades Encontradas</label>
          <textarea id="c_obs" placeholder="Descreva as pend√™ncias identificadas durante a vistoria..."></textarea>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" onclick="gerarChecklist()">‚ö° Gerar Relat√≥rio</button>
      <button class="btn-secondary" onclick="resetChecklist()">Resetar</button>
    </div>

    <div class="preview-box" id="checklist-preview">
      <div class="doc-actions-bar"><button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button><button class="wa-btn" onclick="enviarWA('checklist')">üì≤ WhatsApp</button></div>
      <div id="checklist-content"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PMOC ODONTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section" id="section-odonto">
    <div class="section-header">
      <div class="badge" style="background:rgba(0,153,255,0.1);border-color:rgba(0,153,255,0.3);color:var(--accent2);">M√ìDULO 04 ‚Äî SA√öDE</div>
      <h1>PMOC ‚Äî Estabelecimento de Sa√∫de</h1>
      <p>Plano espec√≠fico para estabelecimentos de sa√∫de conforme RDC ANVISA n¬∫ 50/2002 ¬∑ Lei 13.589/2018 ¬∑ Portaria MS 3.523/1998 ¬∑ NBR 16401</p>
    </div>

    <!-- EMPRESA EXECUTANTE -->
    <div class="card">
      <div class="card-title" style="color:var(--accent2);">Empresa Executante</div>
      <div class="form-grid">
        <div class="field"><label>Raz√£o Social</label><input type="text" id="od_empresa" placeholder="Climatizar Engenharia Ltda."></div>
        <div class="field"><label>CNPJ</label><input type="text" id="od_cnpj_emp" placeholder="00.000.000/0001-00"></div>
        <div class="field"><label>Endere√ßo</label><input type="text" id="od_end_emp" placeholder="Rua, n¬∫, Cidade/UF"></div>
        <div class="field"><label>Telefone / E-mail</label><input type="text" id="od_contato_emp" placeholder="(11) 99999-9999"></div>
      </div>
    </div>

    <!-- RESPONS√ÅVEL T√âCNICO -->
    <div class="card">
      <div class="card-title" style="color:var(--accent2);">Respons√°vel T√©cnico</div>
      <div class="form-grid three">
        <div class="field"><label>Nome do Engenheiro</label><input type="text" id="od_resp" placeholder="Eng. Jo√£o da Silva"></div>
        <div class="field"><label>CREA</label><input type="text" id="od_crea" placeholder="CREA-SP 000000"></div>
        <div class="field"><label>ART N¬∫</label><input type="text" id="od_art" placeholder="N¬∫ da ART"></div>
        <div class="field"><label>Especialidade</label><select id="od_espec"><option>Engenheiro Mec√¢nico</option><option>Engenheiro Civil</option></select></div>
        <div class="field"><label>Telefone</label><input type="text" id="od_tel_resp" placeholder="(11) 99999-9999"></div>
        <div class="field"><label>E-mail</label><input type="text" id="od_email_resp" placeholder="eng@email.com"></div>
      </div>
    </div>

    <!-- DADOS DO CONSULT√ìRIO -->
    <div class="card">
      <div class="card-title" style="color:var(--accent2);">Dados do Estabelecimento de Sa√∫de</div>
      <div class="form-grid">
        <div class="field"><label>Nome / Raz√£o Social</label><input type="text" id="od_local" placeholder="Cl√≠nica Odonto Sorriso"></div>
        <div class="field"><label>CNPJ / CPF</label><input type="text" id="od_cnpj"></div>
        <div class="field span2"><label>Endere√ßo Completo</label><input type="text" id="od_end" placeholder="Rua, n¬∫, Bairro, Cidade ‚Äî UF, CEP"></div>
        <div class="field"><label>Tipo de Estabelecimento</label>
          <select id="od_tipo">
            <option>Consult√≥rio M√©dico / Odontol√≥gico</option>
            <option>Cl√≠nica M√©dica</option>
            <option>Cl√≠nica M√©dica Escola</option>
            <option>Pronto-Socorro</option>
            <option>Centro Cir√∫rgico</option>
            <option>Laborat√≥rio de An√°lises Cl√≠nicas</option>
          </select>
        </div>
        <div class="field"><label>Alvar√° Sanit√°rio N¬∫</label><input type="text" id="od_alvara" placeholder="N¬∫ do alvar√° vigente"></div>
        <div class="field"><label>Conselho do Respons√°vel Cl√≠nico (CRM/CRO/CRN...)</label><input type="text" id="od_cro" placeholder="CRO-SP 000000"></div>
        <div class="field"><label>Respons√°vel Cl√≠nico</label><input type="text" id="od_resp_clinico" placeholder="Dr(a). Nome Completo"></div>
        <div class="field"><label>N¬∫ de Consult√≥rios / Salas</label><input type="number" id="od_salas" placeholder="3" min="1"></div>
        <div class="field"><label>√Årea Total Climatizada (m¬≤)</label><input type="number" id="od_area" placeholder="120"></div>
        <div class="field"><label>Vig√™ncia ‚Äî In√≠cio</label><input type="date" id="od_ini"></div>
        <div class="field"><label>Vig√™ncia ‚Äî Fim</label><input type="date" id="od_fim"></div>
      </div>
    </div>

    <!-- CLASSIFICA√á√ÉO RDC 50 -->
    <div class="card">
      <div class="card-title" style="color:var(--accent2);">Classifica√ß√£o de Ambientes ‚Äî RDC ANVISA n¬∫ 50/2002</div>
      <div id="rdc50-ambientes-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem;font-size:0.8rem;padding:0.6rem 1.2rem;" onclick="addAmbienteRDC()">+ Adicionar Ambiente</button>
    </div>

    <!-- EQUIPAMENTOS -->
    <div class="card">
      <div class="card-title" style="color:var(--accent2);">Invent√°rio de Equipamentos</div>
      <div id="od-equipamentos-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem;font-size:0.8rem;padding:0.6rem 1.2rem;" onclick="addEquipOdonto()">+ Adicionar Equipamento</button>
    </div>

    <!-- PRODUTOS QU√çMICOS -->
    <div class="card">
      <div class="card-title" style="color:var(--accent2);">Produtos Qu√≠micos Utilizados na Manuten√ß√£o</div>
      <p style="font-size:0.75rem;color:var(--text2);margin-bottom:1rem;">Registre todos os saneantes, desinfetantes e produtos utilizados nos servi√ßos de limpeza e higieniza√ß√£o do sistema de climatiza√ß√£o.</p>
      <div id="produtos-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem;font-size:0.8rem;padding:0.6rem 1.2rem;" onclick="addProduto()">+ Adicionar Produto</button>
    </div>

    <!-- REGISTROS DE EXECU√á√ÉO -->
    <div class="card">
      <div class="card-title" style="color:var(--accent2);">Registros de Execu√ß√£o dos Servi√ßos</div>
      <div id="od-registros-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem;font-size:0.8rem;padding:0.6rem 1.2rem;" onclick="addRegistroOdonto()">+ Adicionar Registro</button>
    </div>

    <!-- OBSERVA√á√ïES -->
    <div class="card">
      <div class="card-title" style="color:var(--accent2);">Observa√ß√µes e Recomenda√ß√µes</div>
      <div class="form-grid full">
        <div class="field"><label>Condi√ß√µes Especiais / Recomenda√ß√µes Sanit√°rias</label>
          <textarea id="od_obs" placeholder="Ex: Ambientes de biosseguran√ßa exigem controle rigoroso de temperatura/umidade conforme RDC 50. Recomenda-se manter press√£o negativa em salas de procedimentos..."></textarea>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" onclick="gerarPMOCSaude()" style="background:var(--accent2);box-shadow:none;" onmouseover="this.style.background='#33bbff'" onmouseout="this.style.background='var(--accent2)'">‚ö° Gerar PMOC Sa√∫de</button>
      <button class="btn-primary" onclick="abrirLivro('saude')" style="background:#2e7d32;" onmouseover="this.style.background='#388e3c'" onmouseout="this.style.background='#2e7d32'">üìí Livro de Registro</button>
      <button class="btn-secondary" onclick="limparPMOCSaude()">Limpar</button>
    </div>

    <div class="preview-box" id="odonto-preview">
      <div class="doc-actions-bar"><button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button><button class="wa-btn" onclick="enviarWA('odonto')">üì≤ WhatsApp</button></div>
      <div id="odonto-content"></div>
    </div>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VISITA T√âCNICA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section" id="section-visita">
    <div class="section-header">
      <div class="badge" style="background:rgba(255,107,53,0.1);border-color:rgba(255,107,53,0.3);color:#ff6b35;">M√ìDULO 05</div>
      <h1>Relat√≥rio de Visita T√©cnica</h1>
      <p>Registro completo da visita com servi√ßos, pe√ßas e assinatura do cliente</p>
    </div>
    <div class="card">
      <div class="card-title">Identifica√ß√£o</div>
      <div class="form-grid">
        <div class="field"><label>N¬∫ do Relat√≥rio</label><input type="text" id="rv_num" placeholder="RVT-001/2025"></div>
        <div class="field"><label>Data da Visita</label><input type="date" id="rv_data"></div>
        <div class="field"><label>T√©cnico Respons√°vel</label><input type="text" id="rv_tec" placeholder="Nome do t√©cnico"></div>
        <div class="field"><label>Hora de Chegada</label><input type="time" id="rv_chegada"></div>
        <div class="field"><label>Hora de Sa√≠da</label><input type="time" id="rv_saida"></div>
        <div class="field"><label>Tipo de Visita</label>
          <select id="rv_tipo">
            <option>Manuten√ß√£o Preventiva</option>
            <option>Manuten√ß√£o Corretiva</option>
            <option>Instala√ß√£o</option>
            <option>Vistoria / Diagn√≥stico</option>
            <option>Garantia</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Dados do Cliente</div>
      <div class="form-grid">
        <div class="field"><label>Cliente / Raz√£o Social</label><input type="text" id="rv_cliente" placeholder="Nome do cliente"></div>
        <div class="field"><label>Contato no Local</label><input type="text" id="rv_contato" placeholder="Nome de quem recebeu"></div>
        <div class="field span2"><label>Endere√ßo</label><input type="text" id="rv_end" placeholder="Rua, n¬∫, Bairro, Cidade"></div>
        <div class="field"><label>Equipamento Atendido</label><input type="text" id="rv_equip" placeholder="Modelo / TAG / Localiza√ß√£o"></div>
        <div class="field"><label>N√∫mero de S√©rie</label><input type="text" id="rv_serie" placeholder="SN-00000"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Servi√ßos Realizados</div>
      <div id="rv-servicos-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem;font-size:0.8rem;padding:0.6rem 1.2rem;" onclick="addServico()">+ Adicionar Servi√ßo</button>
    </div>
    <div class="card">
      <div class="card-title">Pe√ßas e Materiais Trocados</div>
      <div id="rv-pecas-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem;font-size:0.8rem;padding:0.6rem 1.2rem;" onclick="addPeca()">+ Adicionar Pe√ßa / Material</button>
    </div>
    <div class="card">
      <div class="card-title">Fotos da Visita</div>
      <p style="font-size:0.78rem;color:var(--text2);margin-bottom:1rem;">Registre fotos antes e depois do servi√ßo.</p>
      <div id="rv-foto-dropzone" onclick="document.getElementById('rv-foto-input').click()"
        style="border:2px dashed var(--border);border-radius:12px;padding:1.5rem;text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:1rem;">
        <div style="font-size:1.8rem;margin-bottom:0.4rem;">üì∑</div>
        <div style="font-size:0.82rem;color:var(--text2);">Toque para adicionar fotos</div>
      </div>
      <input type="file" id="rv-foto-input" accept="image/*" multiple capture="environment" style="display:none" onchange="adicionarFotosVisita(this)">
      <div id="rv-fotos-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.8rem;"></div>
    </div>
    <div class="card">
      <div class="card-title">Observa√ß√µes e Pr√≥ximas A√ß√µes</div>
      <div class="form-grid full">
        <div class="field"><label>Diagn√≥stico / Observa√ß√µes T√©cnicas</label>
          <textarea id="rv_obs" placeholder="Descreva o diagn√≥stico e observa√ß√µes relevantes..."></textarea></div>
        <div class="field"><label>Pend√™ncias / Recomenda√ß√µes</label>
          <textarea id="rv_pend" placeholder="Ex: Substituir filtro na pr√≥xima visita, verificar g√°s..."></textarea></div>
        <div class="field"><label>Situa√ß√£o Final do Equipamento</label>
          <select id="rv_sit">
            <option>Equipamento em pleno funcionamento</option>
            <option>Funcionando com pend√™ncias ‚Äî retorno agendado</option>
            <option>Parado ‚Äî aguardando pe√ßa</option>
            <option>Parado ‚Äî aguardando aprova√ß√£o de or√ßamento</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Assinatura do Cliente no Local</div>
      <p style="font-size:0.78rem;color:var(--text2);margin-bottom:1rem;">Pe√ßa ao cliente para assinar confirmando os servi√ßos realizados.</p>
      <div class="sig-canvas-wrap">
        <canvas id="rv-sig-canvas" width="800" height="160" style="width:100%;height:120px;"></canvas>
      </div>
      <div class="sig-actions">
        <button class="sig-clear" onclick="limparSigCliente()">üóë Limpar</button>
        <button class="sig-save" onclick="salvarSigCliente()">‚úì Confirmar</button>
        <span id="rv-sig-status" style="font-size:0.72rem;color:var(--text2);align-self:center;margin-left:0.3rem;"></span>
      </div>
    </div>
    <div class="actions">
      <button class="btn-primary" onclick="gerarVisita()" style="background:#ff6b35;" onmouseover="this.style.background='#ff8c5a'" onmouseout="this.style.background='#ff6b35'">‚ö° Gerar Relat√≥rio</button>
      <button class="btn-secondary" onclick="limparVisita()">Limpar</button>
    </div>
    <div class="preview-box" id="visita-preview">
      <div class="doc-actions-bar"><button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button><button class="wa-btn" onclick="enviarWA('visita')">üì≤ WhatsApp</button></div>
      <div id="visita-content"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OR√áAMENTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section" id="section-orcamento">
    <div class="section-header">
      <div class="badge" style="background:rgba(255,215,0,0.1);border-color:rgba(255,215,0,0.3);color:#ffd700;">M√ìDULO 06</div>
      <h1>Gerador de Or√ßamento</h1>
      <p>Crie or√ßamentos profissionais com m√£o de obra, materiais e deslocamento</p>
    </div>
    <div class="card">
      <div class="card-title" style="color:#ffd700;">Identifica√ß√£o do Or√ßamento</div>
      <div class="form-grid">
        <div class="field"><label>N¬∫ do Or√ßamento</label><input type="text" id="orc_num" placeholder="ORC-001/2025"></div>
        <div class="field"><label>Data de Emiss√£o</label><input type="date" id="orc_data"></div>
        <div class="field"><label>Validade do Or√ßamento</label><select id="orc_val"><option>7 dias</option><option>15 dias</option><option>30 dias</option><option>60 dias</option></select></div>
        <div class="field"><label>Tipo de Servi√ßo</label>
          <select id="orc_tipo">
            <option>Manuten√ß√£o Preventiva</option><option>Manuten√ß√£o Corretiva</option>
            <option>Instala√ß√£o de Ar Condicionado</option><option>Desinstala√ß√£o</option>
            <option>Higieniza√ß√£o</option><option>Recarga de Fluido</option><option>PMOC</option><option>Laudo T√©cnico</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title" style="color:#ffd700;">Cliente</div>
      <div class="form-grid">
        <div class="field"><label>Nome / Raz√£o Social</label><input type="text" id="orc_cliente" placeholder="Nome do cliente"></div>
        <div class="field"><label>CNPJ / CPF</label><input type="text" id="orc_cnpj" placeholder="00.000.000/0001-00"></div>
        <div class="field span2"><label>Endere√ßo</label><input type="text" id="orc_end" placeholder="Rua, n¬∫, Bairro, Cidade ‚Äî UF"></div>
        <div class="field"><label>Telefone</label><input type="text" id="orc_tel" placeholder="(11) 99999-9999"></div>
        <div class="field"><label>E-mail</label><input type="text" id="orc_email" placeholder="cliente@email.com"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title" style="color:#ffd700;">Deslocamento / Visita T√©cnica</div>
      <div class="form-grid three">
        <div class="field"><label>Cidade de Destino</label><input type="text" id="orc_dest" placeholder="S√£o Paulo / SP"></div>
        <div class="field"><label>Dist√¢ncia Estimada (km)</label><input type="number" id="orc_km" placeholder="50" oninput="calcOrc()"></div>
        <div class="field"><label>Valor por km (R$)</label><input type="number" id="orc_km_val" placeholder="1.20" step="0.01" oninput="calcOrc()"></div>
        <div class="field"><label>Taxa de Visita T√©cnica (R$)</label><input type="number" id="orc_visita_val" placeholder="150.00" step="0.01" oninput="calcOrc()"></div>
        <div class="field"><label>Ped√°gio / Estacionamento (R$)</label><input type="number" id="orc_pedagio" placeholder="0.00" step="0.01" oninput="calcOrc()"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title" style="color:#ffd700;">M√£o de Obra</div>
      <div id="orc-mdo-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem;font-size:0.8rem;padding:0.6rem 1.2rem;" onclick="addMDO()">+ Adicionar M√£o de Obra</button>
    </div>
    <div class="card">
      <div class="card-title" style="color:#ffd700;">Materiais / Pe√ßas</div>
      <div id="orc-mat-list"></div>
      <button class="btn-secondary" style="margin-top:0.5rem;font-size:0.8rem;padding:0.6rem 1.2rem;" onclick="addMaterial()">+ Adicionar Material</button>
    </div>
    <div class="card">
      <div class="card-title" style="color:#ffd700;">Resumo e Pagamento</div>
      <div id="orc-resumo" style="background:var(--bg3);border-radius:8px;padding:1rem;margin-bottom:1rem;font-family:'DM Mono';font-size:0.82rem;"></div>
      <div class="form-grid">
        <div class="field"><label>Desconto (R$)</label><input type="number" id="orc_desc" placeholder="0.00" step="0.01" oninput="calcOrc()"></div>
        <div class="field"><label>Forma de Pagamento</label>
          <select id="orc_pgto"><option>√Ä vista ‚Äî Dinheiro</option><option>√Ä vista ‚Äî PIX</option><option>√Ä vista ‚Äî Cart√£o de D√©bito</option><option>Cart√£o de Cr√©dito ‚Äî 1x</option><option>Cart√£o de Cr√©dito ‚Äî 2x</option><option>Cart√£o de Cr√©dito ‚Äî 3x</option><option>Boleto ‚Äî 30 dias</option><option>A combinar</option></select>
        </div>
        <div class="field span2"><label>Observa√ß√µes / Condi√ß√µes Comerciais</label>
          <textarea id="orc_obs" placeholder="Ex: Garantia de 90 dias na m√£o de obra. Pe√ßas conforme garantia do fabricante..."></textarea></div>
      </div>
    </div>
    <div class="actions">
      <button class="btn-primary" onclick="gerarOrcamento()" style="background:#ffd700;color:#0d1117;" onmouseover="this.style.background='#ffe44d'" onmouseout="this.style.background='#ffd700'">‚ö° Gerar Or√ßamento</button>
      <button class="btn-secondary" onclick="limparOrcamento()">Limpar</button>
    </div>
    <div class="preview-box" id="orcamento-preview">
      <div class="doc-actions-bar"><button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button><button class="wa-btn" onclick="enviarWA('orcamento')">üì≤ WhatsApp</button></div>
      <div id="orcamento-content"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CARGA T√âRMICA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section" id="section-carga">
    <div class="section-header">
      <div class="badge" style="background:rgba(0,153,255,0.1);border-color:rgba(0,153,255,0.3);color:#00aaff;">M√ìDULO 07</div>
      <h1>C√°lculo de Carga T√©rmica</h1>
      <p>Estimativa simplificada da capacidade necess√°ria de A/C pelo m√©todo ASHRAE simplificado</p>
    </div>
    <div class="card">
      <div class="card-title" style="color:#00aaff;">Dados do Ambiente</div>
      <div class="form-grid three">
        <div class="field"><label>Nome do Ambiente</label><input type="text" id="ct_nome" placeholder="Sala de Reuni√£o"></div>
        <div class="field"><label>Largura (m)</label><input type="number" id="ct_larg" step="0.1" placeholder="5.0" oninput="calcCarga()"></div>
        <div class="field"><label>Comprimento (m)</label><input type="number" id="ct_comp" step="0.1" placeholder="6.0" oninput="calcCarga()"></div>
        <div class="field"><label>P√©-direito (m)</label><input type="number" id="ct_pe" step="0.1" placeholder="2.80" oninput="calcCarga()"></div>
        <div class="field"><label>Tipo de Cobertura</label>
          <select id="ct_cob" onchange="calcCarga()">
            <option value="1.0">Laje superior com outro pavimento</option>
            <option value="1.3">Laje superior com forro</option>
            <option value="1.5">Telhado sem forro</option>
            <option value="1.8">Telhado de zinco / metal</option>
          </select>
        </div>
        <div class="field"><label>Orienta√ß√£o Solar da Parede Principal</label>
          <select id="ct_sol" onchange="calcCarga()">
            <option value="1.0">Norte / Sem insola√ß√£o direta</option>
            <option value="1.1">Leste / Oeste</option>
            <option value="1.2">Sul com grande exposi√ß√£o</option>
            <option value="1.3">Oeste com exposi√ß√£o intensa</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title" style="color:#00aaff;">Cargas Internas</div>
      <div class="form-grid three">
        <div class="field"><label>N¬∫ de Pessoas</label><input type="number" id="ct_pessoas" placeholder="4" min="0" oninput="calcCarga()"></div>
        <div class="field"><label>Pot√™ncia de Equipamentos (W)</label><input type="number" id="ct_equips" placeholder="500" min="0" oninput="calcCarga()"></div>
        <div class="field"><label>Pot√™ncia de Ilumina√ß√£o (W)</label><input type="number" id="ct_luz" placeholder="200" min="0" oninput="calcCarga()"></div>
        <div class="field"><label>√Årea de Janelas (m¬≤)</label><input type="number" id="ct_janelas" step="0.1" placeholder="2.0" min="0" oninput="calcCarga()"></div>
        <div class="field"><label>Tipo de Uso</label>
          <select id="ct_uso" onchange="calcCarga()">
            <option value="1.0">Residencial</option>
            <option value="1.1">Escrit√≥rio / Comercial</option>
            <option value="1.2">Consult√≥rio / Cl√≠nica</option>
            <option value="1.3">Restaurante / Loja</option>
            <option value="1.4">Servidor / TI</option>
          </select>
        </div>
        <div class="field"><label>Clima da Regi√£o</label>
          <select id="ct_clima" onchange="calcCarga()">
            <option value="1.0">Temperado (Sul / Sudeste Serra)</option>
            <option value="1.1">Subtropical (SP, RJ, PR)</option>
            <option value="1.2">Tropical √ömido (MG, GO, MT)</option>
            <option value="1.3">Tropical Quente (BA, PE, RJ litoral)</option>
            <option value="1.4">Equatorial (AM, PA, MA)</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-title" style="color:#00aaff;">Resultado</div>
      <div id="ct-resultado" style="background:var(--bg3);border-radius:10px;padding:1.5rem;"></div>
    </div>
    <div class="card">
      <div class="card-title" style="color:#00aaff;">M√∫ltiplos Ambientes</div>
      <p style="font-size:0.78rem;color:var(--text2);margin-bottom:1rem;">Calcule v√°rios ambientes e some a carga total do projeto.</p>
      <div id="ct-ambientes-salvos" style="margin-bottom:1rem;"></div>
      <button class="btn-secondary" style="font-size:0.8rem;padding:0.6rem 1.2rem;" onclick="salvarAmbiente()">+ Salvar Ambiente Atual</button>
    </div>
    <div class="actions">
      <button class="btn-primary" onclick="gerarRelatorioCarga()" style="background:#00aaff;color:#0d1117;" onmouseover="this.style.background='#33bbff'" onmouseout="this.style.background='#00aaff'">‚ö° Gerar Relat√≥rio</button>
      <button class="btn-secondary" onclick="limparCarga()">Limpar</button>
    </div>
    <div class="preview-box" id="carga-preview">
      <div class="doc-actions-bar"><button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button><button class="wa-btn" onclick="enviarWA('carga')">üì≤ WhatsApp</button></div>
      <div id="carga-content"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HIST√ìRICO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section" id="section-historico">
    <div class="section-header">
      <div class="badge" style="background:rgba(180,120,255,0.1);border-color:rgba(180,120,255,0.3);color:#b478ff;">M√ìDULO 08</div>
      <h1>Hist√≥rico de Clientes e Equipamentos</h1>
      <p>Cadastre clientes, equipamentos e mantenha um hist√≥rico de atendimentos</p>
    </div>
    <div class="card">
      <div class="card-title" style="color:#b478ff;">Cadastrar / Buscar</div>
      <div class="form-grid">
        <div class="field span2"><label>Buscar por nome do cliente ou TAG</label>
          <input type="text" id="hist_busca" placeholder="Digite para filtrar..." oninput="filtrarHistorico()">
        </div>
      </div>
      <div style="display:flex;gap:0.8rem;margin-top:1rem;flex-wrap:wrap;">
        <button class="btn-primary" onclick="abrirModalCliente()" style="background:#b478ff;color:#fff;font-size:0.82rem;">+ Novo Cliente</button>
        <button class="btn-secondary" style="font-size:0.82rem;" onclick="abrirModalEquip()">+ Novo Equipamento</button>
        <button class="btn-secondary" style="font-size:0.82rem;" onclick="abrirModalAtend()">+ Novo Atendimento</button>
      </div>
    </div>
    <div class="card">
      <div class="card-title" style="color:#b478ff;">Clientes Cadastrados</div>
      <div id="hist-clientes-list"></div>
    </div>
    <div class="card">
      <div class="card-title" style="color:#b478ff;">Equipamentos</div>
      <div id="hist-equips-list"></div>
    </div>
    <div class="card">
      <div class="card-title" style="color:#b478ff;">Hist√≥rico de Atendimentos</div>
      <div id="hist-atend-list"></div>
    </div>
    <!-- MODAIS -->
    <div id="modal-cliente" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;align-items:center;justify-content:center;">
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:1.5rem;max-width:480px;width:90%;max-height:90vh;overflow-y:auto;">
        <h3 style="font-family:'DM Serif Display';font-size:1.2rem;margin-bottom:1.2rem;color:#b478ff;">Novo Cliente</h3>
        <div class="form-grid full">
          <div class="field"><label>Nome / Raz√£o Social</label><input type="text" id="hc_nome" placeholder="Nome completo ou empresa"></div>
          <div class="field"><label>CNPJ / CPF</label><input type="text" id="hc_cnpj"></div>
          <div class="field"><label>Endere√ßo</label><input type="text" id="hc_end" placeholder="Rua, n¬∫, Cidade"></div>
          <div class="field"><label>Telefone / WhatsApp</label><input type="text" id="hc_tel"></div>
          <div class="field"><label>E-mail</label><input type="text" id="hc_email"></div>
          <div class="field"><label>Observa√ß√µes</label><textarea id="hc_obs" style="min-height:60px" placeholder="Anota√ß√µes sobre o cliente..."></textarea></div>
        </div>
        <div style="display:flex;gap:0.8rem;margin-top:1rem;">
          <button class="btn-primary" style="background:#b478ff;" onclick="salvarCliente()">Salvar</button>
          <button class="btn-secondary" onclick="fecharModais()">Cancelar</button>
        </div>
      </div>
    </div>
    <div id="modal-equip" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;align-items:center;justify-content:center;">
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:1.5rem;max-width:480px;width:90%;max-height:90vh;overflow-y:auto;">
        <h3 style="font-family:'DM Serif Display';font-size:1.2rem;margin-bottom:1.2rem;color:#b478ff;">Novo Equipamento</h3>
        <div class="form-grid full">
          <div class="field"><label>TAG / Identifica√ß√£o</label><input type="text" id="he_tag" placeholder="AC-01"></div>
          <div class="field"><label>Cliente Vinculado</label><select id="he_cliente"><option value="">Selecione o cliente</option></select></div>
          <div class="field"><label>Fabricante / Modelo</label><input type="text" id="he_modelo" placeholder="Daikin Split 12.000 BTU"></div>
          <div class="field"><label>N¬∫ de S√©rie</label><input type="text" id="he_serie"></div>
          <div class="field"><label>Data de Instala√ß√£o</label><input type="date" id="he_inst"></div>
          <div class="field"><label>Localiza√ß√£o</label><input type="text" id="he_local" placeholder="2¬∫ andar / Sala 01"></div>
        </div>
        <div style="display:flex;gap:0.8rem;margin-top:1rem;">
          <button class="btn-primary" style="background:#b478ff;" onclick="salvarEquipHist()">Salvar</button>
          <button class="btn-secondary" onclick="fecharModais()">Cancelar</button>
        </div>
      </div>
    </div>
    <div id="modal-atend" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;align-items:center;justify-content:center;">
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:1.5rem;max-width:480px;width:90%;max-height:90vh;overflow-y:auto;">
        <h3 style="font-family:'DM Serif Display';font-size:1.2rem;margin-bottom:1.2rem;color:#b478ff;">Novo Atendimento</h3>
        <div class="form-grid full">
          <div class="field"><label>Data</label><input type="date" id="ha_data"></div>
          <div class="field"><label>Cliente</label><select id="ha_cliente"><option value="">Selecione</option></select></div>
          <div class="field"><label>Equipamento (TAG)</label><select id="ha_equip"><option value="">Selecione</option></select></div>
          <div class="field"><label>Tipo de Servi√ßo</label>
            <select id="ha_tipo"><option>Manuten√ß√£o Preventiva</option><option>Manuten√ß√£o Corretiva</option><option>Instala√ß√£o</option><option>Laudo</option><option>PMOC</option><option>Or√ßamento</option></select>
          </div>
          <div class="field"><label>Descri√ß√£o</label><textarea id="ha_desc" style="min-height:60px" placeholder="Resumo do atendimento..."></textarea></div>
          <div class="field"><label>Pr√≥ximo Atendimento</label><input type="date" id="ha_prox"></div>
        </div>
        <div style="display:flex;gap:0.8rem;margin-top:1rem;">
          <button class="btn-primary" style="background:#b478ff;" onclick="salvarAtend()">Salvar</button>
          <button class="btn-secondary" onclick="fecharModais()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RELAT√ìRIOS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="section" id="section-relatorios">
    <div class="section-header">
      <div class="badge" style="background:rgba(255,215,0,0.1);border-color:rgba(255,215,0,0.3);color:#ffd700;">M√ìDULO 09</div>
      <h1>Relat√≥rios Gerenciais</h1>
      <p>Painel com faturamento, atendimentos e agenda dos pr√≥ximos servi√ßos</p>
    </div>

    <!-- FILTRO DE PER√çODO -->
    <div class="card">
      <div class="card-title" style="color:#ffd700;">Per√≠odo de An√°lise</div>
      <div class="form-grid three">
        <div class="field">
          <label>De</label>
          <input type="date" id="rel_de" onchange="atualizarRelatorios()">
        </div>
        <div class="field">
          <label>At√©</label>
          <input type="date" id="rel_ate" onchange="atualizarRelatorios()">
        </div>
        <div class="field">
          <label>Atalho</label>
          <select id="rel_periodo" onchange="aplicarPeriodo()">
            <option value="">Personalizado</option>
            <option value="mes">Este m√™s</option>
            <option value="mes_ant">M√™s anterior</option>
            <option value="trim">√öltimo trimestre</option>
            <option value="ano">Este ano</option>
            <option value="tudo">Todo o per√≠odo</option>
          </select>
        </div>
      </div>
    </div>

    <!-- KPI CARDS -->
    <div id="rel-kpis" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem;margin-bottom:1.5rem;"></div>

    <!-- GR√ÅFICO FATURAMENTO MENSAL -->
    <div class="card">
      <div class="card-title" style="color:#ffd700;">üí∞ Faturamento Mensal</div>
      <p style="font-size:0.75rem;color:var(--text2);margin-bottom:1rem;">Soma dos or√ßamentos registrados por m√™s</p>
      <div style="position:relative;height:220px;">
        <canvas id="chart-fat"></canvas>
      </div>
    </div>

    <!-- GR√ÅFICO ATENDIMENTOS -->
    <div class="card">
      <div class="card-title" style="color:#ffd700;">üîß Atendimentos por M√™s</div>
      <p style="font-size:0.75rem;color:var(--text2);margin-bottom:1rem;">Quantidade de atendimentos registrados no hist√≥rico</p>
      <div style="position:relative;height:200px;">
        <canvas id="chart-atend"></canvas>
      </div>
    </div>

    <!-- GR√ÅFICO TIPOS DE SERVI√áO -->
    <div class="card">
      <div class="card-title" style="color:#ffd700;">üìã Servi√ßos Mais Realizados</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;align-items:center;">
        <div style="position:relative;height:200px;">
          <canvas id="chart-tipos"></canvas>
        </div>
        <div id="chart-tipos-legenda" style="font-size:0.78rem;"></div>
      </div>
    </div>

    <!-- PR√ìXIMOS ATENDIMENTOS -->
    <div class="card">
      <div class="card-title" style="color:#ffd700;">üìÖ Pr√≥ximos Atendimentos Agendados</div>
      <div id="rel-agenda"></div>
    </div>

    <!-- TABELA OR√áAMENTOS -->
    <div class="card">
      <div class="card-title" style="color:#ffd700;">üìÑ Or√ßamentos no Per√≠odo</div>
      <div id="rel-orcamentos-lista"></div>
    </div>

    <div class="actions">
      <button class="btn-primary" onclick="window.print()" style="background:#ffd700;color:#0d1117;">üñ®Ô∏è Imprimir Relat√≥rio</button>
      <button class="btn-secondary" onclick="atualizarRelatorios()">üîÑ Atualizar</button>
    </div>
  </div>

</main>

<script>
// ‚îÄ‚îÄ NAV / DRAWER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleDrawer() {
  const drawer = document.getElementById('nav-drawer');
  const overlay = document.getElementById('nav-overlay');
  const btn = document.getElementById('ham-btn');
  const open = drawer.classList.toggle('open');
  overlay.classList.toggle('open', open);
  btn.classList.toggle('open', open);
}

function closeDrawer() {
  document.getElementById('nav-drawer').classList.remove('open');
  document.getElementById('nav-overlay').classList.remove('open');
  document.getElementById('ham-btn').classList.remove('open');
}

function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('section-' + name).classList.add('active');
  const btn = document.getElementById('nb-' + name);
  if(btn) btn.classList.add('active');
  closeDrawer();
  window.scrollTo({top: 0, behavior: 'smooth'});
  if (name === 'relatorios') setTimeout(atualizarRelatorios, 100);
}

// ‚îÄ‚îÄ DATE DEFAULTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const today = new Date().toISOString().split('T')[0];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LAUDO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî EMPRESA, LOGO, ASSINATURA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let logoDataURL = null;
let assinaturaDataURL = null;

// ‚îÄ‚îÄ LOGO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function carregarLogo(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 2 * 1024 * 1024) { alert('Logo muito grande. Use uma imagem menor que 2MB.'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    logoDataURL = e.target.result;
    document.getElementById('logo-preview-img').src = logoDataURL;
    document.getElementById('logo-preview-wrap').style.display = 'block';
    document.getElementById('logo-placeholder').style.display = 'none';
    document.getElementById('btn-remove-logo').style.display = 'inline-block';
    atualizarPreviaHeader();
    salvarConfigLocal();
  };
  reader.readAsDataURL(file);
}

function removerLogo() {
  logoDataURL = null;
  document.getElementById('logo-preview-wrap').style.display = 'none';
  document.getElementById('logo-placeholder').style.display = 'flex';
  document.getElementById('btn-remove-logo').style.display = 'none';
  document.getElementById('logo-input').value = '';
  atualizarPreviaHeader();
  salvarConfigLocal();
}

// ‚îÄ‚îÄ ASSINATURA DIGITAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sigCanvas, sigCtx, sigDrawing = false, sigHasMark = false;

function initSignature() {
  sigCanvas = document.getElementById('sig-canvas');
  if (!sigCanvas) return;
  sigCtx = sigCanvas.getContext('2d');
  sigCtx.strokeStyle = '#1a1a2e';
  sigCtx.lineWidth = 2.5;
  sigCtx.lineCap = 'round';
  sigCtx.lineJoin = 'round';

  // Draw guide line
  function drawGuide() {
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    sigCtx.save();
    sigCtx.strokeStyle = '#e0e0e0';
    sigCtx.lineWidth = 1;
    sigCtx.setLineDash([4, 4]);
    const y = sigCanvas.height * 0.72;
    sigCtx.beginPath();
    sigCtx.moveTo(20, y); sigCtx.lineTo(sigCanvas.width - 20, y);
    sigCtx.stroke();
    sigCtx.restore();
    sigCtx.strokeStyle = '#1a1a2e';
    sigCtx.lineWidth = 2.5;
  }
  drawGuide();

  function getPos(e) {
    const r = sigCanvas.getBoundingClientRect();
    const scaleX = sigCanvas.width / r.width;
    const scaleY = sigCanvas.height / r.height;
    const src = e.touches ? e.touches[0] : e;
    return { x: (src.clientX - r.left) * scaleX, y: (src.clientY - r.top) * scaleY };
  }

  function start(e) { e.preventDefault(); sigDrawing = true; sigHasMark = true; const p = getPos(e); sigCtx.beginPath(); sigCtx.moveTo(p.x, p.y); }
  function draw(e)  { e.preventDefault(); if (!sigDrawing) return; const p = getPos(e); sigCtx.lineTo(p.x, p.y); sigCtx.stroke(); }
  function end(e)   { e.preventDefault(); sigDrawing = false; }

  sigCanvas.addEventListener('mousedown',  start);
  sigCanvas.addEventListener('mousemove',  draw);
  sigCanvas.addEventListener('mouseup',    end);
  sigCanvas.addEventListener('mouseleave', end);
  sigCanvas.addEventListener('touchstart', start, { passive: false });
  sigCanvas.addEventListener('touchmove',  draw,  { passive: false });
  sigCanvas.addEventListener('touchend',   end,   { passive: false });
}

function limparAssinatura() {
  if (!sigCanvas) return;
  sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
  sigCtx.save();
  sigCtx.strokeStyle = '#e0e0e0'; sigCtx.lineWidth = 1; sigCtx.setLineDash([4,4]);
  const y = sigCanvas.height * 0.72;
  sigCtx.beginPath(); sigCtx.moveTo(20, y); sigCtx.lineTo(sigCanvas.width - 20, y); sigCtx.stroke();
  sigCtx.restore();
  sigCtx.strokeStyle = '#1a1a2e'; sigCtx.lineWidth = 2.5; sigCtx.setLineDash([]);
  sigHasMark = false;
  assinaturaDataURL = null;
  document.getElementById('sig-status').textContent = '';
}

function salvarAssinatura() {
  if (!sigHasMark) { document.getElementById('sig-status').textContent = 'Assine antes de confirmar'; return; }
  assinaturaDataURL = sigCanvas.toDataURL('image/png');
  document.getElementById('sig-status').textContent = '‚úì Assinatura salva!';
  document.getElementById('sig-status').style.color = 'var(--accent)';
}

// ‚îÄ‚îÄ CONFIG EMPRESA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getCfg() {
  return {
    empresa: document.getElementById('cfg_empresa')?.value || '',
    cnpj:    document.getElementById('cfg_cnpj')?.value    || '',
    end:     document.getElementById('cfg_end')?.value     || '',
    tel:     document.getElementById('cfg_tel')?.value     || '',
    email:   document.getElementById('cfg_email')?.value   || '',
    site:    document.getElementById('cfg_site')?.value    || '',
    slogan:  document.getElementById('cfg_slogan')?.value  || '',
    cor:     document.getElementById('cfg_cor')?.value     || '#0d3b6e',
  };
}

function gerarHeaderHTML(cfg, logoURL) {
  const cor = cfg.cor || '#0d3b6e';
  const logoTag = logoURL
    ? `<img src="${logoURL}" style="height:55px;max-width:160px;object-fit:contain;">`
    : `<div style="font-size:1.3rem;font-weight:bold;color:${cor};">${cfg.empresa || 'Sua Empresa'}</div>`;
  return `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:0.8rem 1rem;border-bottom:3px solid ${cor};margin-bottom:1rem;">
      <div>${logoTag}
        ${cfg.slogan ? `<div style="font-size:0.65rem;color:#888;margin-top:2px;">${cfg.slogan}</div>` : ''}
      </div>
      <div style="text-align:right;font-size:0.72rem;color:#555;line-height:1.7;">
        ${cfg.empresa ? `<div style="font-weight:bold;color:#222;">${cfg.empresa}</div>` : ''}
        ${cfg.cnpj   ? `<div>CNPJ: ${cfg.cnpj}</div>` : ''}
        ${cfg.end    ? `<div>${cfg.end}</div>` : ''}
        ${cfg.tel    ? `<div>‚òé ${cfg.tel}</div>` : ''}
        ${cfg.email  ? `<div>‚úâ ${cfg.email}</div>` : ''}
        ${cfg.site   ? `<div>${cfg.site}</div>` : ''}
      </div>
    </div>`;
}

function atualizarPreviaHeader() {
  const prev = document.getElementById('header-preview');
  if (!prev) return;
  prev.innerHTML = gerarHeaderHTML(getCfg(), logoDataURL);
}

function salvarConfig() {
  const cfg = getCfg();
  cfg.logoURL = logoDataURL;
  try { localStorage.setItem('techar_config', JSON.stringify(cfg)); } catch(e) {}
  atualizarPreviaHeader();
  const saved = document.getElementById('cfg-saved');
  saved.style.display = 'inline';
  setTimeout(() => saved.style.display = 'none', 2500);
}

function salvarConfigLocal() {
  try {
    const cfg = getCfg(); cfg.logoURL = logoDataURL;
    localStorage.setItem('techar_config', JSON.stringify(cfg));
  } catch(e) {}
}

function carregarConfigSalva() {
  try {
    const raw = localStorage.getItem('techar_config');
    if (!raw) return;
    const cfg = JSON.parse(raw);
    if (document.getElementById('cfg_empresa')) {
      document.getElementById('cfg_empresa').value = cfg.empresa || '';
      document.getElementById('cfg_cnpj').value    = cfg.cnpj    || '';
      document.getElementById('cfg_end').value     = cfg.end     || '';
      document.getElementById('cfg_tel').value     = cfg.tel     || '';
      document.getElementById('cfg_email').value   = cfg.email   || '';
      document.getElementById('cfg_site').value    = cfg.site    || '';
      document.getElementById('cfg_slogan').value  = cfg.slogan  || '';
      document.getElementById('cfg_cor').value     = cfg.cor     || '#0d3b6e';
    }
    if (cfg.logoURL) {
      logoDataURL = cfg.logoURL;
      document.getElementById('logo-preview-img').src = logoDataURL;
      document.getElementById('logo-preview-wrap').style.display = 'block';
      document.getElementById('logo-placeholder').style.display = 'none';
      document.getElementById('btn-remove-logo').style.display = 'inline-block';
    }
    atualizarPreviaHeader();
  } catch(e) {}
}

// Auto-update preview when config inputs change
document.addEventListener('input', e => {
  if (e.target.id && e.target.id.startsWith('cfg_')) atualizarPreviaHeader();
});

// ‚îÄ‚îÄ FOTOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let fotosData = []; // { id, src, legenda }
let fotoIdCounter = 0;

function adicionarFotos(input) {
  const files = Array.from(input.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const id = ++fotoIdCounter;
      fotosData.push({ id, src: e.target.result, legenda: '' });
      renderFotos();
    };
    reader.readAsDataURL(file);
  });
  input.value = ''; // reset so same file can be added again
}

function renderFotos() {
  const grid = document.getElementById('fotos-grid');
  grid.innerHTML = '';
  fotosData.forEach((foto, idx) => {
    const div = document.createElement('div');
    div.className = 'foto-item';
    div.innerHTML = `
      <span class="foto-num">Foto ${idx + 1}</span>
      <img src="${foto.src}" alt="Foto ${idx+1}">
      <div class="foto-overlay">
        <input class="foto-legenda" type="text" placeholder="Legenda (ex: Evaporadora, Dreno...)"
          value="${foto.legenda}"
          oninput="fotosData[${idx}].legenda = this.value"
          onclick="event.stopPropagation()">
        <button class="foto-remove" onclick="removerFoto(${foto.id});event.stopPropagation()">üóë Remover</button>
      </div>
    `;
    grid.appendChild(div);
  });

  // Update dropzone hint
  const dz = document.getElementById('foto-dropzone');
  if (fotosData.length > 0) {
    dz.style.padding = '1rem';
    dz.querySelector('div:nth-child(2)').textContent = `${fotosData.length} foto(s) adicionada(s) ‚Äî toque para adicionar mais`;
  }
}

function removerFoto(id) {
  fotosData = fotosData.filter(f => f.id !== id);
  renderFotos();
}

function gerarLaudo() {
  const g = id => document.getElementById(id).value || '‚Äî';
  const dataF = d => {
    if(!d || d==='‚Äî') return '‚Äî';
    const [a,m,dia] = d.split('-');
    return `${dia}/${m}/${a}`;
  };

  // Company header
  let cfg = { empresa:'', cnpj:'', end:'', tel:'', email:'', site:'', slogan:'', cor:'#0d3b6e' };
  try { const raw = localStorage.getItem('techar_config'); if(raw) Object.assign(cfg, JSON.parse(raw)); } catch(e){}
  const headerHTML = gerarHeaderHTML(cfg, logoDataURL);

  // Signature
  const sigHTML = assinaturaDataURL
    ? `<img src="${assinaturaDataURL}" style="height:60px;max-width:220px;object-fit:contain;display:block;margin-top:0.5rem;">`
    : '<div style="height:60px;border-bottom:1px solid #333;width:220px;margin-top:0.5rem;"></div>';

  // Photos
  let fotosHTML = '';
  if (fotosData.length > 0) {
    let fotoGrid = '';
    fotosData.forEach((foto, idx) => {
      fotoGrid += `
        <div style="break-inside:avoid;">
          <div style="border:1px solid #ddd;border-radius:6px;overflow:hidden;">
            <img src="${foto.src}" style="width:100%;height:160px;object-fit:cover;display:block;">
            <div style="padding:0.3rem 0.5rem;background:#f9f9f9;font-size:0.72rem;color:#555;text-align:center;">
              <strong>Foto ${idx+1}</strong>${foto.legenda ? ' ‚Äî ' + foto.legenda : ''}
            </div>
          </div>
        </div>`;
    });
    fotosHTML = `
      <div class="preview-section-title">7. Registro Fotogr√°fico</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.6rem;margin-bottom:1rem;">${fotoGrid}</div>`;
  }

  const cor = cfg.cor || '#0d3b6e';

  const html = `
    ${headerHTML}
    <h2 style="color:${cor};">Laudo T√©cnico de Instala√ß√£o de Ar Condicionado</h2>
    <div class="preview-subtitle">Documento t√©cnico emitido por profissional habilitado</div>

    <div class="preview-section-title">1. Identifica√ß√£o do Laudo</div>
    <div class="preview-row"><span>N¬∫ do Laudo:</span><strong>${g('l_numero')}</strong></div>
    <div class="preview-row"><span>Data de Emiss√£o:</span><strong>${dataF(g('l_data'))}</strong></div>
    <div class="preview-row"><span>Engenheiro Respons√°vel:</span><strong>${g('l_eng')}</strong></div>
    <div class="preview-row"><span>CREA:</span><strong>${g('l_crea')}</strong></div>
    <div class="preview-row"><span>ART N¬∫:</span><strong>${g('l_art')}</strong></div>

    <div class="preview-section-title">2. Dados do Cliente</div>
    <div class="preview-row"><span>Cliente / Raz√£o Social:</span><strong>${g('l_cliente')}</strong></div>
    <div class="preview-row"><span>CNPJ / CPF:</span><strong>${g('l_cnpj')}</strong></div>
    <div class="preview-full"><span>Endere√ßo:</span>${g('l_endereco')}</div>

    <div class="preview-section-title">3. Dados do Equipamento</div>
    <div class="preview-row"><span>Fabricante:</span><strong>${g('l_fab')}</strong></div>
    <div class="preview-row"><span>Modelo / Tipo:</span><strong>${g('l_modelo')} ‚Äî ${g('l_tipo')}</strong></div>
    <div class="preview-row"><span>Capacidade:</span><strong>${g('l_btu')}</strong></div>
    <div class="preview-row"><span>Tens√£o:</span><strong>${g('l_tensao')}</strong></div>
    <div class="preview-row"><span>Fluido Refrigerante:</span><strong>${g('l_fluido')}</strong></div>
    <div class="preview-row"><span>Classe de Efici√™ncia:</span><strong>${g('l_efic')}</strong></div>
    <div class="preview-row"><span>N¬∫ de S√©rie (Evaporadora):</span><strong>${g('l_serie_e')}</strong></div>
    <div class="preview-row"><span>N¬∫ de S√©rie (Condensadora):</span><strong>${g('l_serie_c')}</strong></div>

    <div class="preview-section-title">4. Condi√ß√µes da Instala√ß√£o</div>
    <div class="preview-row"><span>Comprimento da Tubula√ß√£o:</span><strong>${g('l_tubo')} m</strong></div>
    <div class="preview-row"><span>Diferen√ßa de N√≠vel:</span><strong>${g('l_nivel')} m</strong></div>
    <div class="preview-row"><span>Press√£o do Sistema:</span><strong>${g('l_pressao')}</strong></div>
    <div class="preview-row"><span>Sistema de Dreno:</span><strong>${g('l_dreno')}</strong></div>
    <div class="preview-row"><span>Isolamento T√©rmico:</span><strong>${g('l_iso')}</strong></div>
    <div class="preview-row"><span>Suporte da Condensadora:</span><strong>${g('l_suporte')}</strong></div>

    <div class="preview-section-title">5. Observa√ß√µes / N√£o Conformidades</div>
    <div class="preview-full">${g('l_obs')}</div>

    <div class="preview-section-title">6. Parecer T√©cnico / Conclus√£o</div>
    <div class="preview-full">${g('l_conclusao')}</div>

    ${fotosHTML}

    <div class="preview-full" style="margin-top:1rem;font-size:0.78rem;color:#777;border-top:1px solid #ddd;padding-top:0.8rem;">
      Laudo emitido conforme NBR 16411:2015, NBR 16755 e demais normas aplic√°veis da ABNT.
    </div>

    <div class="signature-area">
      <div>
        <div class="sig-line">
          ${sigHTML}
          <strong>${g('l_eng')}</strong><br>
          ${g('l_crea')}<br>
          Engenheiro Respons√°vel
        </div>
      </div>
      <div>
        <div class="sig-line">
          <div style="height:60px;border-bottom:1px solid #333;width:220px;margin:0 auto 0.5rem;"></div>
          <strong>${g('l_cliente')}</strong><br>
          ${g('l_cnpj')}<br>
          Contratante / Respons√°vel
        </div>
      </div>
    </div>
  `;

  document.getElementById('laudo-content').innerHTML = html;
  document.getElementById('laudo-preview').classList.add('show');
  document.getElementById('laudo-preview').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function limparLaudo() {
  document.querySelectorAll('#section-laudo input, #section-laudo select, #section-laudo textarea').forEach(e => e.value = '');
  document.getElementById('l_data').value = today;
  fotosData = [];
  fotoIdCounter = 0;
  renderFotos();
  const dz = document.getElementById('foto-dropzone');
  dz.style.padding = '2rem';
  dz.querySelector('div:nth-child(2)').textContent = 'Toque para tirar foto ou escolher da galeria';
  document.getElementById('laudo-preview').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PMOC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let equipNum = 0;
let registroNum = 0;

function addEquipamento() {
  equipNum++;
  const div = document.createElement('div');
  div.className = 'equip-card';
  div.id = 'equip-' + equipNum;
  div.innerHTML = `
    <div class="equip-num">EQUIPAMENTO #${String(equipNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="removerEquip(${equipNum})">‚úï</button>
    <div class="form-grid three">
      <div class="field">
        <label>TAG / Identifica√ß√£o</label>
        <input type="text" class="eq-tag" placeholder="AC-01 / Sala Diretoria">
      </div>
      <div class="field">
        <label>Tipo</label>
        <select class="eq-tipo">
          <option>Split Hi-Wall</option>
          <option>Split Cassete</option>
          <option>Split Piso-Teto</option>
          <option>Split Duto</option>
          <option>VRF ‚Äî Unidade Interna</option>
          <option>VRF ‚Äî Unidade Externa</option>
          <option>Self-Contained</option>
          <option>Fan Coil</option>
          <option>Chiller</option>
          <option>Torre de Resfriamento</option>
        </select>
      </div>
      <div class="field">
        <label>Capacidade (BTU/h)</label>
        <select class="eq-btu">
          <option>7.000 BTU/h</option>
          <option>9.000 BTU/h</option>
          <option>12.000 BTU/h</option>
          <option>18.000 BTU/h</option>
          <option>24.000 BTU/h</option>
          <option>30.000 BTU/h</option>
          <option>36.000 BTU/h</option>
          <option>48.000 BTU/h</option>
          <option>60.000 BTU/h</option>
          <option>Acima de 60.000 BTU/h</option>
        </select>
      </div>
      <div class="field">
        <label>Fabricante</label>
        <input type="text" class="eq-fab" placeholder="Daikin / Hitachi / LG...">
      </div>
      <div class="field">
        <label>Modelo</label>
        <input type="text" class="eq-modelo" placeholder="Modelo do equipamento">
      </div>
      <div class="field">
        <label>N¬∫ de S√©rie</label>
        <input type="text" class="eq-serie" placeholder="SN-00000">
      </div>
      <div class="field">
        <label>Fluido Refrigerante</label>
        <select class="eq-fluido">
          <option>R-410A</option>
          <option>R-32</option>
          <option>R-22</option>
          <option>R-407C</option>
          <option>R-134a</option>
        </select>
      </div>
      <div class="field">
        <label>Ano de Fabrica√ß√£o</label>
        <input type="text" class="eq-ano" placeholder="2023">
      </div>
      <div class="field">
        <label>Localiza√ß√£o no Im√≥vel</label>
        <input type="text" class="eq-local" placeholder="2¬∫ andar / Sala 201">
      </div>
    </div>
  `;
  document.getElementById('equipamentos-list').appendChild(div);
}

function removerEquip(n) {
  const el = document.getElementById('equip-' + n);
  if(el) el.remove();
}

function addRegistro() {
  registroNum++;
  const div = document.createElement('div');
  div.className = 'equip-card';
  div.id = 'registro-' + registroNum;
  div.innerHTML = `
    <div class="equip-num">REGISTRO #${String(registroNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="removerRegistro(${registroNum})">‚úï</button>
    <div class="form-grid">
      <div class="field">
        <label>Data de Execu√ß√£o</label>
        <input type="date" class="reg-data">
      </div>
      <div class="field">
        <label>TAG do Equipamento</label>
        <input type="text" class="reg-tag" placeholder="AC-01">
      </div>
      <div class="field">
        <label>T√©cnico Executante</label>
        <input type="text" class="reg-tec" placeholder="Nome do t√©cnico">
      </div>
      <div class="field">
        <label>Tipo de Servi√ßo</label>
        <select class="reg-tipo">
          <option>Manuten√ß√£o Preventiva</option>
          <option>Manuten√ß√£o Corretiva</option>
          <option>Limpeza e Higieniza√ß√£o</option>
          <option>Recarga de Fluido</option>
          <option>Troca de Filtros</option>
          <option>Verifica√ß√£o El√©trica</option>
          <option>An√°lise Microbiol√≥gica</option>
          <option>Inspe√ß√£o Geral</option>
        </select>
      </div>
      <div class="field span2">
        <label>Servi√ßos Realizados</label>
        <textarea class="reg-servico" style="min-height:60px" placeholder="Descreva os servi√ßos executados..."></textarea>
      </div>
      <div class="field">
        <label>Materiais Utilizados</label>
        <input type="text" class="reg-mat" placeholder="Ex: Filtro G3, fluido R-410A...">
      </div>
      <div class="field">
        <label>Situa√ß√£o ap√≥s Servi√ßo</label>
        <select class="reg-sit">
          <option>Equipamento em pleno funcionamento</option>
          <option>Funcionando com pend√™ncia</option>
          <option>Equipamento parado ‚Äî aguarda pe√ßa</option>
          <option>Servi√ßo em andamento</option>
        </select>
      </div>
    </div>
  `;
  document.getElementById('registros-list').appendChild(div);
}

function removerRegistro(n) {
  const el = document.getElementById('registro-' + n);
  if(el) el.remove();
}

// Atividades PMOC completas com frequ√™ncia mensal (Jan-Dez)
// freq: M=Mensal, T=Trimestral, S=Semestral, A=Anual
const atividadesPMOC = [
  // ‚îÄ‚îÄ FILTROS E AR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { grupo: 'Filtros e Qualidade do Ar', atividade: 'Inspe√ß√£o e limpeza dos filtros de ar prim√°rios (G1/G2)', resp: 'T√©cnico', freq: 'M' },
  { grupo: 'Filtros e Qualidade do Ar', atividade: 'Substitui√ß√£o ou limpeza de filtros finos (G3/G4)', resp: 'T√©cnico', freq: 'T' },
  { grupo: 'Filtros e Qualidade do Ar', atividade: 'Verifica√ß√£o de filtros absolutos HEPA (quando aplic√°vel)', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Filtros e Qualidade do Ar', atividade: 'An√°lise microbiol√≥gica do ar insuflado (ambientes cr√≠ticos)', resp: 'Lab. Credenciado', freq: 'S' },
  { grupo: 'Filtros e Qualidade do Ar', atividade: 'Medi√ß√£o de CO‚ÇÇ e par√¢metros de qualidade do ar interno', resp: 'T√©cnico', freq: 'S' },
  // ‚îÄ‚îÄ UNIDADE EVAPORADORA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { grupo: 'Unidade Evaporadora', atividade: 'Limpeza e desinfec√ß√£o da serpentina evaporadora', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Unidade Evaporadora', atividade: 'Limpeza e desinfec√ß√£o da bandeja de condensado', resp: 'T√©cnico', freq: 'M' },
  { grupo: 'Unidade Evaporadora', atividade: 'Desobstru√ß√£o e desinfec√ß√£o do dreno de condensado', resp: 'T√©cnico', freq: 'M' },
  { grupo: 'Unidade Evaporadora', atividade: 'Verifica√ß√£o do ventilador da evaporadora (rolamentos, correia)', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Unidade Evaporadora', atividade: 'Limpeza do gabinete e painel frontal', resp: 'T√©cnico', freq: 'M' },
  { grupo: 'Unidade Evaporadora', atividade: 'Verifica√ß√£o do controle remoto e sensores de temperatura', resp: 'T√©cnico', freq: 'T' },
  { grupo: 'Unidade Evaporadora', atividade: 'Lubrifica√ß√£o de mancais e rolamentos (quando aplic√°vel)', resp: 'T√©cnico', freq: 'A' },
  // ‚îÄ‚îÄ UNIDADE CONDENSADORA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { grupo: 'Unidade Condensadora', atividade: 'Limpeza da serpentina condensadora', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Unidade Condensadora', atividade: 'Verifica√ß√£o e limpeza do ventilador axial', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Unidade Condensadora', atividade: 'Verifica√ß√£o da fixa√ß√£o e integridade do suporte/base', resp: 'T√©cnico', freq: 'T' },
  { grupo: 'Unidade Condensadora', atividade: 'Verifica√ß√£o do compressor ‚Äî amperagem e ru√≠do', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Unidade Condensadora', atividade: 'Verifica√ß√£o das condi√ß√µes de ventila√ß√£o ao redor do equipamento', resp: 'T√©cnico', freq: 'T' },
  // ‚îÄ‚îÄ SISTEMA DE REFRIGERA√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { grupo: 'Sistema de Refrigera√ß√£o', atividade: 'Verifica√ß√£o de vazamento de fluido refrigerante', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Sistema de Refrigera√ß√£o', atividade: 'Medi√ß√£o de press√£o de suc√ß√£o e descarga', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Sistema de Refrigera√ß√£o', atividade: 'Medi√ß√£o de temperatura de insuflamento e retorno', resp: 'T√©cnico', freq: 'M' },
  { grupo: 'Sistema de Refrigera√ß√£o', atividade: 'Verifica√ß√£o do superaquecimento e sub-resfriamento', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Sistema de Refrigera√ß√£o', atividade: 'Verifica√ß√£o das v√°lvulas de expans√£o (TXV/EEV)', resp: 'T√©cnico', freq: 'A' },
  // ‚îÄ‚îÄ SISTEMA EL√âTRICO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { grupo: 'Sistema El√©trico', atividade: 'Verifica√ß√£o de tens√£o e corrente de opera√ß√£o', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Sistema El√©trico', atividade: 'Inspe√ß√£o de conex√µes e bornes el√©tricos', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Sistema El√©trico', atividade: 'Verifica√ß√£o do aterramento do sistema', resp: 'T√©cnico', freq: 'A' },
  { grupo: 'Sistema El√©trico', atividade: 'Verifica√ß√£o e limpeza do quadro de comando', resp: 'T√©cnico', freq: 'A' },
  { grupo: 'Sistema El√©trico', atividade: 'Verifica√ß√£o de capacitores e prote√ß√µes el√©tricas', resp: 'T√©cnico', freq: 'S' },
  // ‚îÄ‚îÄ TUBULA√á√ÉO E ISOLAMENTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { grupo: 'Tubula√ß√£o e Isolamento', atividade: 'Verifica√ß√£o da integridade do isolamento t√©rmico', resp: 'T√©cnico', freq: 'S' },
  { grupo: 'Tubula√ß√£o e Isolamento', atividade: 'Verifica√ß√£o de fixa√ß√µes e suportes das tubula√ß√µes', resp: 'T√©cnico', freq: 'A' },
  { grupo: 'Tubula√ß√£o e Isolamento', atividade: 'Inspe√ß√£o visual de corros√£o nas tubula√ß√µes', resp: 'T√©cnico', freq: 'S' },
  // ‚îÄ‚îÄ DOCUMENTA√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  { grupo: 'Documenta√ß√£o e Controle', atividade: 'Atualiza√ß√£o e arquivamento do relat√≥rio de manuten√ß√£o', resp: 'RT', freq: 'M' },
  { grupo: 'Documenta√ß√£o e Controle', atividade: 'Emiss√£o de relat√≥rio t√©cnico com resultado das atividades', resp: 'RT', freq: 'S' },
  { grupo: 'Documenta√ß√£o e Controle', atividade: 'Revis√£o e atualiza√ß√£o do PMOC', resp: 'RT', freq: 'A' },
  { grupo: 'Documenta√ß√£o e Controle', atividade: 'Treinamento e orienta√ß√£o da equipe de opera√ß√£o', resp: 'RT', freq: 'A' },
];

const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

function gerarCronograma(atividade) {
  const { freq } = atividade;
  return meses.map((m, i) => {
    let marca = '';
    if (freq === 'M') marca = '‚óè';
    else if (freq === 'T' && [0,3,6,9].includes(i)) marca = '‚óè';
    else if (freq === 'S' && [0,6].includes(i)) marca = '‚óè';
    else if (freq === 'A' && i === 0) marca = '‚óè';
    const color = marca ? (freq==='M'?'#1565c0':freq==='T'?'#2e7d32':freq==='S'?'#e65100':'#6a1b9a') : '';
    return `<td style="text-align:center;font-size:0.75rem;color:${color};padding:3px 1px;">${marca}</td>`;
  }).join('');
}

function gerarPMOC() {
  const g = id => document.getElementById(id)?.value || '‚Äî';
  const dataF = d => {
    if(!d||d==='‚Äî') return '‚Äî';
    const [a,m,dia] = d.split('-');
    return `${dia}/${m}/${a}`;
  };

  // Equipamentos
  const equipCards = document.querySelectorAll('.equip-card[id^="equip-"]');
  let equipRows = '';
  equipCards.forEach((card, i) => {
    const tag = card.querySelector('.eq-tag').value || `Equip. ${i+1}`;
    const tipo = card.querySelector('.eq-tipo').value;
    const btu = card.querySelector('.eq-btu').value;
    const fab = card.querySelector('.eq-fab').value || '‚Äî';
    const modelo = card.querySelector('.eq-modelo').value || '‚Äî';
    const serie = card.querySelector('.eq-serie').value || '‚Äî';
    const fluido = card.querySelector('.eq-fluido').value;
    const ano = card.querySelector('.eq-ano').value || '‚Äî';
    const local = card.querySelector('.eq-local').value || '‚Äî';
    equipRows += `<tr>
      <td style="text-align:center;font-weight:bold;">${tag}</td>
      <td>${tipo}</td>
      <td>${btu}</td>
      <td>${fab} ${modelo}</td>
      <td>${fluido}</td>
      <td>${ano}</td>
      <td style="font-family:monospace;font-size:0.75rem;">${serie}</td>
      <td>${local}</td>
    </tr>`;
  });

  // Registros
  const regCards = document.querySelectorAll('.equip-card[id^="registro-"]');
  let regRows = '';
  let hasRegistros = regCards.length > 0;
  regCards.forEach((card, i) => {
    const data = dataF(card.querySelector('.reg-data').value);
    const tag = card.querySelector('.reg-tag').value || '‚Äî';
    const tec = card.querySelector('.reg-tec').value || '‚Äî';
    const tipo = card.querySelector('.reg-tipo').value;
    const servico = card.querySelector('.reg-servico').value || '‚Äî';
    const mat = card.querySelector('.reg-mat').value || '‚Äî';
    const sit = card.querySelector('.reg-sit').value;
    const sitColor = sit.includes('pleno')?'#2e7d32':sit.includes('pend√™ncia')?'#e65100':'#c62828';
    regRows += `<tr>
      <td style="text-align:center;">${data}</td>
      <td style="text-align:center;font-weight:bold;">${tag}</td>
      <td>${tipo}</td>
      <td>${servico}</td>
      <td>${mat}</td>
      <td>${tec}</td>
      <td style="color:${sitColor};font-size:0.72rem;">${sit}</td>
    </tr>`;
  });

  // Agrupar atividades por grupo
  const grupos = {};
  atividadesPMOC.forEach(a => {
    if(!grupos[a.grupo]) grupos[a.grupo] = [];
    grupos[a.grupo].push(a);
  });

  let atividadesHTML = '';
  Object.entries(grupos).forEach(([grupo, atividades]) => {
    atividadesHTML += `
      <tr style="background:#e8eaf6;">
        <td colspan="${4 + meses.length}" style="padding:5px 8px;font-weight:bold;font-size:0.78rem;letter-spacing:0.5px;color:#1a237e;">${grupo.toUpperCase()}</td>
      </tr>`;
    atividades.forEach((a, i) => {
      const freqLabel = a.freq==='M'?'Mensal':a.freq==='T'?'Trimestral':a.freq==='S'?'Semestral':'Anual';
      const freqColor = a.freq==='M'?'#1565c0':a.freq==='T'?'#2e7d32':a.freq==='S'?'#e65100':'#6a1b9a';
      atividadesHTML += `<tr style="background:${i%2===0?'#fff':'#fafafa'}">
        <td style="padding:4px 8px;font-size:0.76rem;">${a.atividade}</td>
        <td style="text-align:center;font-size:0.7rem;color:${freqColor};font-weight:bold;">${freqLabel}</td>
        <td style="text-align:center;font-size:0.7rem;">${a.resp}</td>
        ${gerarCronograma(a)}
      </tr>`;
    });
  });

  const html = `
    <div style="font-family:'Times New Roman',serif;color:#111;">

      <!-- CABE√áALHO -->
      <div style="border:2px solid #1a237e;padding:1rem;margin-bottom:1.5rem;">
        <h2 style="text-align:center;font-size:1.2rem;color:#1a237e;margin-bottom:0.2rem;text-transform:uppercase;letter-spacing:1px;">
          Plano de Manuten√ß√£o, Opera√ß√£o e Controle
        </h2>
        <div style="text-align:center;font-size:0.8rem;color:#555;margin-bottom:0.8rem;">
          PMOC ‚Äî Lei n¬∫ 13.589/2018 ¬∑ Portaria MS n¬∫ 3.523/1998 ¬∑ ABNT NBR 16401
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.82rem;border-top:1px solid #ddd;padding-top:0.8rem;">
          <div><strong>Estabelecimento:</strong> ${g('p_local')}</div>
          <div><strong>CNPJ:</strong> ${g('p_cnpj')}</div>
          <div><strong>Endere√ßo:</strong> ${g('p_end')}</div>
          <div><strong>Tipo:</strong> ${g('p_tipo_local')}</div>
          <div><strong>Respons√°vel no local:</strong> ${g('p_resp_local')}</div>
          <div><strong>Vig√™ncia:</strong> ${dataF(g('p_ini'))} a ${dataF(g('p_fim'))}</div>
        </div>
      </div>

      <!-- EMPRESA E RT -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem;">
        <div style="border:1px solid #ddd;padding:0.8rem;border-radius:4px;">
          <div style="font-weight:bold;font-size:0.78rem;background:#f5f5f5;padding:0.3rem 0.5rem;margin:-0.8rem -0.8rem 0.6rem;letter-spacing:0.5px;">EMPRESA EXECUTANTE</div>
          <div style="font-size:0.8rem;line-height:1.8;">
            <div><strong>${g('p_empresa')}</strong></div>
            <div>CNPJ: ${g('p_cnpj_emp')}</div>
            <div>${g('p_end_emp')}</div>
            <div>${g('p_contato_emp')}</div>
          </div>
        </div>
        <div style="border:1px solid #ddd;padding:0.8rem;border-radius:4px;">
          <div style="font-weight:bold;font-size:0.78rem;background:#f5f5f5;padding:0.3rem 0.5rem;margin:-0.8rem -0.8rem 0.6rem;letter-spacing:0.5px;">RESPONS√ÅVEL T√âCNICO</div>
          <div style="font-size:0.8rem;line-height:1.8;">
            <div><strong>${g('p_resp')}</strong></div>
            <div>${g('p_espec')} ¬∑ ${g('p_crea')}</div>
            <div>ART: ${g('p_art')}</div>
            <div>${g('p_tel_resp')} ¬∑ ${g('p_email_resp')}</div>
          </div>
        </div>
      </div>

      <!-- INVENT√ÅRIO -->
      <div style="margin-bottom:1.5rem;">
        <div style="background:#1a237e;color:white;padding:0.4rem 0.8rem;font-weight:bold;font-size:0.82rem;letter-spacing:0.5px;">
          1. INVENT√ÅRIO DE EQUIPAMENTOS
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:0.76rem;">
          <thead>
            <tr style="background:#e8eaf6;color:#1a237e;">
              <th style="padding:5px 6px;text-align:left;">TAG</th>
              <th style="padding:5px 6px;text-align:left;">Tipo</th>
              <th style="padding:5px 6px;text-align:left;">Capacidade</th>
              <th style="padding:5px 6px;text-align:left;">Fabricante / Modelo</th>
              <th style="padding:5px 6px;text-align:left;">Fluido</th>
              <th style="padding:5px 6px;text-align:left;">Ano</th>
              <th style="padding:5px 6px;text-align:left;">N¬∫ de S√©rie</th>
              <th style="padding:5px 6px;text-align:left;">Localiza√ß√£o</th>
            </tr>
          </thead>
          <tbody>
            ${equipRows || '<tr><td colspan="8" style="padding:1rem;text-align:center;color:#999;">Nenhum equipamento cadastrado</td></tr>'}
          </tbody>
        </table>
      </div>

      <!-- CRONOGRAMA DE ATIVIDADES -->
      <div style="margin-bottom:1.5rem;">
        <div style="background:#1a237e;color:white;padding:0.4rem 0.8rem;font-weight:bold;font-size:0.82rem;letter-spacing:0.5px;">
          2. CRONOGRAMA DE MANUTEN√á√ÉO PREVENTIVA
        </div>
        <div style="font-size:0.7rem;color:#555;padding:0.3rem 0.5rem;background:#f9f9f9;border:1px solid #ddd;border-top:none;margin-bottom:2px;">
          Legenda de frequ√™ncia:
          <span style="color:#1565c0;font-weight:bold;">‚óè Mensal</span> &nbsp;
          <span style="color:#2e7d32;font-weight:bold;">‚óè Trimestral</span> &nbsp;
          <span style="color:#e65100;font-weight:bold;">‚óè Semestral</span> &nbsp;
          <span style="color:#6a1b9a;font-weight:bold;">‚óè Anual</span>
        </div>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:0.72rem;min-width:750px;">
            <thead>
              <tr style="background:#e8eaf6;color:#1a237e;">
                <th style="padding:5px 8px;text-align:left;min-width:240px;">Atividade</th>
                <th style="padding:5px 4px;text-align:center;min-width:70px;">Frequ√™ncia</th>
                <th style="padding:5px 4px;text-align:center;min-width:60px;">Respons√°vel</th>
                ${meses.map(m=>`<th style="padding:5px 2px;text-align:center;min-width:24px;">${m}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${atividadesHTML}
            </tbody>
          </table>
        </div>
      </div>

      <!-- REGISTROS DE EXECU√á√ÉO -->
      ${hasRegistros ? `
      <div style="margin-bottom:1.5rem;">
        <div style="background:#1a237e;color:white;padding:0.4rem 0.8rem;font-weight:bold;font-size:0.82rem;letter-spacing:0.5px;">
          3. REGISTRO DE EXECU√á√ÉO DOS SERVI√áOS
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:0.76rem;">
          <thead>
            <tr style="background:#e8eaf6;color:#1a237e;">
              <th style="padding:5px 6px;">Data</th>
              <th style="padding:5px 6px;">TAG</th>
              <th style="padding:5px 6px;">Tipo de Servi√ßo</th>
              <th style="padding:5px 6px;">Servi√ßos Realizados</th>
              <th style="padding:5px 6px;">Materiais</th>
              <th style="padding:5px 6px;">T√©cnico</th>
              <th style="padding:5px 6px;">Situa√ß√£o</th>
            </tr>
          </thead>
          <tbody>${regRows}</tbody>
        </table>
      </div>` : ''}

      <!-- OBSERVA√á√ïES -->
      ${g('p_obs') !== '‚Äî' ? `
      <div style="margin-bottom:1.5rem;">
        <div style="background:#1a237e;color:white;padding:0.4rem 0.8rem;font-weight:bold;font-size:0.82rem;letter-spacing:0.5px;">
          ${hasRegistros?'4':'3'}. OBSERVA√á√ïES E RECOMENDA√á√ïES
        </div>
        <div style="padding:0.8rem;border:1px solid #ddd;border-top:none;font-size:0.82rem;line-height:1.7;">${g('p_obs')}</div>
      </div>` : ''}

      <!-- DECLARA√á√ÉO LEGAL -->
      <div style="background:#f9f9f9;border:1px solid #ddd;padding:0.8rem;font-size:0.75rem;color:#555;line-height:1.6;margin-bottom:1.5rem;">
        <strong>Base Legal e Normativa:</strong> Este PMOC foi elaborado em conformidade com a <strong>Lei n¬∫ 13.589/2018</strong> (manuten√ß√£o de sistemas de climatiza√ß√£o), 
        <strong>Portaria MS n¬∫ 3.523/1998</strong> (qualidade do ar em ambientes climatizados), <strong>ABNT NBR 16401</strong> (instala√ß√µes de ar condicionado) 
        e demais normas t√©cnicas aplic√°veis. O n√£o cumprimento das atividades previstas neste plano pode resultar em degrada√ß√£o da qualidade do ar, 
        perda de efici√™ncia energ√©tica e riscos √† sa√∫de dos ocupantes.
      </div>

      <!-- ASSINATURAS -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;text-align:center;font-size:0.82rem;margin-top:1rem;">
        <div>
          <div style="border-top:1px solid #333;padding-top:0.5rem;margin-top:2.5rem;">
            <strong>${g('p_resp')}</strong><br>
            ${g('p_espec')} ¬∑ ${g('p_crea')}<br>
            ART: ${g('p_art')}<br>
            Respons√°vel T√©cnico
          </div>
        </div>
        <div>
          <div style="border-top:1px solid #333;padding-top:0.5rem;margin-top:2.5rem;">
            <strong>${g('p_resp_local')}</strong><br>
            ${g('p_local')}<br>
            CNPJ: ${g('p_cnpj')}<br>
            Respons√°vel pelo Estabelecimento
          </div>
        </div>
      </div>

    </div>
  `;

  document.getElementById('pmoc-content').innerHTML = html;
  document.getElementById('pmoc-preview').classList.add('show');
  document.getElementById('pmoc-preview').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function limparPMOC() {
  document.querySelectorAll('#section-pmoc input, #section-pmoc select, #section-pmoc textarea').forEach(e => e.value = '');
  document.getElementById('equipamentos-list').innerHTML = '';
  document.getElementById('registros-list').innerHTML = '';
  equipNum = 0;
  registroNum = 0;
  document.getElementById('pmoc-preview').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHECKLIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const checklistData = [
  { grupo: 'Unidade Evaporadora', itens: [
    'Fixa√ß√£o e nivelamento da unidade evaporadora',
    'Estado do painel frontal e gabinete',
    'Filtros de ar ‚Äî limpeza e integridade',
    'Serpentina evaporadora ‚Äî limpeza e estado',
    'Bandeja de drenagem ‚Äî limpeza e inclina√ß√£o',
    'Tubula√ß√£o de drenagem ‚Äî desobstru√≠da e com destino adequado',
    'Opera√ß√£o do ventilador e n√≠vel de ru√≠do',
    'Controle remoto ‚Äî funcionamento',
  ]},
  { grupo: 'Unidade Condensadora', itens: [
    'Estrutura de fixa√ß√£o e suporte adequados',
    'Serpentina condensadora ‚Äî limpeza e estado',
    'Ventilador axial ‚Äî funcionamento e ru√≠do',
    '√Årea de instala√ß√£o ‚Äî ventila√ß√£o adequada',
    'Prote√ß√£o contra intemp√©ries',
  ]},
  { grupo: 'Tubula√ß√£o e Isolamento', itens: [
    'Isolamento t√©rmico das linhas de refrigera√ß√£o ‚Äî √≠ntegro',
    'Fixa√ß√£o e encaminhamento das tubula√ß√µes',
    'Aus√™ncia de dobras ou amassamentos na tubula√ß√£o',
    'Passagens de parede vedadas corretamente',
  ]},
  { grupo: 'Sistema El√©trico', itens: [
    'Dimensionamento adequado do circuito el√©trico',
    'Disjuntor exclusivo ‚Äî instalado e funcionando',
    'Aterramento ‚Äî presente e adequado',
    'Cabeamento em eletroduto ou canaleta',
    'Conex√µes el√©tricas firmes e sem oxida√ß√£o',
  ]},
  { grupo: 'Sistema de Refrigera√ß√£o', itens: [
    'Aus√™ncia de vazamento de fluido refrigerante',
    'Press√£o de suc√ß√£o dentro dos par√¢metros',
    'Press√£o de descarga dentro dos par√¢metros',
    'Fluido refrigerante identificado na plaqueta',
  ]},
  { grupo: 'Documenta√ß√£o', itens: [
    'Manual do fabricante dispon√≠vel no local',
    'ART registrada e dispon√≠vel',
    'PMOC existente e atualizado (quando aplic√°vel)',
    'Plaqueta de identifica√ß√£o leg√≠vel no equipamento',
  ]},
];

let checkState = {};

function buildChecklist() {
  const container = document.getElementById('checklist-items');
  container.innerHTML = '';
  checklistData.forEach((grupo, gi) => {
    const div = document.createElement('div');
    div.className = 'check-group';
    div.innerHTML = `<div class="check-group-title">${grupo.grupo}</div>`;
    grupo.itens.forEach((item, ii) => {
      const key = `${gi}-${ii}`;
      if(!checkState[key]) checkState[key] = 'pending';
      const el = document.createElement('div');
      el.className = 'check-item';
      el.id = 'check-' + key;
      el.innerHTML = `
        <span class="check-label">${item}</span>
        <div class="check-status">
          <button class="status-btn ok-btn" onclick="setStatus('${key}','ok')">‚úì OK</button>
          <button class="status-btn nok-btn" onclick="setStatus('${key}','nok')">‚úó NOK</button>
          <button class="status-btn na-btn" onclick="setStatus('${key}','na')">N/A</button>
        </div>
      `;
      div.appendChild(el);
    });
    container.appendChild(div);
  });
  updateSummary();
}

function setStatus(key, status) {
  checkState[key] = status;
  const el = document.getElementById('check-' + key);
  el.className = 'check-item ' + status;
  el.querySelectorAll('.status-btn').forEach(b => b.classList.remove('selected'));
  el.querySelector('.' + status + '-btn').classList.add('selected');
  updateSummary();
}

function updateSummary() {
  let ok = 0, nok = 0, na = 0, pending = 0;
  Object.values(checkState).forEach(v => {
    if(v==='ok') ok++;
    else if(v==='nok') nok++;
    else if(v==='na') na++;
    else pending++;
  });
  document.getElementById('check-summary').innerHTML = `
    <span class="cs-ok">‚úì OK: ${ok}</span>
    <span class="cs-nok">‚úó NOK: ${nok}</span>
    <span class="cs-na">‚Äî N/A: ${na}</span>
    <span style="color:var(--text3)">‚óã Pendente: ${pending}</span>
  `;
}

function resetChecklist() {
  checkState = {};
  buildChecklist();
  document.getElementById('checklist-preview').classList.remove('show');
  document.getElementById('c_obs').value = '';
}

function gerarChecklist() {
  const g = id => document.getElementById(id).value || '‚Äî';
  const dataF = d => {
    if(!d||d==='‚Äî') return '‚Äî';
    const [a,m,dia] = d.split('-');
    return `${dia}/${m}/${a}`;
  };

  let ok=0, nok=0, na=0, pending=0;
  Object.values(checkState).forEach(v => {
    if(v==='ok') ok++;
    else if(v==='nok') nok++;
    else if(v==='na') na++;
    else pending++;
  });
  const total = ok + nok + na + pending;
  const perc = total > 0 ? Math.round((ok + na) / (ok + nok + na) * 100) : 0;

  let gruposHTML = '';
  checklistData.forEach((grupo, gi) => {
    gruposHTML += `<div style="margin-bottom:0.8rem;">
      <div style="background:#f5f5f5;padding:0.3rem 0.6rem;font-weight:bold;font-size:0.8rem;border-left:3px solid #333;">${grupo.grupo}</div>
      <table style="width:100%;border-collapse:collapse;font-size:0.78rem;">`;
    grupo.itens.forEach((item, ii) => {
      const key = `${gi}-${ii}`;
      const st = checkState[key] || 'pending';
      const stLabel = st==='ok'?'‚úì OK':st==='nok'?'‚úó NOK':st==='na'?'N/A':'‚Äî';
      const stColor = st==='ok'?'#2e7d32':st==='nok'?'#c62828':st==='na'?'#666':'#999';
      gruposHTML += `<tr style="border-bottom:1px solid #eee;">
        <td style="padding:0.3rem 0.6rem;">${item}</td>
        <td style="padding:0.3rem 0.6rem;text-align:center;color:${stColor};font-weight:bold;font-family:monospace;width:60px;">${stLabel}</td>
      </tr>`;
    });
    gruposHTML += '</table></div>';
  });

  const html = `
    <h2>Relat√≥rio de Checklist de Vistoria</h2>
    <div class="preview-subtitle">Avalia√ß√£o t√©cnica de instala√ß√£o de ar condicionado</div>

    <div class="preview-section-title">Identifica√ß√£o</div>
    <div class="preview-row"><span>Local / Cliente:</span><strong>${g('c_local')}</strong></div>
    <div class="preview-row"><span>Data da Vistoria:</span><strong>${dataF(g('c_data'))}</strong></div>
    <div class="preview-row"><span>T√©cnico Respons√°vel:</span><strong>${g('c_tec')}</strong></div>
    <div class="preview-row"><span>Equipamento:</span><strong>${g('c_equip')}</strong></div>

    <div class="preview-section-title">Resumo</div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;margin-bottom:1rem;">
      <div style="background:#e8f5e9;border-radius:6px;padding:0.6rem;text-align:center;">
        <div style="font-size:1.4rem;font-weight:bold;color:#2e7d32;">${ok}</div>
        <div style="font-size:0.7rem;color:#2e7d32;">CONFORME</div>
      </div>
      <div style="background:#ffebee;border-radius:6px;padding:0.6rem;text-align:center;">
        <div style="font-size:1.4rem;font-weight:bold;color:#c62828;">${nok}</div>
        <div style="font-size:0.7rem;color:#c62828;">N√ÉO CONFORME</div>
      </div>
      <div style="background:#f5f5f5;border-radius:6px;padding:0.6rem;text-align:center;">
        <div style="font-size:1.4rem;font-weight:bold;color:#666;">${na}</div>
        <div style="font-size:0.7rem;color:#666;">N√ÉO APLIC√ÅVEL</div>
      </div>
      <div style="background:#e3f2fd;border-radius:6px;padding:0.6rem;text-align:center;">
        <div style="font-size:1.4rem;font-weight:bold;color:#1565c0;">${perc}%</div>
        <div style="font-size:0.7rem;color:#1565c0;">CONFORMIDADE</div>
      </div>
    </div>

    <div class="preview-section-title">Itens Verificados</div>
    ${gruposHTML}

    <div class="preview-section-title">Observa√ß√µes / Pend√™ncias</div>
    <div class="preview-full">${g('c_obs')}</div>

    <div class="signature-area">
      <div>
        <div class="sig-line">
          <strong>${g('c_tec')}</strong><br>
          T√©cnico / Engenheiro Respons√°vel<br>
          Data: ${dataF(g('c_data'))}
        </div>
      </div>
      <div>
        <div class="sig-line">
          <strong>${g('c_local')}</strong><br>
          Respons√°vel pelo Local<br>
          Data: ___/___/______
        </div>
      </div>
    </div>
  `;

  document.getElementById('checklist-content').innerHTML = html;
  document.getElementById('checklist-preview').classList.add('show');
  document.getElementById('checklist-preview').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PMOC ODONTOL√ìGICO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ambienteNum = 0, produtoNum = 0, odEquipNum = 0, odRegNum = 0;

// Classifica√ß√£o de ambientes conforme RDC 50/2002 para odontologia
const tiposAmbienteRDC = [
  { tipo: 'Consult√≥rio Odontol√≥gico (Sala de Atendimento)', grupo: 'Aten√ß√£o ao Paciente', classe: 'Grupo 2', utr: 'N√£o requer UTR dedicada', pressao: 'Positiva ou Neutra', temp: '23¬∞C ¬± 2¬∞C', umi: '50‚Äì60% UR' },
  { tipo: 'Sala de Raios-X Odontol√≥gico', grupo: 'Diagn√≥stico', classe: 'Grupo 2', utr: 'N√£o requer UTR dedicada', pressao: 'Neutra', temp: '21‚Äì24¬∞C', umi: '45‚Äì60% UR' },
  { tipo: 'Sala de Esteriliza√ß√£o / CME', grupo: 'Apoio T√©cnico', classe: 'Grupo 3', utr: 'Requer controle rigoroso', pressao: 'Positiva', temp: '18‚Äì22¬∞C', umi: '45‚Äì55% UR' },
  { tipo: 'Sala Cir√∫rgica Odontol√≥gica', grupo: 'Centro Cir√∫rgico', classe: 'Grupo 1', utr: 'UTR exclusiva obrigat√≥ria', pressao: 'Press√£o Positiva', temp: '19‚Äì24¬∞C', umi: '45‚Äì60% UR' },
  { tipo: 'Recep√ß√£o / Sala de Espera', grupo: 'Apoio ao Paciente', classe: 'Grupo 4', utr: 'Sem requisito especial', pressao: 'Neutra', temp: '23¬∞C ¬± 2¬∞C', umi: 'Sem restri√ß√£o' },
  { tipo: 'Sala de Revela√ß√£o de Radiografias', grupo: 'Diagn√≥stico', classe: 'Grupo 2', utr: 'N√£o requer UTR dedicada', pressao: 'Neutra', temp: '21‚Äì24¬∞C', umi: '45‚Äì60% UR' },
  { tipo: 'Laborat√≥rio de Pr√≥tese', grupo: 'Apoio T√©cnico', classe: 'Grupo 3', utr: 'Exaust√£o localizada', pressao: 'Negativa', temp: '21‚Äì24¬∞C', umi: '45‚Äì60% UR' },
  { tipo: 'Sala de Recupera√ß√£o P√≥s-Anest√©sica', grupo: 'Aten√ß√£o ao Paciente', classe: 'Grupo 1', utr: 'UTR dedicada', pressao: 'Positiva', temp: '21‚Äì24¬∞C', umi: '45‚Äì60% UR' },
];

function addAmbienteRDC() {
  ambienteNum++;
  const div = document.createElement('div');
  div.className = 'equip-card';
  div.id = 'amb-' + ambienteNum;
  div.innerHTML = `
    <div class="equip-num">AMBIENTE #${String(ambienteNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="document.getElementById('amb-${ambienteNum}').remove()">‚úï</button>
    <div class="form-grid">
      <div class="field span2">
        <label>Tipo de Ambiente (RDC 50)</label>
        <select class="amb-tipo" onchange="preencherRDC(this, ${ambienteNum})">
          <option value="">Selecione o ambiente...</option>
          ${tiposAmbienteRDC.map(t => `<option value="${t.tipo}">${t.tipo}</option>`).join('')}
          <option value="outro">Outro (especificar)</option>
        </select>
      </div>
      <div class="field">
        <label>Identifica√ß√£o / Nome da Sala</label>
        <input type="text" class="amb-nome" placeholder="Ex: Consult√≥rio 01, Sala Cir√∫rgica A">
      </div>
      <div class="field">
        <label>√Årea (m¬≤)</label>
        <input type="number" class="amb-area" placeholder="25">
      </div>
      <div class="field">
        <label>Grupo RDC 50</label>
        <input type="text" class="amb-grupo" placeholder="Preenchido automaticamente" readonly style="color:var(--accent2)">
      </div>
      <div class="field">
        <label>Classifica√ß√£o</label>
        <input type="text" class="amb-classe" placeholder="Preenchido automaticamente" readonly style="color:var(--accent2)">
      </div>
      <div class="field">
        <label>Press√£o Recomendada</label>
        <input type="text" class="amb-pressao" placeholder="Preenchido automaticamente" readonly style="color:var(--accent2)">
      </div>
      <div class="field">
        <label>Temperatura de Projeto</label>
        <input type="text" class="amb-temp" placeholder="Preenchido automaticamente" readonly style="color:var(--accent2)">
      </div>
      <div class="field">
        <label>Umidade Relativa</label>
        <input type="text" class="amb-umi" placeholder="Preenchido automaticamente" readonly style="color:var(--accent2)">
      </div>
      <div class="field">
        <label>Requisito UTR/Filtragem</label>
        <input type="text" class="amb-utr" placeholder="Preenchido automaticamente" readonly style="color:var(--accent2)">
      </div>
      <div class="field">
        <label>Equipamento de A/C Instalado (TAG)</label>
        <input type="text" class="amb-equip" placeholder="AC-01 / Split Hi-Wall">
      </div>
      <div class="field">
        <label>Conforme RDC 50?</label>
        <select class="amb-conf">
          <option>Sim ‚Äî Em conformidade</option>
          <option>N√£o ‚Äî Necessita adequa√ß√£o</option>
          <option>Parcial ‚Äî Adequa√ß√£o em andamento</option>
        </select>
      </div>
    </div>
  `;
  document.getElementById('rdc50-ambientes-list').appendChild(div);
}

function preencherRDC(sel, num) {
  const card = document.getElementById('amb-' + num);
  const tipo = tiposAmbienteRDC.find(t => t.tipo === sel.value);
  if (!tipo) return;
  card.querySelector('.amb-grupo').value = tipo.grupo;
  card.querySelector('.amb-classe').value = tipo.classe;
  card.querySelector('.amb-pressao').value = tipo.pressao;
  card.querySelector('.amb-temp').value = tipo.temp;
  card.querySelector('.amb-umi').value = tipo.umi;
  card.querySelector('.amb-utr').value = tipo.utr;
}

function addEquipOdonto() {
  odEquipNum++;
  const div = document.createElement('div');
  div.className = 'equip-card';
  div.id = 'odeq-' + odEquipNum;
  div.innerHTML = `
    <div class="equip-num">EQUIPAMENTO #${String(odEquipNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="document.getElementById('odeq-${odEquipNum}').remove()">‚úï</button>
    <div class="form-grid three">
      <div class="field"><label>TAG / Identifica√ß√£o</label><input type="text" class="odeq-tag" placeholder="AC-01"></div>
      <div class="field"><label>Ambiente Atendido</label><input type="text" class="odeq-amb" placeholder="Consult√≥rio 01"></div>
      <div class="field"><label>Tipo</label><select class="odeq-tipo"><option>Split Hi-Wall</option><option>Split Cassete</option><option>Split Piso-Teto</option><option>Fan Coil</option><option>VRF ‚Äî UI</option><option>VRF ‚Äî UE</option></select></div>
      <div class="field"><label>Fabricante</label><input type="text" class="odeq-fab" placeholder="Daikin / LG..."></div>
      <div class="field"><label>Modelo</label><input type="text" class="odeq-modelo" placeholder="Modelo"></div>
      <div class="field"><label>Capacidade (BTU/h)</label><select class="odeq-btu"><option>7.000</option><option>9.000</option><option>12.000</option><option>18.000</option><option>24.000</option><option>30.000</option><option>36.000</option><option>48.000</option><option>60.000+</option></select></div>
      <div class="field"><label>Fluido Ref.</label><select class="odeq-fluido"><option>R-410A</option><option>R-32</option><option>R-22</option><option>R-407C</option></select></div>
      <div class="field"><label>N¬∫ de S√©rie</label><input type="text" class="odeq-serie" placeholder="SN-00000"></div>
      <div class="field"><label>Ano de Fabrica√ß√£o</label><input type="text" class="odeq-ano" placeholder="2023"></div>
    </div>
  `;
  document.getElementById('od-equipamentos-list').appendChild(div);
}

function addProduto() {
  produtoNum++;
  const div = document.createElement('div');
  div.className = 'equip-card';
  div.id = 'prod-' + produtoNum;
  div.innerHTML = `
    <div class="equip-num" style="color:var(--accent2)">PRODUTO #${String(produtoNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="document.getElementById('prod-${produtoNum}').remove()">‚úï</button>
    <div class="form-grid three">
      <div class="field">
        <label>Nome Comercial do Produto</label>
        <input type="text" class="prod-nome" placeholder="Ex: Lysoform, Surfanios...">
      </div>
      <div class="field">
        <label>Princ√≠pio Ativo</label>
        <input type="text" class="prod-ativo" placeholder="Ex: Quatern√°rio de am√¥nio">
      </div>
      <div class="field">
        <label>Categoria / Finalidade</label>
        <select class="prod-cat">
          <option>Desinfetante de superf√≠cies</option>
          <option>Detergente / Desengraxante</option>
          <option>Desinfetante de serpentina</option>
          <option>Biocida / Algicida (bandeja)</option>
          <option>Neutralizador de odores</option>
          <option>Limpador de filtros</option>
          <option>Antif√∫ngico</option>
          <option>Sanitizante de dutos</option>
          <option>Outro</option>
        </select>
      </div>
      <div class="field">
        <label>Fabricante / Fornecedor</label>
        <input type="text" class="prod-fab" placeholder="Fabricante do produto">
      </div>
      <div class="field">
        <label>Registro ANVISA / MS</label>
        <input type="text" class="prod-anvisa" placeholder="MS 0.0000.0000.000-0">
      </div>
      <div class="field">
        <label>N¬∫ de Lote</label>
        <input type="text" class="prod-lote" placeholder="Lote do produto usado">
      </div>
      <div class="field">
        <label>Data de Fabrica√ß√£o</label>
        <input type="date" class="prod-fab-data">
      </div>
      <div class="field">
        <label>Data de Validade</label>
        <input type="date" class="prod-validade">
      </div>
      <div class="field">
        <label>Dilui√ß√£o Utilizada</label>
        <input type="text" class="prod-diluicao" placeholder="Ex: 1:10 / Puro / 2% v/v">
      </div>
      <div class="field">
        <label>Tempo de Contato</label>
        <input type="text" class="prod-contato" placeholder="Ex: 10 min / 30 min">
      </div>
      <div class="field">
        <label>Superf√≠cie / Local de Aplica√ß√£o</label>
        <input type="text" class="prod-local" placeholder="Ex: Serpentina, bandeja, filtros...">
      </div>
      <div class="field">
        <label>EPI Necess√°rio</label>
        <input type="text" class="prod-epi" placeholder="Ex: Luvas, √≥culos, m√°scara PFF2">
      </div>
    </div>
  `;
  document.getElementById('produtos-list').appendChild(div);
}

function addRegistroOdonto() {
  odRegNum++;
  const div = document.createElement('div');
  div.className = 'equip-card';
  div.id = 'odreg-' + odRegNum;
  div.innerHTML = `
    <div class="equip-num">REGISTRO #${String(odRegNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="document.getElementById('odreg-${odRegNum}').remove()">‚úï</button>
    <div class="form-grid">
      <div class="field"><label>Data</label><input type="date" class="odreg-data"></div>
      <div class="field"><label>TAG Equipamento</label><input type="text" class="odreg-tag" placeholder="AC-01"></div>
      <div class="field"><label>Ambiente</label><input type="text" class="odreg-amb" placeholder="Consult√≥rio 01"></div>
      <div class="field"><label>T√©cnico Executante</label><input type="text" class="odreg-tec" placeholder="Nome do t√©cnico"></div>
      <div class="field"><label>Tipo de Servi√ßo</label>
        <select class="odreg-tipo">
          <option>Manuten√ß√£o Preventiva</option>
          <option>Limpeza e Higieniza√ß√£o</option>
          <option>Desinfec√ß√£o do Sistema</option>
          <option>Troca de Filtros</option>
          <option>Manuten√ß√£o Corretiva</option>
          <option>An√°lise Microbiol√≥gica</option>
          <option>Recarga de Fluido</option>
        </select>
      </div>
      <div class="field"><label>Situa√ß√£o P√≥s-Servi√ßo</label>
        <select class="odreg-sit">
          <option>Em pleno funcionamento</option>
          <option>Funcionando com pend√™ncia</option>
          <option>Parado ‚Äî aguarda pe√ßa</option>
        </select>
      </div>
      <div class="field span2"><label>Servi√ßos Realizados</label>
        <textarea class="odreg-servico" style="min-height:55px" placeholder="Descreva os servi√ßos executados..."></textarea>
      </div>
    </div>
  `;
  document.getElementById('od-registros-list').appendChild(div);
}

// Atividades espec√≠ficas para odontologia com RDC 50
const atividadesOdonto = [
  { grupo: 'Filtros e Qualidade do Ar (RDC 50)', atividade: 'Inspe√ß√£o e limpeza dos filtros prim√°rios (G1/G2)', resp: 'T√©cnico', freq: 'M', rdc: 'Art. 6¬∞ RDC 50' },
  { grupo: 'Filtros e Qualidade do Ar (RDC 50)', atividade: 'Substitui√ß√£o / limpeza de filtros intermedi√°rios (G3/G4)', resp: 'T√©cnico', freq: 'T', rdc: 'Art. 6¬∞ RDC 50' },
  { grupo: 'Filtros e Qualidade do Ar (RDC 50)', atividade: 'Verifica√ß√£o/substitui√ß√£o de filtros absolutos HEPA (salas cir√∫rgicas)', resp: 'T√©cnico', freq: 'S', rdc: 'Anexo I RDC 50' },
  { grupo: 'Filtros e Qualidade do Ar (RDC 50)', atividade: 'An√°lise microbiol√≥gica do ar insuflado (ambientes cr√≠ticos)', resp: 'Lab. Credenciado', freq: 'S', rdc: 'Port. MS 3523 / RDC 50' },
  { grupo: 'Filtros e Qualidade do Ar (RDC 50)', atividade: 'Medi√ß√£o de CO‚ÇÇ, temperatura e umidade nos ambientes', resp: 'T√©cnico', freq: 'M', rdc: 'Port. MS 3523' },
  { grupo: 'Filtros e Qualidade do Ar (RDC 50)', atividade: 'Verifica√ß√£o de pressuriza√ß√£o diferencial entre salas', resp: 'T√©cnico', freq: 'M', rdc: 'Anexo I RDC 50' },
  { grupo: 'Higieniza√ß√£o e Desinfec√ß√£o', atividade: 'Desinfec√ß√£o qu√≠mica da serpentina evaporadora', resp: 'T√©cnico', freq: 'S', rdc: 'Port. MS 3523' },
  { grupo: 'Higieniza√ß√£o e Desinfec√ß√£o', atividade: 'Desinfec√ß√£o e limpeza da bandeja de condensado c/ biocida', resp: 'T√©cnico', freq: 'M', rdc: 'Port. MS 3523' },
  { grupo: 'Higieniza√ß√£o e Desinfec√ß√£o', atividade: 'Sanitiza√ß√£o de dutos e difusores de ar', resp: 'T√©cnico', freq: 'S', rdc: 'Port. MS 3523' },
  { grupo: 'Higieniza√ß√£o e Desinfec√ß√£o', atividade: 'Limpeza e desinfec√ß√£o das grelhas de insuflamento e retorno', resp: 'T√©cnico', freq: 'M', rdc: 'Port. MS 3523' },
  { grupo: 'Higieniza√ß√£o e Desinfec√ß√£o', atividade: 'Registro e controle dos produtos qu√≠micos utilizados (lote/validade)', resp: 'T√©cnico / RT', freq: 'M', rdc: 'ANVISA / RDC 50' },
  { grupo: 'Unidade Evaporadora', atividade: 'Limpeza do gabinete e painel frontal', resp: 'T√©cnico', freq: 'M', rdc: '‚Äî' },
  { grupo: 'Unidade Evaporadora', atividade: 'Verifica√ß√£o e desobstru√ß√£o do dreno de condensado', resp: 'T√©cnico', freq: 'M', rdc: '‚Äî' },
  { grupo: 'Unidade Evaporadora', atividade: 'Verifica√ß√£o do ventilador e rolamentos da evaporadora', resp: 'T√©cnico', freq: 'S', rdc: '‚Äî' },
  { grupo: 'Unidade Condensadora', atividade: 'Limpeza da serpentina condensadora', resp: 'T√©cnico', freq: 'S', rdc: '‚Äî' },
  { grupo: 'Unidade Condensadora', atividade: 'Verifica√ß√£o do ventilador axial e fixa√ß√£o do suporte', resp: 'T√©cnico', freq: 'T', rdc: '‚Äî' },
  { grupo: 'Sistema de Refrigera√ß√£o', atividade: 'Verifica√ß√£o de press√µes de suc√ß√£o e descarga', resp: 'T√©cnico', freq: 'S', rdc: '‚Äî' },
  { grupo: 'Sistema de Refrigera√ß√£o', atividade: 'Verifica√ß√£o de vazamento de fluido refrigerante', resp: 'T√©cnico', freq: 'S', rdc: '‚Äî' },
  { grupo: 'Sistema de Refrigera√ß√£o', atividade: 'Medi√ß√£o de temperatura de insuflamento', resp: 'T√©cnico', freq: 'M', rdc: 'RDC 50' },
  { grupo: 'Sistema El√©trico', atividade: 'Medi√ß√£o de tens√£o e corrente de opera√ß√£o', resp: 'T√©cnico', freq: 'S', rdc: '‚Äî' },
  { grupo: 'Sistema El√©trico', atividade: 'Verifica√ß√£o de aterramento e prote√ß√µes el√©tricas', resp: 'T√©cnico', freq: 'A', rdc: '‚Äî' },
  { grupo: 'Documenta√ß√£o e Conformidade', atividade: 'Atualiza√ß√£o do PMOC e registro de manuten√ß√£o', resp: 'RT', freq: 'M', rdc: 'Lei 13.589 / RDC 50' },
  { grupo: 'Documenta√ß√£o e Conformidade', atividade: 'Emiss√£o de relat√≥rio t√©cnico de conformidade RDC 50', resp: 'RT', freq: 'S', rdc: 'RDC ANVISA 50/2002' },
  { grupo: 'Documenta√ß√£o e Conformidade', atividade: 'Revis√£o anual do PMOC e envio √† vigil√¢ncia sanit√°ria', resp: 'RT', freq: 'A', rdc: 'Lei 13.589 / RDC 50' },
];

const mesesOd = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

function gerarCronogramaOd(freq) {
  return mesesOd.map((m, i) => {
    let marca = '';
    if (freq==='M') marca='‚óè';
    else if (freq==='T' && [0,3,6,9].includes(i)) marca='‚óè';
    else if (freq==='S' && [0,6].includes(i)) marca='‚óè';
    else if (freq==='A' && i===0) marca='‚óè';
    const color = marca ? (freq==='M'?'#1565c0':freq==='T'?'#2e7d32':freq==='S'?'#e65100':'#6a1b9a') : '';
    return `<td style="text-align:center;font-size:0.72rem;color:${color};padding:2px 1px;">${marca}</td>`;
  }).join('');
}

function gerarPMOCSaude() {
  const g = id => document.getElementById(id)?.value || '‚Äî';
  const dataF = d => {
    if(!d||d==='‚Äî') return '‚Äî';
    const [a,m,dia] = d.split('-');
    return `${dia}/${m}/${a}`;
  };

  // Ambientes RDC 50
  const ambCards = document.querySelectorAll('[id^="amb-"]');
  let ambRows = '';
  ambCards.forEach(card => {
    const nome = card.querySelector('.amb-nome').value || '‚Äî';
    const tipo = card.querySelector('.amb-tipo').value || '‚Äî';
    const area = card.querySelector('.amb-area').value || '‚Äî';
    const grupo = card.querySelector('.amb-grupo').value || '‚Äî';
    const classe = card.querySelector('.amb-classe').value || '‚Äî';
    const pressao = card.querySelector('.amb-pressao').value || '‚Äî';
    const temp = card.querySelector('.amb-temp').value || '‚Äî';
    const umi = card.querySelector('.amb-umi').value || '‚Äî';
    const utr = card.querySelector('.amb-utr').value || '‚Äî';
    const equip = card.querySelector('.amb-equip').value || '‚Äî';
    const conf = card.querySelector('.amb-conf').value || '‚Äî';
    const confColor = conf.includes('conformidade')?'#2e7d32':conf.includes('andamento')?'#e65100':'#c62828';
    ambRows += `<tr>
      <td style="font-weight:bold;">${nome}</td>
      <td style="font-size:0.72rem;">${tipo}</td>
      <td style="text-align:center;">${area} m¬≤</td>
      <td style="font-size:0.72rem;">${grupo}</td>
      <td style="text-align:center;font-size:0.72rem;">${classe}</td>
      <td style="font-size:0.72rem;">${pressao}</td>
      <td style="font-size:0.72rem;">${temp}</td>
      <td style="font-size:0.72rem;">${umi}</td>
      <td style="font-size:0.72rem;">${utr}</td>
      <td style="font-size:0.72rem;">${equip}</td>
      <td style="color:${confColor};font-size:0.7rem;font-weight:bold;">${conf}</td>
    </tr>`;
  });

  // Equipamentos
  const eqCards = document.querySelectorAll('[id^="odeq-"]');
  let eqRows = '';
  eqCards.forEach(card => {
    const tag = card.querySelector('.odeq-tag').value || '‚Äî';
    const amb = card.querySelector('.odeq-amb').value || '‚Äî';
    const tipo = card.querySelector('.odeq-tipo').value;
    const fab = card.querySelector('.odeq-fab').value || '‚Äî';
    const modelo = card.querySelector('.odeq-modelo').value || '‚Äî';
    const btu = card.querySelector('.odeq-btu').value;
    const fluido = card.querySelector('.odeq-fluido').value;
    const serie = card.querySelector('.odeq-serie').value || '‚Äî';
    const ano = card.querySelector('.odeq-ano').value || '‚Äî';
    eqRows += `<tr><td style="font-weight:bold;text-align:center;">${tag}</td><td>${amb}</td><td>${tipo}</td><td>${fab} ${modelo}</td><td>${btu} BTU/h</td><td>${fluido}</td><td>${ano}</td><td style="font-family:monospace;font-size:0.72rem;">${serie}</td></tr>`;
  });

  // Produtos qu√≠micos
  const prodCards = document.querySelectorAll('[id^="prod-"]');
  let prodRows = '';
  let hasProd = prodCards.length > 0;
  prodCards.forEach((card, i) => {
    const nome = card.querySelector('.prod-nome').value || '‚Äî';
    const ativo = card.querySelector('.prod-ativo').value || '‚Äî';
    const cat = card.querySelector('.prod-cat').value;
    const fab2 = card.querySelector('.prod-fab').value || '‚Äî';
    const anvisa = card.querySelector('.prod-anvisa').value || '‚Äî';
    const lote = card.querySelector('.prod-lote').value || '‚Äî';
    const fabData = dataF(card.querySelector('.prod-fab-data').value);
    const validade = dataF(card.querySelector('.prod-validade').value);
    const diluicao = card.querySelector('.prod-diluicao').value || 'Puro';
    const contato = card.querySelector('.prod-contato').value || '‚Äî';
    const local = card.querySelector('.prod-local').value || '‚Äî';
    const epi = card.querySelector('.prod-epi').value || '‚Äî';

    // Verificar validade
    const valdRaw = card.querySelector('.prod-validade').value;
    let valdStatus = '', valdColor = '#111';
    if (valdRaw) {
      const hoje = new Date(); const val = new Date(valdRaw);
      if (val < hoje) { valdStatus = ' ‚ö† VENCIDO'; valdColor = '#c62828'; }
      else if ((val - hoje) < 30*24*3600*1000) { valdStatus = ' ‚ö† Vence em breve'; valdColor = '#e65100'; }
      else { valdStatus = ' ‚úì'; valdColor = '#2e7d32'; }
    }

    prodRows += `<tr style="background:${i%2===0?'#fff':'#fafafa'}">
      <td style="font-weight:bold;font-size:0.78rem;">${nome}</td>
      <td style="font-size:0.72rem;">${ativo}</td>
      <td style="font-size:0.72rem;">${cat}</td>
      <td style="font-size:0.72rem;">${fab2}</td>
      <td style="font-family:monospace;font-size:0.72rem;">${anvisa}</td>
      <td style="font-family:monospace;font-size:0.72rem;">${lote}</td>
      <td style="font-size:0.72rem;">${fabData}</td>
      <td style="font-size:0.72rem;color:${valdColor};font-weight:bold;">${validade}${valdStatus}</td>
      <td style="font-size:0.72rem;font-weight:bold;">${diluicao}</td>
      <td style="font-size:0.72rem;">${contato}</td>
      <td style="font-size:0.72rem;">${local}</td>
      <td style="font-size:0.72rem;">${epi}</td>
    </tr>`;
  });

  // Registros
  const regCards = document.querySelectorAll('[id^="odreg-"]');
  let regRows = '';
  let hasReg = regCards.length > 0;
  regCards.forEach(card => {
    const data = dataF(card.querySelector('.odreg-data').value);
    const tag = card.querySelector('.odreg-tag').value || '‚Äî';
    const amb = card.querySelector('.odreg-amb').value || '‚Äî';
    const tec = card.querySelector('.odreg-tec').value || '‚Äî';
    const tipo = card.querySelector('.odreg-tipo').value;
    const sit = card.querySelector('.odreg-sit').value;
    const serv = card.querySelector('.odreg-servico').value || '‚Äî';
    const sitColor = sit.includes('pleno')?'#2e7d32':sit.includes('pend√™ncia')?'#e65100':'#c62828';
    regRows += `<tr>
      <td>${data}</td><td style="font-weight:bold;">${tag}</td><td>${amb}</td>
      <td>${tipo}</td><td style="font-size:0.72rem;">${serv}</td><td>${tec}</td>
      <td style="color:${sitColor};font-size:0.7rem;font-weight:bold;">${sit}</td>
    </tr>`;
  });

  // Cronograma agrupado
  const gruposOd = {};
  atividadesOdonto.forEach(a => {
    if (!gruposOd[a.grupo]) gruposOd[a.grupo] = [];
    gruposOd[a.grupo].push(a);
  });
  let cronHTML = '';
  Object.entries(gruposOd).forEach(([grupo, ativs]) => {
    cronHTML += `<tr style="background:#e8f5e9;"><td colspan="${4 + mesesOd.length}" style="padding:4px 8px;font-weight:bold;font-size:0.76rem;color:#1b5e20;letter-spacing:0.5px;">${grupo.toUpperCase()}</td></tr>`;
    ativs.forEach((a, i) => {
      const fLabel = a.freq==='M'?'Mensal':a.freq==='T'?'Trimestral':a.freq==='S'?'Semestral':'Anual';
      const fColor = a.freq==='M'?'#1565c0':a.freq==='T'?'#2e7d32':a.freq==='S'?'#e65100':'#6a1b9a';
      cronHTML += `<tr style="background:${i%2===0?'#fff':'#fafafa'}">
        <td style="padding:3px 8px;font-size:0.74rem;">${a.atividade}</td>
        <td style="text-align:center;font-size:0.68rem;color:${fColor};font-weight:bold;">${fLabel}</td>
        <td style="text-align:center;font-size:0.68rem;">${a.resp}</td>
        <td style="text-align:center;font-size:0.68rem;color:#1565c0;">${a.rdc}</td>
        ${gerarCronogramaOd(a.freq)}
      </tr>`;
    });
  });

  const html = `
  <div style="font-family:'Times New Roman',serif;color:#111;">

    <!-- CABE√áALHO -->
    <div style="border:2px solid #1b5e20;padding:1rem;margin-bottom:1.2rem;">
      <h2 style="text-align:center;font-size:1.15rem;color:#1b5e20;margin-bottom:0.2rem;text-transform:uppercase;letter-spacing:1px;">
        Plano de Manuten√ß√£o, Opera√ß√£o e Controle ‚Äî PMOC
      </h2>
      <div style="text-align:center;font-size:0.78rem;color:#555;margin-bottom:0.5rem;">
        Estabelecimento de Sa√∫de ¬∑ RDC ANVISA n¬∫ 50/2002 ¬∑ Lei 13.589/2018 ¬∑ Portaria MS 3.523/1998 ¬∑ ABNT NBR 16401
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;font-size:0.8rem;border-top:1px solid #ccc;padding-top:0.6rem;">
        <div><strong>Estabelecimento:</strong> ${g('od_local')}</div>
        <div><strong>CNPJ:</strong> ${g('od_cnpj')}</div>
        <div><strong>Endere√ßo:</strong> ${g('od_end')}</div>
        <div><strong>Tipo:</strong> ${g('od_tipo')}</div>
        <div><strong>Respons√°vel Cl√≠nico:</strong> ${g('od_resp_clinico')} ‚Äî Reg.: ${g('od_cro')}</div>
        <div><strong>Alvar√° Sanit√°rio:</strong> ${g('od_alvara')}</div>
        <div><strong>N¬∫ de Consult√≥rios/Salas:</strong> ${g('od_salas')}</div>
        <div><strong>√Årea Climatizada:</strong> ${g('od_area')} m¬≤</div>
        <div><strong>Vig√™ncia:</strong> ${dataF(g('od_ini'))} a ${dataF(g('od_fim'))}</div>
      </div>
    </div>

    <!-- EMPRESA E RT -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.2rem;">
      <div style="border:1px solid #ddd;padding:0.7rem;border-radius:4px;">
        <div style="font-weight:bold;font-size:0.75rem;background:#f1f8e9;padding:0.25rem 0.5rem;margin:-0.7rem -0.7rem 0.5rem;color:#1b5e20;">EMPRESA EXECUTANTE</div>
        <div style="font-size:0.78rem;line-height:1.7;">
          <div><strong>${g('od_empresa')}</strong></div>
          <div>CNPJ: ${g('od_cnpj_emp')}</div>
          <div>${g('od_end_emp')}</div>
          <div>${g('od_contato_emp')}</div>
        </div>
      </div>
      <div style="border:1px solid #ddd;padding:0.7rem;border-radius:4px;">
        <div style="font-weight:bold;font-size:0.75rem;background:#f1f8e9;padding:0.25rem 0.5rem;margin:-0.7rem -0.7rem 0.5rem;color:#1b5e20;">RESPONS√ÅVEL T√âCNICO</div>
        <div style="font-size:0.78rem;line-height:1.7;">
          <div><strong>${g('od_resp')}</strong> ‚Äî ${g('od_espec')}</div>
          <div>CREA: ${g('od_crea')} ¬∑ ART: ${g('od_art')}</div>
          <div>${g('od_tel_resp')} ¬∑ ${g('od_email_resp')}</div>
        </div>
      </div>
    </div>

    <!-- CLASSIFICA√á√ÉO RDC 50 -->
    <div style="margin-bottom:1.2rem;">
      <div style="background:#1b5e20;color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.8rem;letter-spacing:0.5px;">
        1. CLASSIFICA√á√ÉO DE AMBIENTES ‚Äî RDC ANVISA N¬∫ 50/2002
      </div>
      ${ambRows ? `
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:0.74rem;min-width:900px;">
          <thead>
            <tr style="background:#e8f5e9;color:#1b5e20;">
              <th style="padding:4px 6px;text-align:left;">Sala / Ambiente</th>
              <th style="padding:4px 6px;text-align:left;">Tipo (RDC 50)</th>
              <th style="padding:4px 6px;text-align:center;">√Årea</th>
              <th style="padding:4px 6px;text-align:left;">Grupo</th>
              <th style="padding:4px 6px;text-align:center;">Classe</th>
              <th style="padding:4px 6px;text-align:left;">Press√£o</th>
              <th style="padding:4px 6px;text-align:left;">Temp.</th>
              <th style="padding:4px 6px;text-align:left;">UR%</th>
              <th style="padding:4px 6px;text-align:left;">UTR/Filtragem</th>
              <th style="padding:4px 6px;text-align:left;">Equip. A/C</th>
              <th style="padding:4px 6px;text-align:left;">Conf. RDC 50</th>
            </tr>
          </thead>
          <tbody>${ambRows}</tbody>
        </table>
      </div>` : '<div style="padding:0.8rem;border:1px solid #ddd;border-top:none;font-size:0.8rem;color:#999;">Nenhum ambiente cadastrado.</div>'}
    </div>

    <!-- EQUIPAMENTOS -->
    <div style="margin-bottom:1.2rem;">
      <div style="background:#1b5e20;color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.8rem;letter-spacing:0.5px;">
        2. INVENT√ÅRIO DE EQUIPAMENTOS
      </div>
      ${eqRows ? `
      <table style="width:100%;border-collapse:collapse;font-size:0.74rem;">
        <thead><tr style="background:#e8f5e9;color:#1b5e20;">
          <th style="padding:4px 6px;">TAG</th><th>Ambiente</th><th>Tipo</th><th>Fabricante/Modelo</th>
          <th>Capac.</th><th>Fluido</th><th>Ano</th><th>N¬∫ S√©rie</th>
        </tr></thead>
        <tbody>${eqRows}</tbody>
      </table>` : '<div style="padding:0.8rem;border:1px solid #ddd;border-top:none;font-size:0.8rem;color:#999;">Nenhum equipamento cadastrado.</div>'}
    </div>

    <!-- CRONOGRAMA -->
    <div style="margin-bottom:1.2rem;">
      <div style="background:#1b5e20;color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.8rem;letter-spacing:0.5px;">
        3. CRONOGRAMA DE MANUTEN√á√ÉO PREVENTIVA
      </div>
      <div style="font-size:0.68rem;color:#555;padding:0.25rem 0.5rem;background:#f9f9f9;border:1px solid #ddd;border-top:none;margin-bottom:2px;">
        <span style="color:#1565c0;font-weight:bold;">‚óè Mensal</span> &nbsp;
        <span style="color:#2e7d32;font-weight:bold;">‚óè Trimestral</span> &nbsp;
        <span style="color:#e65100;font-weight:bold;">‚óè Semestral</span> &nbsp;
        <span style="color:#6a1b9a;font-weight:bold;">‚óè Anual</span>
      </div>
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:0.7rem;min-width:780px;">
          <thead><tr style="background:#e8f5e9;color:#1b5e20;">
            <th style="padding:4px 8px;text-align:left;min-width:230px;">Atividade</th>
            <th style="padding:4px 4px;text-align:center;min-width:65px;">Frequ√™ncia</th>
            <th style="padding:4px 4px;text-align:center;min-width:60px;">Respons√°vel</th>
            <th style="padding:4px 4px;text-align:center;min-width:90px;">Base Legal</th>
            ${mesesOd.map(m=>`<th style="padding:4px 2px;text-align:center;min-width:22px;">${m}</th>`).join('')}
          </tr></thead>
          <tbody>${cronHTML}</tbody>
        </table>
      </div>
    </div>

    <!-- PRODUTOS QU√çMICOS -->
    ${hasProd ? `
    <div style="margin-bottom:1.2rem;">
      <div style="background:#1b5e20;color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.8rem;letter-spacing:0.5px;">
        4. PRODUTOS QU√çMICOS UTILIZADOS NA MANUTEN√á√ÉO
      </div>
      <div style="font-size:0.68rem;background:#fff8e1;padding:0.25rem 0.6rem;border:1px solid #ddd;border-top:none;color:#555;margin-bottom:2px;">
        ‚ö† Verifique a validade dos produtos antes de cada aplica√ß√£o. Produtos vencidos n√£o devem ser utilizados. Mantenha fichas de seguran√ßa (FISPQ) dispon√≠veis.
      </div>
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:0.72rem;min-width:900px;">
          <thead><tr style="background:#e8f5e9;color:#1b5e20;">
            <th style="padding:4px 6px;text-align:left;">Produto</th>
            <th>Princ√≠pio Ativo</th><th>Finalidade</th><th>Fabricante</th>
            <th>ANVISA</th><th>Lote</th><th>Fab.</th>
            <th>Validade</th><th>Dilui√ß√£o</th><th>T. Contato</th>
            <th>Aplica√ß√£o</th><th>EPI</th>
          </tr></thead>
          <tbody>${prodRows}</tbody>
        </table>
      </div>
    </div>` : ''}

    <!-- REGISTROS -->
    ${hasReg ? `
    <div style="margin-bottom:1.2rem;">
      <div style="background:#1b5e20;color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.8rem;letter-spacing:0.5px;">
        ${hasProd?'5':'4'}. REGISTRO DE EXECU√á√ÉO DOS SERVI√áOS
      </div>
      <table style="width:100%;border-collapse:collapse;font-size:0.74rem;">
        <thead><tr style="background:#e8f5e9;color:#1b5e20;">
          <th style="padding:4px 6px;">Data</th><th>TAG</th><th>Ambiente</th>
          <th>Tipo de Servi√ßo</th><th>Servi√ßos Realizados</th><th>T√©cnico</th><th>Situa√ß√£o</th>
        </tr></thead>
        <tbody>${regRows}</tbody>
      </table>
    </div>` : ''}

    <!-- OBSERVA√á√ïES -->
    ${g('od_obs') !== '‚Äî' ? `
    <div style="margin-bottom:1.2rem;">
      <div style="background:#1b5e20;color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.8rem;letter-spacing:0.5px;">OBSERVA√á√ïES E RECOMENDA√á√ïES</div>
      <div style="padding:0.7rem;border:1px solid #ddd;border-top:none;font-size:0.8rem;line-height:1.7;">${g('od_obs')}</div>
    </div>` : ''}

    <!-- BASE LEGAL -->
    <div style="background:#f1f8e9;border:1px solid #c8e6c9;padding:0.7rem;font-size:0.72rem;color:#444;line-height:1.6;margin-bottom:1.2rem;">
      <strong>Base Legal e Normativa:</strong> Este PMOC foi elaborado em conformidade com a <strong>RDC ANVISA n¬∫ 50/2002</strong> (regulamento t√©cnico para planejamento, programa√ß√£o, elabora√ß√£o e avalia√ß√£o de projetos f√≠sicos de estabelecimentos assistenciais de sa√∫de), 
      <strong>Lei n¬∫ 13.589/2018</strong>, <strong>Portaria MS n¬∫ 3.523/1998</strong>, <strong>ABNT NBR 16401</strong> e demais normas t√©cnicas aplic√°veis.
      A classifica√ß√£o dos ambientes obedece ao Anexo I da RDC 50, que estabelece os requisitos de temperatura, umidade, renova√ß√£o de ar e filtragem para cada tipo de ambiente de sa√∫de.
    </div>

    <!-- ASSINATURAS -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1.5rem;text-align:center;font-size:0.78rem;margin-top:1rem;">
      <div>
        <div style="border-top:1px solid #333;padding-top:0.4rem;margin-top:2.5rem;">
          <strong>${g('od_resp')}</strong><br>${g('od_espec')}<br>${g('od_crea')}<br>Respons√°vel T√©cnico
        </div>
      </div>
      <div>
        <div style="border-top:1px solid #333;padding-top:0.4rem;margin-top:2.5rem;">
          <strong>${g('od_resp_clinico')}</strong><br>Reg.: ${g('od_cro')}<br>${g('od_local')}<br>Respons√°vel Cl√≠nico
        </div>
      </div>
      <div>
        <div style="border-top:1px solid #333;padding-top:0.4rem;margin-top:2.5rem;">
          <strong>Vigil√¢ncia Sanit√°ria</strong><br>Carimbo e Assinatura<br><br>Data: ___/___/______
        </div>
      </div>
    </div>

  </div>`;

  document.getElementById('odonto-content').innerHTML = html;
  document.getElementById('odonto-preview').classList.add('show');
  document.getElementById('odonto-preview').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function limparPMOCSaude() {
  document.querySelectorAll('#section-odonto input, #section-odonto select, #section-odonto textarea').forEach(e => e.value = '');
  document.getElementById('rdc50-ambientes-list').innerHTML = '';
  document.getElementById('od-equipamentos-list').innerHTML = '';
  document.getElementById('produtos-list').innerHTML = '';
  document.getElementById('od-registros-list').innerHTML = '';
  ambienteNum = 0; produtoNum = 0; odEquipNum = 0; odRegNum = 0;
  document.getElementById('odonto-preview').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RELAT√ìRIO DE VISITA T√âCNICA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let rvServNum=0, rvPecaNum=0, rvFotos=[], rvFotoId=0, rvSigCanvas=null, rvSigCtx=null, rvSigDrawing=false, rvSigMark=false, rvSigDataURL=null;

function addServico() {
  rvServNum++;
  const d = document.createElement('div');
  d.className = 'equip-card'; d.id = 'rvs-'+rvServNum;
  d.innerHTML = `<div class="equip-num">SERVI√áO #${String(rvServNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="document.getElementById('rvs-${rvServNum}').remove()">‚úï</button>
    <div class="form-grid">
      <div class="field span2"><label>Descri√ß√£o do Servi√ßo</label><input type="text" class="rvs-desc" placeholder="Ex: Limpeza completa da evaporadora"></div>
      <div class="field"><label>Tempo Gasto</label><input type="text" class="rvs-tempo" placeholder="Ex: 2h30"></div>
      <div class="field"><label>Situa√ß√£o</label><select class="rvs-sit"><option>Conclu√≠do</option><option>Parcial ‚Äî continua√ß√£o necess√°ria</option><option>N√£o executado</option></select></div>
    </div>`;
  document.getElementById('rv-servicos-list').appendChild(d);
}

function addPeca() {
  rvPecaNum++;
  const d = document.createElement('div');
  d.className = 'equip-card'; d.id = 'rvp-'+rvPecaNum;
  d.innerHTML = `<div class="equip-num">PE√áA #${String(rvPecaNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="document.getElementById('rvp-${rvPecaNum}').remove()">‚úï</button>
    <div class="form-grid three">
      <div class="field"><label>Descri√ß√£o</label><input type="text" class="rvp-desc" placeholder="Ex: Filtro de ar G3"></div>
      <div class="field"><label>Quantidade</label><input type="number" class="rvp-qtd" value="1" min="1"></div>
      <div class="field"><label>Fornecida por</label><select class="rvp-forn"><option>Empresa executante</option><option>Cliente</option><option>A providenciar</option></select></div>
    </div>`;
  document.getElementById('rv-pecas-list').appendChild(d);
}

function adicionarFotosVisita(input) {
  Array.from(input.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      rvFotos.push({ id: ++rvFotoId, src: e.target.result, legenda: '' });
      renderFotosVisita();
    };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function renderFotosVisita() {
  const grid = document.getElementById('rv-fotos-grid');
  grid.innerHTML = '';
  rvFotos.forEach((foto, idx) => {
    const div = document.createElement('div');
    div.className = 'foto-item';
    div.innerHTML = `<span class="foto-num">Foto ${idx+1}</span>
      <img src="${foto.src}">
      <div class="foto-overlay">
        <input class="foto-legenda" type="text" placeholder="Legenda..." value="${foto.legenda}" oninput="rvFotos[${idx}].legenda=this.value" onclick="event.stopPropagation()">
        <button class="foto-remove" onclick="rvFotos=rvFotos.filter(f=>f.id!=${foto.id});renderFotosVisita();event.stopPropagation()">üóë Remover</button>
      </div>`;
    grid.appendChild(div);
  });
}

function initSigCliente() {
  rvSigCanvas = document.getElementById('rv-sig-canvas');
  if(!rvSigCanvas) return;
  rvSigCtx = rvSigCanvas.getContext('2d');
  rvSigCtx.strokeStyle='#1a1a2e'; rvSigCtx.lineWidth=2.5; rvSigCtx.lineCap='round'; rvSigCtx.lineJoin='round';
  function drawGuide() {
    rvSigCtx.clearRect(0,0,rvSigCanvas.width,rvSigCanvas.height);
    rvSigCtx.save(); rvSigCtx.strokeStyle='#e0e0e0'; rvSigCtx.lineWidth=1; rvSigCtx.setLineDash([4,4]);
    const y=rvSigCanvas.height*0.72; rvSigCtx.beginPath(); rvSigCtx.moveTo(20,y); rvSigCtx.lineTo(rvSigCanvas.width-20,y); rvSigCtx.stroke(); rvSigCtx.restore();
    rvSigCtx.strokeStyle='#1a1a2e'; rvSigCtx.lineWidth=2.5; rvSigCtx.setLineDash([]);
  }
  drawGuide();
  function getPos(e) { const r=rvSigCanvas.getBoundingClientRect(),scX=rvSigCanvas.width/r.width,scY=rvSigCanvas.height/r.height,s=e.touches?e.touches[0]:e; return {x:(s.clientX-r.left)*scX,y:(s.clientY-r.top)*scY}; }
  rvSigCanvas.addEventListener('mousedown', e=>{rvSigDrawing=true;rvSigMark=true;const p=getPos(e);rvSigCtx.beginPath();rvSigCtx.moveTo(p.x,p.y);});
  rvSigCanvas.addEventListener('mousemove', e=>{if(!rvSigDrawing)return;const p=getPos(e);rvSigCtx.lineTo(p.x,p.y);rvSigCtx.stroke();});
  rvSigCanvas.addEventListener('mouseup', ()=>rvSigDrawing=false);
  rvSigCanvas.addEventListener('mouseleave', ()=>rvSigDrawing=false);
  rvSigCanvas.addEventListener('touchstart', e=>{e.preventDefault();rvSigDrawing=true;rvSigMark=true;const p=getPos(e);rvSigCtx.beginPath();rvSigCtx.moveTo(p.x,p.y);},{passive:false});
  rvSigCanvas.addEventListener('touchmove', e=>{e.preventDefault();if(!rvSigDrawing)return;const p=getPos(e);rvSigCtx.lineTo(p.x,p.y);rvSigCtx.stroke();},{passive:false});
  rvSigCanvas.addEventListener('touchend', e=>{e.preventDefault();rvSigDrawing=false;},{passive:false});
}

function limparSigCliente() {
  if(!rvSigCanvas) return;
  rvSigCtx.clearRect(0,0,rvSigCanvas.width,rvSigCanvas.height);
  rvSigCtx.save(); rvSigCtx.strokeStyle='#e0e0e0'; rvSigCtx.lineWidth=1; rvSigCtx.setLineDash([4,4]);
  const y=rvSigCanvas.height*0.72; rvSigCtx.beginPath(); rvSigCtx.moveTo(20,y); rvSigCtx.lineTo(rvSigCanvas.width-20,y); rvSigCtx.stroke(); rvSigCtx.restore();
  rvSigCtx.strokeStyle='#1a1a2e'; rvSigCtx.lineWidth=2.5; rvSigCtx.setLineDash([]);
  rvSigMark=false; rvSigDataURL=null; document.getElementById('rv-sig-status').textContent='';
}

function salvarSigCliente() {
  if(!rvSigMark){ document.getElementById('rv-sig-status').textContent='Assine antes de confirmar'; return; }
  rvSigDataURL = rvSigCanvas.toDataURL('image/png');
  document.getElementById('rv-sig-status').textContent='‚úì Assinatura do cliente salva!';
  document.getElementById('rv-sig-status').style.color='var(--accent)';
}

function gerarVisita() {
  const g = id => document.getElementById(id)?.value||'‚Äî';
  const dataF = d => { if(!d||d==='‚Äî')return'‚Äî'; const[a,m,dia]=d.split('-'); return`${dia}/${m}/${a}`; };
  let cfg={empresa:'',cnpj:'',cor:'#0d3b6e'};
  try{ const r=localStorage.getItem('techar_config'); if(r) Object.assign(cfg,JSON.parse(r)); }catch(e){}
  const header = gerarHeaderHTML(cfg, logoDataURL);
  const cor = cfg.cor||'#0d3b6e';

  let servsHTML='', servCards=document.querySelectorAll('[id^="rvs-"]');
  servCards.forEach((c,i)=>{
    const desc=c.querySelector('.rvs-desc').value||'‚Äî';
    const tempo=c.querySelector('.rvs-tempo').value||'‚Äî';
    const sit=c.querySelector('.rvs-sit').value;
    const sitC=sit==='Conclu√≠do'?'#2e7d32':sit.includes('Parcial')?'#e65100':'#c62828';
    servsHTML+=`<tr style="background:${i%2===0?'#fff':'#fafafa'}"><td style="padding:5px 8px;">${i+1}. ${desc}</td><td style="text-align:center;padding:5px 8px;">${tempo}</td><td style="text-align:center;padding:5px 8px;color:${sitC};font-weight:bold;">${sit}</td></tr>`;
  });

  let pecasHTML='', pecaCards=document.querySelectorAll('[id^="rvp-"]');
  pecaCards.forEach((c,i)=>{
    const desc=c.querySelector('.rvp-desc').value||'‚Äî';
    const qtd=c.querySelector('.rvp-qtd').value||'1';
    const forn=c.querySelector('.rvp-forn').value;
    pecasHTML+=`<tr style="background:${i%2===0?'#fff':'#fafafa'}"><td style="padding:5px 8px;">${desc}</td><td style="text-align:center;padding:5px 8px;">${qtd}</td><td style="padding:5px 8px;">${forn}</td></tr>`;
  });

  let fotosHTML='';
  if(rvFotos.length>0){
    let fg=''; rvFotos.forEach((f,i)=>{ fg+=`<div style="border:1px solid #ddd;border-radius:6px;overflow:hidden;"><img src="${f.src}" style="width:100%;height:130px;object-fit:cover;display:block;"><div style="padding:0.25rem 0.5rem;background:#f9f9f9;font-size:0.68rem;text-align:center;color:#555;"><strong>Foto ${i+1}</strong>${f.legenda?' ‚Äî '+f.legenda:''}</div></div>`; });
    fotosHTML=`<div style="margin-bottom:1rem;"><div style="background:${cor};color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.78rem;">REGISTRO FOTOGR√ÅFICO</div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;padding:0.6rem;border:1px solid #ddd;border-top:none;">${fg}</div></div>`;
  }

  const sigClienteHTML = rvSigDataURL
    ? `<img src="${rvSigDataURL}" style="height:55px;max-width:200px;object-fit:contain;display:block;margin:0.5rem auto;">`
    : '<div style="height:55px;"></div>';
  const sigEngHTML = assinaturaDataURL
    ? `<img src="${assinaturaDataURL}" style="height:55px;max-width:200px;object-fit:contain;display:block;margin:0.5rem auto;">`
    : '<div style="height:55px;"></div>';

  const html = `<div style="font-family:serif;color:#111;">
    ${header}
    <h2 style="text-align:center;font-size:1.1rem;text-transform:uppercase;letter-spacing:1px;color:${cor};margin-bottom:0.2rem;">Relat√≥rio de Visita T√©cnica</h2>
    <div style="text-align:center;font-size:0.75rem;color:#777;border-bottom:2px solid ${cor};padding-bottom:0.6rem;margin-bottom:1rem;">N¬∫ ${g('rv_num')} ¬∑ ${dataF(g('rv_data'))}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;margin-bottom:1rem;font-size:0.82rem;">
      <div style="border:1px solid #ddd;padding:0.7rem;border-radius:4px;">
        <div style="font-weight:bold;font-size:0.72rem;background:#f5f5f5;padding:0.2rem 0.5rem;margin:-0.7rem -0.7rem 0.5rem;color:${cor};">DADOS DA VISITA</div>
        <div><strong>T√©cnico:</strong> ${g('rv_tec')}</div>
        <div><strong>Tipo:</strong> ${g('rv_tipo')}</div>
        <div><strong>Chegada:</strong> ${g('rv_chegada')} &nbsp;|&nbsp; <strong>Sa√≠da:</strong> ${g('rv_saida')}</div>
      </div>
      <div style="border:1px solid #ddd;padding:0.7rem;border-radius:4px;">
        <div style="font-weight:bold;font-size:0.72rem;background:#f5f5f5;padding:0.2rem 0.5rem;margin:-0.7rem -0.7rem 0.5rem;color:${cor};">CLIENTE / LOCAL</div>
        <div><strong>${g('rv_cliente')}</strong></div>
        <div>${g('rv_end')}</div>
        <div><strong>Contato:</strong> ${g('rv_contato')}</div>
      </div>
    </div>
    <div style="margin-bottom:0.8rem;font-size:0.8rem;"><strong>Equipamento:</strong> ${g('rv_equip')} &nbsp;|&nbsp; <strong>S√©rie:</strong> ${g('rv_serie')}</div>
    ${servsHTML?`<div style="margin-bottom:1rem;"><div style="background:${cor};color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.78rem;">SERVI√áOS REALIZADOS</div><table style="width:100%;border-collapse:collapse;font-size:0.78rem;"><thead><tr style="background:#f0f0f0;"><th style="padding:5px 8px;text-align:left;">Servi√ßo</th><th style="padding:5px 8px;text-align:center;">Tempo</th><th style="padding:5px 8px;text-align:center;">Situa√ß√£o</th></tr></thead><tbody>${servsHTML}</tbody></table></div>`:''}
    ${pecasHTML?`<div style="margin-bottom:1rem;"><div style="background:${cor};color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.78rem;">PE√áAS E MATERIAIS</div><table style="width:100%;border-collapse:collapse;font-size:0.78rem;"><thead><tr style="background:#f0f0f0;"><th style="padding:5px 8px;text-align:left;">Item</th><th style="padding:5px 8px;text-align:center;">Qtd</th><th style="padding:5px 8px;text-align:left;">Fornecida por</th></tr></thead><tbody>${pecasHTML}</tbody></table></div>`:''}
    ${fotosHTML}
    ${g('rv_obs')!=='‚Äî'?`<div style="margin-bottom:0.8rem;"><div style="background:${cor};color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.78rem;">DIAGN√ìSTICO / OBSERVA√á√ïES</div><div style="padding:0.6rem;border:1px solid #ddd;border-top:none;font-size:0.8rem;line-height:1.6;">${g('rv_obs')}</div></div>`:''}
    ${g('rv_pend')!=='‚Äî'?`<div style="margin-bottom:0.8rem;"><div style="background:${cor};color:white;padding:0.35rem 0.8rem;font-weight:bold;font-size:0.78rem;">PEND√äNCIAS / RECOMENDA√á√ïES</div><div style="padding:0.6rem;border:1px solid #ddd;border-top:none;font-size:0.8rem;line-height:1.6;">${g('rv_pend')}</div></div>`:''}
    <div style="margin-bottom:1rem;font-size:0.82rem;"><strong>Situa√ß√£o final:</strong> <span style="color:${g('rv_sit').includes('pleno')?'#2e7d32':g('rv_sit').includes('Parado')?'#c62828':'#e65100'};font-weight:bold;">${g('rv_sit')}</span></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;text-align:center;font-size:0.8rem;margin-top:1.5rem;">
      <div>${sigEngHTML}<div style="border-top:1px solid #333;padding-top:0.3rem;"><strong>${g('rv_tec')}</strong><br>T√©cnico Respons√°vel</div></div>
      <div>${sigClienteHTML}<div style="border-top:1px solid #333;padding-top:0.3rem;"><strong>${g('rv_contato')||g('rv_cliente')}</strong><br>Cliente ‚Äî Confirma√ß√£o dos Servi√ßos</div></div>
    </div>
  </div>`;

  document.getElementById('visita-content').innerHTML = html;
  document.getElementById('visita-preview').classList.add('show');
  document.getElementById('visita-preview').scrollIntoView({behavior:'smooth',block:'start'});
}

function limparVisita() {
  document.querySelectorAll('#section-visita input,#section-visita select,#section-visita textarea').forEach(e=>e.value='');
  document.getElementById('rv-servicos-list').innerHTML='';
  document.getElementById('rv-pecas-list').innerHTML='';
  rvFotos=[]; rvServNum=0; rvPecaNum=0;
  renderFotosVisita();
  limparSigCliente();
  document.getElementById('visita-preview').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OR√áAMENTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let orcMdoNum=0, orcMatNum=0;

function addMDO() {
  orcMdoNum++;
  const d = document.createElement('div');
  d.className='equip-card'; d.id='mdo-'+orcMdoNum;
  d.innerHTML=`<div class="equip-num" style="color:#ffd700;">M√ÉO DE OBRA #${String(orcMdoNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="document.getElementById('mdo-${orcMdoNum}').remove();calcOrc()">‚úï</button>
    <div class="form-grid three">
      <div class="field span2"><label>Descri√ß√£o do Servi√ßo</label><input type="text" class="mdo-desc" placeholder="Ex: Manuten√ß√£o preventiva completa"></div>
      <div class="field"><label>Qtd / Horas</label><input type="number" class="mdo-qtd" value="1" min="0" step="0.5" oninput="calcOrc()"></div>
      <div class="field"><label>Valor Unit√°rio (R$)</label><input type="number" class="mdo-val" placeholder="200.00" step="0.01" oninput="calcOrc()"></div>
    </div>`;
  document.getElementById('orc-mdo-list').appendChild(d);
  calcOrc();
}

function addMaterial() {
  orcMatNum++;
  const d = document.createElement('div');
  d.className='equip-card'; d.id='mat-'+orcMatNum;
  d.innerHTML=`<div class="equip-num" style="color:#ffd700;">MATERIAL #${String(orcMatNum).padStart(2,'0')}</div>
    <button class="remove-equip" onclick="document.getElementById('mat-${orcMatNum}').remove();calcOrc()">‚úï</button>
    <div class="form-grid three">
      <div class="field span2"><label>Descri√ß√£o</label><input type="text" class="mat-desc" placeholder="Ex: Fluido R-410A 1kg"></div>
      <div class="field"><label>Quantidade</label><input type="number" class="mat-qtd" value="1" min="0" step="0.5" oninput="calcOrc()"></div>
      <div class="field"><label>Valor Unit√°rio (R$)</label><input type="number" class="mat-val" placeholder="80.00" step="0.01" oninput="calcOrc()"></div>
    </div>`;
  document.getElementById('orc-mat-list').appendChild(d);
  calcOrc();
}

function fmtR(v) { return 'R$ '+parseFloat(v||0).toFixed(2).replace('.',','); }

function calcOrc() {
  const n = id => parseFloat(document.getElementById(id)?.value||0)||0;
  const km = n('orc_km') * n('orc_km_val');
  const visita = n('orc_visita_val');
  const pedagio = n('orc_pedagio');
  const desl = km + visita + pedagio;

  let mdo=0;
  document.querySelectorAll('[id^="mdo-"]').forEach(c=>{ mdo += (parseFloat(c.querySelector('.mdo-qtd').value)||0)*(parseFloat(c.querySelector('.mdo-val').value)||0); });
  let mat=0;
  document.querySelectorAll('[id^="mat-"]').forEach(c=>{ mat += (parseFloat(c.querySelector('.mat-qtd').value)||0)*(parseFloat(c.querySelector('.mat-val').value)||0); });

  const subtotal = desl + mdo + mat;
  const desc = n('orc_desc');
  const total = Math.max(0, subtotal - desc);

  const el = document.getElementById('orc-resumo');
  if(!el) return;
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr auto;gap:0.3rem;line-height:2;">
      <span style="color:var(--text2);">Deslocamento / Visita</span><span style="color:var(--text);text-align:right;">${fmtR(desl)}</span>
      <span style="color:var(--text2);">M√£o de Obra</span><span style="color:var(--text);text-align:right;">${fmtR(mdo)}</span>
      <span style="color:var(--text2);">Materiais / Pe√ßas</span><span style="color:var(--text);text-align:right;">${fmtR(mat)}</span>
      <span style="color:var(--text2);">Subtotal</span><span style="color:var(--text);text-align:right;">${fmtR(subtotal)}</span>
      <span style="color:#ff6b35;">Desconto</span><span style="color:#ff6b35;text-align:right;">- ${fmtR(desc)}</span>
      <span style="font-size:1rem;font-weight:700;color:#ffd700;border-top:1px solid var(--border);padding-top:0.3rem;">TOTAL</span>
      <span style="font-size:1rem;font-weight:700;color:#ffd700;border-top:1px solid var(--border);padding-top:0.3rem;text-align:right;">${fmtR(total)}</span>
    </div>`;
}

function gerarOrcamento() {
  const g = id => document.getElementById(id)?.value||'‚Äî';
  const dataF = d => { if(!d||d==='‚Äî')return'‚Äî'; const[a,m,dia]=d.split('-'); return`${dia}/${m}/${a}`; };
  let cfg={empresa:'',cnpj:'',cor:'#0d3b6e'}; try{ const r=localStorage.getItem('techar_config'); if(r) Object.assign(cfg,JSON.parse(r)); }catch(e){}
  const header = gerarHeaderHTML(cfg, logoDataURL);
  const cor = cfg.cor||'#0d3b6e';

  const n = id => parseFloat(document.getElementById(id)?.value||0)||0;
  const km = n('orc_km')*n('orc_km_val'), visita=n('orc_visita_val'), pedagio=n('orc_pedagio'), desl=km+visita+pedagio;
  let mdoRows='', mdo=0;
  document.querySelectorAll('[id^="mdo-"]').forEach((c,i)=>{ const q=parseFloat(c.querySelector('.mdo-qtd').value)||0, v=parseFloat(c.querySelector('.mdo-val').value)||0, t=q*v; mdo+=t; mdoRows+=`<tr style="background:${i%2===0?'#fff':'#fafafa'}"><td style="padding:5px 8px;">${c.querySelector('.mdo-desc').value||'‚Äî'}</td><td style="text-align:center;padding:5px 8px;">${q}</td><td style="text-align:right;padding:5px 8px;">${fmtR(v)}</td><td style="text-align:right;padding:5px 8px;font-weight:bold;">${fmtR(t)}</td></tr>`; });
  let matRows='', mat=0;
  document.querySelectorAll('[id^="mat-"]').forEach((c,i)=>{ const q=parseFloat(c.querySelector('.mat-qtd').value)||0, v=parseFloat(c.querySelector('.mat-val').value)||0, t=q*v; mat+=t; matRows+=`<tr style="background:${i%2===0?'#fff':'#fafafa'}"><td style="padding:5px 8px;">${c.querySelector('.mat-desc').value||'‚Äî'}</td><td style="text-align:center;padding:5px 8px;">${q}</td><td style="text-align:right;padding:5px 8px;">${fmtR(v)}</td><td style="text-align:right;padding:5px 8px;font-weight:bold;">${fmtR(t)}</td></tr>`; });
  const subtotal=desl+mdo+mat, desc=n('orc_desc'), total=Math.max(0,subtotal-desc);
  const thS=`style="background:${cor};color:white;padding:5px 8px;text-align:left;"`;

  const html=`<div style="font-family:serif;color:#111;">
    ${header}
    <h2 style="text-align:center;font-size:1.1rem;text-transform:uppercase;color:${cor};margin-bottom:0.2rem;letter-spacing:1px;">Or√ßamento de Servi√ßos</h2>
    <div style="text-align:center;font-size:0.75rem;color:#777;border-bottom:2px solid ${cor};padding-bottom:0.5rem;margin-bottom:1rem;">N¬∫ ${g('orc_num')} ¬∑ Emiss√£o: ${dataF(g('orc_data'))} ¬∑ Validade: ${g('orc_val')}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;margin-bottom:1rem;font-size:0.8rem;">
      <div style="border:1px solid #ddd;padding:0.7rem;border-radius:4px;">
        <div style="font-weight:bold;font-size:0.7rem;background:#f5f5f5;padding:0.2rem 0.5rem;margin:-0.7rem -0.7rem 0.5rem;color:${cor};">CLIENTE</div>
        <div><strong>${g('orc_cliente')}</strong></div>
        <div>CNPJ/CPF: ${g('orc_cnpj')}</div>
        <div>${g('orc_end')}</div>
        <div>${g('orc_tel')} ¬∑ ${g('orc_email')}</div>
      </div>
      <div style="border:1px solid #ddd;padding:0.7rem;border-radius:4px;">
        <div style="font-weight:bold;font-size:0.7rem;background:#f5f5f5;padding:0.2rem 0.5rem;margin:-0.7rem -0.7rem 0.5rem;color:${cor};">SERVI√áO / DESTINO</div>
        <div><strong>${g('orc_tipo')}</strong></div>
        <div>Destino: ${g('orc_dest')}</div>
        <div>Pagamento: ${g('orc_pgto')}</div>
      </div>
    </div>
    ${desl>0?`<div style="margin-bottom:0.8rem;"><div style="background:${cor};color:white;padding:0.3rem 0.8rem;font-weight:bold;font-size:0.76rem;">DESLOCAMENTO / VISITA T√âCNICA</div><table style="width:100%;border-collapse:collapse;font-size:0.78rem;"><thead><tr><th ${thS}>Item</th><th ${thS} style="text-align:right;">Valor</th></tr></thead><tbody>${n('orc_km_val')>0?`<tr><td style="padding:4px 8px;">Km rodado (${n('orc_km')} km √ó ${fmtR(n('orc_km_val'))}/km)</td><td style="text-align:right;padding:4px 8px;">${fmtR(km)}</td></tr>`:''} ${n('orc_visita_val')>0?`<tr><td style="padding:4px 8px;">Taxa de visita t√©cnica</td><td style="text-align:right;padding:4px 8px;">${fmtR(visita)}</td></tr>`:''} ${n('orc_pedagio')>0?`<tr><td style="padding:4px 8px;">Ped√°gio / Estacionamento</td><td style="text-align:right;padding:4px 8px;">${fmtR(pedagio)}</td></tr>`:''}</tbody></table></div>`:''}
    ${mdoRows?`<div style="margin-bottom:0.8rem;"><div style="background:${cor};color:white;padding:0.3rem 0.8rem;font-weight:bold;font-size:0.76rem;">M√ÉO DE OBRA</div><table style="width:100%;border-collapse:collapse;font-size:0.78rem;"><thead><tr><th ${thS}>Servi√ßo</th><th ${thS} style="text-align:center;">Qtd</th><th ${thS} style="text-align:right;">Unit.</th><th ${thS} style="text-align:right;">Total</th></tr></thead><tbody>${mdoRows}</tbody></table></div>`:''}
    ${matRows?`<div style="margin-bottom:0.8rem;"><div style="background:${cor};color:white;padding:0.3rem 0.8rem;font-weight:bold;font-size:0.76rem;">MATERIAIS / PE√áAS</div><table style="width:100%;border-collapse:collapse;font-size:0.78rem;"><thead><tr><th ${thS}>Item</th><th ${thS} style="text-align:center;">Qtd</th><th ${thS} style="text-align:right;">Unit.</th><th ${thS} style="text-align:right;">Total</th></tr></thead><tbody>${matRows}</tbody></table></div>`:''}
    <div style="margin-left:auto;max-width:280px;margin-bottom:1rem;">
      <table style="width:100%;font-size:0.82rem;border-collapse:collapse;">
        <tr><td style="padding:4px 8px;color:#555;">Subtotal</td><td style="text-align:right;padding:4px 8px;">${fmtR(subtotal)}</td></tr>
        ${desc>0?`<tr><td style="padding:4px 8px;color:#c62828;">Desconto</td><td style="text-align:right;padding:4px 8px;color:#c62828;">- ${fmtR(desc)}</td></tr>`:''}
        <tr style="background:${cor};color:white;"><td style="padding:6px 8px;font-weight:bold;font-size:1rem;">TOTAL</td><td style="text-align:right;padding:6px 8px;font-weight:bold;font-size:1rem;">${fmtR(total)}</td></tr>
      </table>
    </div>
    ${g('orc_obs')!=='‚Äî'?`<div style="background:#f9f9f9;border:1px solid #ddd;padding:0.6rem;font-size:0.75rem;line-height:1.6;margin-bottom:1rem;"><strong>Condi√ß√µes:</strong> ${g('orc_obs')}</div>`:''}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;text-align:center;font-size:0.78rem;margin-top:1.5rem;">
      <div><div style="border-top:1px solid #333;margin-top:2.5rem;padding-top:0.3rem;"><strong>${cfg.empresa||'Empresa'}</strong><br>Respons√°vel pelo Or√ßamento<br>Data: ${dataF(g('orc_data'))}</div></div>
      <div><div style="border-top:1px solid #333;margin-top:2.5rem;padding-top:0.3rem;"><strong>${g('orc_cliente')}</strong><br>Aprova√ß√£o do Cliente<br>Data: ___/___/______</div></div>
    </div>
  </div>`;

  document.getElementById('orcamento-content').innerHTML = html;
  document.getElementById('orcamento-preview').classList.add('show');
  document.getElementById('orcamento-preview').scrollIntoView({behavior:'smooth',block:'start'});
}

function limparOrcamento() {
  document.querySelectorAll('#section-orcamento input,#section-orcamento select,#section-orcamento textarea').forEach(e=>e.value='');
  document.getElementById('orc-mdo-list').innerHTML='';
  document.getElementById('orc-mat-list').innerHTML='';
  orcMdoNum=0; orcMatNum=0;
  document.getElementById('orc-resumo').innerHTML='';
  document.getElementById('orcamento-preview').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// C√ÅLCULO DE CARGA T√âRMICA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ctAmbientes = [];

function calcCarga() {
  const n = id => parseFloat(document.getElementById(id)?.value||0)||0;
  const s = id => document.getElementById(id)?.value||'1.0';

  const area = n('ct_larg') * n('ct_comp');
  const volume = area * n('ct_pe');
  if(area <= 0) { document.getElementById('ct-resultado').innerHTML='<span style="color:var(--text2);font-size:0.82rem;">Preencha as dimens√µes do ambiente para calcular.</span>'; return; }

  const cobF  = parseFloat(s('ct_cob'));
  const solF  = parseFloat(s('ct_sol'));
  const usoF  = parseFloat(s('ct_uso'));
  const climF = parseFloat(s('ct_clima'));

  // Carga pelo envelope (√°rea + cobertura + solar)
  const cargaEnvelope = area * 50 * cobF * solF; // 50 BTU/h¬∑m¬≤ base
  // Cargas internas
  const cargaPessoas  = n('ct_pessoas') * 400;   // ~400 BTU/h por pessoa
  const cargaEquips   = n('ct_equips') * 3.41;   // W ‚Üí BTU/h
  const cargaLuz      = n('ct_luz') * 3.41;
  const cargaJanelas  = n('ct_janelas') * 200;   // ~200 BTU/h¬∑m¬≤

  const totalBruto = (cargaEnvelope + cargaPessoas + cargaEquips + cargaLuz + cargaJanelas) * usoF * climF;
  const totalBTU   = Math.ceil(totalBruto / 1000) * 1000; // arredondar para cima em mil

  // Sugest√£o de equipamento
  const sugestoes = [7000,9000,12000,18000,24000,30000,36000,48000,60000];
  const sugerido = sugestoes.find(s => s >= totalBTU) || 60000;
  const qtd = sugerido < totalBTU ? Math.ceil(totalBTU/sugerido) : 1;

  const el = document.getElementById('ct-resultado');
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:0.8rem;text-align:center;">
        <div style="font-size:0.65rem;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.3rem;">Carga Calculada</div>
        <div style="font-family:'DM Serif Display';font-size:1.8rem;color:var(--accent);">${totalBTU.toLocaleString()}</div>
        <div style="font-size:0.72rem;color:var(--text2);">BTU/h</div>
      </div>
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:0.8rem;text-align:center;">
        <div style="font-size:0.65rem;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.3rem;">Equipamento Sugerido</div>
        <div style="font-family:'DM Serif Display';font-size:1.4rem;color:#ffd700;">${qtd > 1 ? qtd+'√ó' : ''}${sugerido.toLocaleString()}</div>
        <div style="font-size:0.72rem;color:var(--text2);">BTU/h${qtd>1?' ('+qtd+' unidades)':''}</div>
      </div>
    </div>
    <div style="font-size:0.78rem;color:var(--text2);border-top:1px solid var(--border);padding-top:0.8rem;">
      <div style="display:grid;grid-template-columns:1fr auto;gap:0.3rem;line-height:1.9;">
        <span>√Årea do ambiente</span><span style="color:var(--text);">${area.toFixed(1)} m¬≤ ¬∑ Vol. ${volume.toFixed(1)} m¬≥</span>
        <span>Carga pelo envelope (parede/teto/solar)</span><span style="color:var(--text);">${Math.round(cargaEnvelope).toLocaleString()} BTU/h</span>
        <span>Pessoas (${n('ct_pessoas')})</span><span style="color:var(--text);">${Math.round(cargaPessoas).toLocaleString()} BTU/h</span>
        <span>Equipamentos (${n('ct_equips')}W)</span><span style="color:var(--text);">${Math.round(cargaEquips).toLocaleString()} BTU/h</span>
        <span>Ilumina√ß√£o (${n('ct_luz')}W)</span><span style="color:var(--text);">${Math.round(cargaLuz).toLocaleString()} BTU/h</span>
        <span>Janelas (${n('ct_janelas')} m¬≤)</span><span style="color:var(--text);">${Math.round(cargaJanelas).toLocaleString()} BTU/h</span>
        <span style="color:var(--text2);font-size:0.7rem;">Fatores: Cobertura √ó${cobF} ¬∑ Solar √ó${solF} ¬∑ Uso √ó${usoF} ¬∑ Clima √ó${climF}</span><span></span>
      </div>
    </div>
    <div style="margin-top:0.8rem;background:rgba(255,215,0,0.06);border:1px solid rgba(255,215,0,0.15);border-radius:6px;padding:0.5rem 0.8rem;font-size:0.72rem;color:#ffd700;">
      ‚ö† C√°lculo estimativo pelo m√©todo simplificado. Para projetos cr√≠ticos, utilize o m√©todo ASHRAE completo com levantamento detalhado de cargas.
    </div>`;
}

function salvarAmbiente() {
  const n = id => parseFloat(document.getElementById(id)?.value||0)||0;
  const g = id => document.getElementById(id)?.value||'';
  const area = n('ct_larg') * n('ct_comp');
  if(area <= 0) { alert('Preencha as dimens√µes do ambiente primeiro.'); return; }
  const cobF=parseFloat(g('ct_cob')), solF=parseFloat(g('ct_sol')), usoF=parseFloat(g('ct_uso')), climF=parseFloat(g('ct_clima'));
  const totalBruto = (area*50*cobF*solF + n('ct_pessoas')*400 + n('ct_equips')*3.41 + n('ct_luz')*3.41 + n('ct_janelas')*200) * usoF * climF;
  const totalBTU = Math.ceil(totalBruto/1000)*1000;
  ctAmbientes.push({ nome: g('ct_nome')||`Ambiente ${ctAmbientes.length+1}`, area, btu: totalBTU });
  renderAmbientesSalvos();
}

function renderAmbientesSalvos() {
  const el = document.getElementById('ct-ambientes-salvos');
  if(ctAmbientes.length === 0) { el.innerHTML=''; return; }
  const totalGeral = ctAmbientes.reduce((s,a)=>s+a.btu,0);
  let rows = ctAmbientes.map((a,i)=>`<tr style="background:${i%2===0?'var(--bg3)':'var(--bg2)'};">
    <td style="padding:6px 8px;">${a.nome}</td>
    <td style="padding:6px 8px;text-align:center;">${a.area.toFixed(1)} m¬≤</td>
    <td style="padding:6px 8px;text-align:right;color:var(--accent);">${a.btu.toLocaleString()} BTU/h</td>
    <td style="padding:6px 8px;text-align:center;"><button onclick="ctAmbientes.splice(${i},1);renderAmbientesSalvos();" style="background:none;border:none;color:var(--accent3);cursor:pointer;font-size:0.8rem;">‚úï</button></td>
  </tr>`).join('');
  el.innerHTML=`<table style="width:100%;border-collapse:collapse;font-size:0.8rem;"><thead><tr style="background:var(--bg3);"><th style="padding:6px 8px;text-align:left;">Ambiente</th><th style="padding:6px 8px;text-align:center;">√Årea</th><th style="padding:6px 8px;text-align:right;">Carga</th><th></th></tr></thead><tbody>${rows}</tbody><tfoot><tr style="border-top:1px solid var(--border);"><td colspan="2" style="padding:6px 8px;font-weight:600;">TOTAL GERAL</td><td style="padding:6px 8px;text-align:right;font-weight:700;color:var(--accent);font-size:0.9rem;">${totalGeral.toLocaleString()} BTU/h</td><td></td></tr></tfoot></table>`;
}

function gerarRelatorioCarga() {
  let cfg={empresa:'',cor:'#0d3b6e'}; try{ const r=localStorage.getItem('techar_config'); if(r) Object.assign(cfg,JSON.parse(r)); }catch(e){}
  const header = gerarHeaderHTML(cfg, logoDataURL);
  const cor = cfg.cor||'#0d3b6e';
  const today2 = new Date().toLocaleDateString('pt-BR');

  let rows=''; ctAmbientes.forEach((a,i)=>{ rows+=`<tr style="background:${i%2===0?'#fff':'#f9f9f9'}"><td style="padding:5px 8px;">${a.nome}</td><td style="text-align:center;padding:5px 8px;">${a.area.toFixed(1)} m¬≤</td><td style="text-align:right;padding:5px 8px;font-weight:bold;">${a.btu.toLocaleString()} BTU/h</td><td style="text-align:right;padding:5px 8px;color:#555;">${(a.btu/12000).toFixed(1)} TR</td></tr>`; });
  const totalGeral = ctAmbientes.reduce((s,a)=>s+a.btu,0);

  const html=`<div style="font-family:serif;color:#111;">${header}
    <h2 style="text-align:center;font-size:1.1rem;text-transform:uppercase;color:${cor};letter-spacing:1px;margin-bottom:0.2rem;">Relat√≥rio de C√°lculo de Carga T√©rmica</h2>
    <div style="text-align:center;font-size:0.75rem;color:#777;border-bottom:2px solid ${cor};padding-bottom:0.5rem;margin-bottom:1rem;">M√©todo Simplificado ¬∑ Data: ${today2}</div>
    ${ctAmbientes.length>0?`<table style="width:100%;border-collapse:collapse;font-size:0.82rem;margin-bottom:1rem;"><thead><tr style="background:${cor};color:white;"><th style="padding:5px 8px;text-align:left;">Ambiente</th><th style="padding:5px 8px;text-align:center;">√Årea</th><th style="padding:5px 8px;text-align:right;">Carga (BTU/h)</th><th style="padding:5px 8px;text-align:right;">TR</th></tr></thead><tbody>${rows}</tbody><tfoot><tr style="background:${cor};color:white;"><td colspan="2" style="padding:6px 8px;font-weight:bold;">TOTAL GERAL</td><td style="padding:6px 8px;text-align:right;font-weight:bold;">${totalGeral.toLocaleString()} BTU/h</td><td style="padding:6px 8px;text-align:right;font-weight:bold;">${(totalGeral/12000).toFixed(1)} TR</td></tr></tfoot></table>`:'<p style="color:#999;text-align:center;padding:1rem;">Nenhum ambiente salvo.</p>'}
    <div style="background:#f9f9f9;border:1px solid #ddd;padding:0.7rem;font-size:0.72rem;color:#555;line-height:1.6;margin-top:1rem;">
      <strong>Nota T√©cnica:</strong> Este relat√≥rio apresenta estimativa pelo m√©todo simplificado baseado em cargas t√≠picas por √°rea, pessoas, equipamentos, ilumina√ß√£o e fator solar. Para projetos que exijam maior precis√£o, recomenda-se o uso do m√©todo ASHRAE completo com levantamento detalhado de todas as cargas.
    </div>
  </div>`;

  document.getElementById('carga-content').innerHTML = html;
  document.getElementById('carga-preview').classList.add('show');
  document.getElementById('carga-preview').scrollIntoView({behavior:'smooth',block:'start'});
}

function limparCarga() {
  document.querySelectorAll('#section-carga input,#section-carga select').forEach(e=>e.value='');
  ctAmbientes=[];
  renderAmbientesSalvos();
  document.getElementById('ct-resultado').innerHTML='';
  document.getElementById('carga-preview').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HIST√ìRICO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let histClientes=[], histEquips=[], histAtends=[];

function loadHist() {
  try { histClientes=JSON.parse(localStorage.getItem('th_clientes')||'[]'); } catch(e){histClientes=[];}
  try { histEquips  =JSON.parse(localStorage.getItem('th_equips')||'[]');   } catch(e){histEquips=[];}
  try { histAtends  =JSON.parse(localStorage.getItem('th_atends')||'[]');   } catch(e){histAtends=[];}
  renderHistorico();
}
function saveHist() {
  try { localStorage.setItem('th_clientes',JSON.stringify(histClientes)); localStorage.setItem('th_equips',JSON.stringify(histEquips)); localStorage.setItem('th_atends',JSON.stringify(histAtends)); } catch(e){}
}
function abrirModalCliente() { document.getElementById('modal-cliente').style.display='flex'; }
function abrirModalEquip() {
  const sel=document.getElementById('he_cliente'); sel.innerHTML='<option value="">Selecione o cliente</option>';
  histClientes.forEach(c=>sel.innerHTML+=`<option value="${c.id}">${c.nome}</option>`);
  document.getElementById('modal-equip').style.display='flex';
}
function abrirModalAtend() {
  const sc=document.getElementById('ha_cliente'); sc.innerHTML='<option value="">Selecione</option>';
  histClientes.forEach(c=>sc.innerHTML+=`<option value="${c.id}">${c.nome}</option>`);
  const se=document.getElementById('ha_equip'); se.innerHTML='<option value="">Selecione</option>';
  histEquips.forEach(e=>se.innerHTML+=`<option value="${e.id}">${e.tag} ‚Äî ${e.modelo}</option>`);
  document.getElementById('modal-atend').style.display='flex';
}
function fecharModais() { ['modal-cliente','modal-equip','modal-atend'].forEach(id=>document.getElementById(id).style.display='none'); }
function salvarCliente() {
  const g=id=>document.getElementById(id)?.value||'';
  if(!g('hc_nome')){ alert('Informe o nome do cliente.'); return; }
  histClientes.push({id:Date.now(),nome:g('hc_nome'),cnpj:g('hc_cnpj'),end:g('hc_end'),tel:g('hc_tel'),email:g('hc_email'),obs:g('hc_obs')});
  saveHist(); renderHistorico(); fecharModais();
  ['hc_nome','hc_cnpj','hc_end','hc_tel','hc_email','hc_obs'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
}
function salvarEquipHist() {
  const g=id=>document.getElementById(id)?.value||'';
  if(!g('he_tag')){ alert('Informe o TAG do equipamento.'); return; }
  histEquips.push({id:Date.now(),tag:g('he_tag'),clienteId:g('he_cliente'),modelo:g('he_modelo'),serie:g('he_serie'),inst:g('he_inst'),local:g('he_local')});
  saveHist(); renderHistorico(); fecharModais();
  ['he_tag','he_modelo','he_serie','he_inst','he_local'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
}
function salvarAtend() {
  const g=id=>document.getElementById(id)?.value||'';
  histAtends.unshift({id:Date.now(),data:g('ha_data'),clienteId:g('ha_cliente'),equipId:g('ha_equip'),tipo:g('ha_tipo'),desc:g('ha_desc'),prox:g('ha_prox')});
  saveHist(); renderHistorico(); fecharModais();
  ['ha_data','ha_desc','ha_prox'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
}
function clienteNome(id) { return histClientes.find(c=>c.id==id)?.nome||'‚Äî'; }
function equipTag(id)    { return histEquips.find(e=>e.id==id)?.tag||'‚Äî'; }
function dataF2(d) { if(!d)return'‚Äî'; const[a,m,dia]=d.split('-'); return`${dia}/${m}/${a}`; }

function renderHistorico(filtro='') {
  const q = (filtro||document.getElementById('hist_busca')?.value||'').toLowerCase();

  // Clientes
  const elC = document.getElementById('hist-clientes-list');
  const clientes = q ? histClientes.filter(c=>c.nome.toLowerCase().includes(q)||c.cnpj?.includes(q)) : histClientes;
  if(clientes.length===0) { elC.innerHTML=`<div style="padding:1rem;color:var(--text3);font-size:0.82rem;">Nenhum cliente cadastrado.</div>`; }
  else elC.innerHTML = clientes.map(c=>`
    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0.9rem;margin-bottom:0.7rem;display:flex;align-items:center;gap:0.8rem;">
      <div style="width:36px;height:36px;border-radius:50%;background:rgba(180,120,255,0.15);border:1px solid rgba(180,120,255,0.3);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;">üë§</div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;font-size:0.88rem;">${c.nome}</div>
        <div style="font-size:0.72rem;color:var(--text2);">${c.cnpj||''} ${c.tel?'¬∑ '+c.tel:''} ${c.email?'¬∑ '+c.email:''}</div>
        ${c.end?`<div style="font-size:0.7rem;color:var(--text3);">${c.end}</div>`:''}
      </div>
      <button onclick="histClientes=histClientes.filter(x=>x.id!=${c.id});saveHist();renderHistorico();" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:1rem;flex-shrink:0;" title="Excluir">üóë</button>
    </div>`).join('');

  // Equipamentos
  const elE = document.getElementById('hist-equips-list');
  const equips = q ? histEquips.filter(e=>e.tag.toLowerCase().includes(q)||e.modelo?.toLowerCase().includes(q)) : histEquips;
  if(equips.length===0) { elE.innerHTML=`<div style="padding:1rem;color:var(--text3);font-size:0.82rem;">Nenhum equipamento cadastrado.</div>`; }
  else elE.innerHTML = equips.map(e=>`
    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0.9rem;margin-bottom:0.7rem;display:flex;align-items:center;gap:0.8rem;">
      <div style="width:36px;height:36px;border-radius:50%;background:rgba(0,212,170,0.1);border:1px solid rgba(0,212,170,0.2);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;">‚ùÑÔ∏è</div>
      <div style="flex:1;">
        <div style="font-weight:600;font-size:0.88rem;"><span style="color:var(--accent);font-family:'DM Mono';">${e.tag}</span> ‚Äî ${e.modelo||'‚Äî'}</div>
        <div style="font-size:0.72rem;color:var(--text2);">Cliente: ${clienteNome(e.clienteId)} ¬∑ S√©rie: ${e.serie||'‚Äî'} ¬∑ Local: ${e.local||'‚Äî'}</div>
        ${e.inst?`<div style="font-size:0.7rem;color:var(--text3);">Instalado em: ${dataF2(e.inst)}</div>`:''}
      </div>
      <button onclick="histEquips=histEquips.filter(x=>x.id!=${e.id});saveHist();renderHistorico();" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:1rem;" title="Excluir">üóë</button>
    </div>`).join('');

  // Atendimentos
  const elA = document.getElementById('hist-atend-list');
  const atends = q ? histAtends.filter(a=>clienteNome(a.clienteId).toLowerCase().includes(q)||equipTag(a.equipId).toLowerCase().includes(q)) : histAtends;
  if(atends.length===0) { elA.innerHTML=`<div style="padding:1rem;color:var(--text3);font-size:0.82rem;">Nenhum atendimento registrado.</div>`; }
  else elA.innerHTML = atends.map(a=>`
    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0.9rem;margin-bottom:0.7rem;">
      <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.4rem;">
        <span style="font-family:'DM Mono';font-size:0.68rem;background:rgba(0,212,170,0.1);color:var(--accent);padding:0.15rem 0.5rem;border-radius:4px;">${dataF2(a.data)}</span>
        <span style="font-size:0.75rem;color:var(--text2);">${a.tipo}</span>
        <button onclick="histAtends=histAtends.filter(x=>x.id!=${a.id});saveHist();renderHistorico();" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:0.9rem;margin-left:auto;" title="Excluir">üóë</button>
      </div>
      <div style="font-size:0.84rem;font-weight:600;">${clienteNome(a.clienteId)} <span style="color:var(--accent);font-family:'DM Mono';">¬∑ ${equipTag(a.equipId)}</span></div>
      ${a.desc?`<div style="font-size:0.78rem;color:var(--text2);margin-top:0.3rem;">${a.desc}</div>`:''}
      ${a.prox?`<div style="font-size:0.72rem;color:#ffd700;margin-top:0.3rem;">üìÖ Pr√≥ximo atendimento: ${dataF2(a.prox)}</div>`:''}
    </div>`).join('');
}

function filtrarHistorico() { renderHistorico(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENVIAR POR WHATSAPP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function enviarWA(tipo) {
  const g = id => document.getElementById(id)?.value || '';
  const dataF = d => { if(!d) return ''; const[a,m,dia]=d.split('-'); return `${dia}/${m}/${a}`; };

  let cfg = { empresa: '', tel: '', cor: '#0d3b6e' };
  try { const r = localStorage.getItem('techar_config'); if(r) Object.assign(cfg, JSON.parse(r)); } catch(e) {}

  const empresa = cfg.empresa || 'TechAr Engenharia';
  let msg = '';

  if (tipo === 'laudo') {
    const cliente = g('l_cliente') || 'Cliente';
    const num = g('l_numero') || '';
    const data = dataF(g('l_data'));
    const equip = `${g('l_fab')} ${g('l_modelo')} ${g('l_btu')}`.trim();
    msg = `Ol√°, ${cliente}! üëã

Segue o *Laudo T√©cnico de Instala√ß√£o${num ? ' N¬∫ ' + num : ''}* referente ao servi√ßo realizado em ${data}.

üìã *Equipamento:* ${equip || 'conforme laudo'}
üîß *Respons√°vel:* ${g('l_eng')}

Para visualizar o laudo completo, abra o arquivo enviado ou solicite o envio por e-mail.

Qualquer d√∫vida, estou √† disposi√ß√£o! ‚úÖ

_${empresa}_`;

  } else if (tipo === 'visita') {
    const cliente = g('rv_cliente') || 'Cliente';
    const num = g('rv_num') || '';
    const data = dataF(g('rv_data'));
    const sit = g('rv_sit') || '';
    const sitEmoji = sit.includes('pleno') ? '‚úÖ' : sit.includes('Parado') ? 'üî¥' : '‚ö†Ô∏è';
    msg = `Ol√°, ${cliente}! üëã

Segue o *Relat√≥rio de Visita T√©cnica${num ? ' N¬∫ ' + num : ''}* ‚Äî ${data}.

${sitEmoji} *Situa√ß√£o:* ${sit || 'conforme relat√≥rio'}
üîß *T√©cnico:* ${g('rv_tec')}
üìç *Equipamento:* ${g('rv_equip') || 'conforme relat√≥rio'}

O relat√≥rio completo com todos os servi√ßos realizados e fotos est√° em anexo.

Obrigado pela confian√ßa! üôè

_${empresa}_`;

  } else if (tipo === 'orcamento') {
    const cliente = g('orc_cliente') || 'Cliente';
    const num = g('orc_num') || '';
    const val = g('orc_val') || '30 dias';
    // Calculate total from DOM
    let total = 0;
    try {
      const resumo = document.getElementById('orc-resumo')?.innerText || '';
      const match = resumo.match(/TOTAL[^R]*R\$\s*([\d.,]+)/i);
      if (match) total = match[1];
    } catch(e) {}
    msg = `Ol√°, ${cliente}! üëã

Segue o *Or√ßamento${num ? ' N¬∫ ' + num : ''}* para o servi√ßo de *${g('orc_tipo')}*.

${total ? 'üí∞ *Valor Total:* R$ ' + total + '\n' : ''}üìÖ *Validade:* ${val}
üí≥ *Pagamento:* ${g('orc_pgto')}

Para aprova√ß√£o, basta responder confirmando ou entrar em contato.

Fico √† disposi√ß√£o para esclarecimentos! üòä

_${empresa}_`;

  } else if (tipo === 'pmoc') {
    const local = g('p_local') || 'estabelecimento';
    msg = `Ol√°! üëã

Segue o *PMOC ‚Äî Plano de Manuten√ß√£o, Opera√ß√£o e Controle* para *${local}*.

üìã O documento contempla todas as atividades preventivas, cronograma anual e registros de execu√ß√£o, conforme exigido pela *Lei 13.589/2018* e *Portaria MS 3.523/1998*.

_${empresa}_`;

  } else if (tipo === 'odonto') {
    const local = g('od_local') || 'estabelecimento';
    msg = `Ol√°! üëã

Segue o *PMOC ‚Äî Estabelecimento de Sa√∫de* para *${local}*.

üìã Documento elaborado em conformidade com a *RDC ANVISA n¬∫ 50/2002*, Lei 13.589/2018 e Portaria MS 3.523/1998.

_${empresa}_`;

  } else if (tipo === 'checklist') {
    const local = g('c_local') || 'equipamento';
    const data = dataF(g('c_data'));
    msg = `Ol√°! üëã

Segue o *Relat√≥rio de Vistoria* de ${local}${data ? ' ‚Äî ' + data : ''}.

‚úÖ O checklist completo com todos os itens verificados est√° em anexo.

_${empresa}_`;

  } else if (tipo === 'carga') {
    msg = `Ol√°! üëã

Segue o *Relat√≥rio de C√°lculo de Carga T√©rmica* com o dimensionamento do sistema de climatiza√ß√£o.

‚ùÑÔ∏è O documento apresenta a capacidade necess√°ria por ambiente e o total geral do projeto.

_${empresa}_`;
  }

  // Show phone input modal
  mostrarModalWA(msg);
}

let _waMsgPendente = '';

function mostrarModalWA(msg) {
  _waMsgPendente = msg;
  let modal = document.getElementById('wa-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'wa-modal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9000;display:flex;align-items:flex-end;justify-content:center;';
    modal.innerHTML = `
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px 16px 0 0;padding:1.5rem;width:100%;max-width:500px;animation:slideUp 0.3s ease;">
        <div style="display:flex;align-items:center;gap:0.7rem;margin-bottom:1.2rem;">
          <div style="width:36px;height:36px;background:#25D366;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">üì≤</div>
          <div>
            <div style="font-weight:600;font-size:0.9rem;">Enviar por WhatsApp</div>
            <div style="font-size:0.72rem;color:var(--text2);">Informe o n√∫mero com DDD</div>
          </div>
        </div>
        <div style="margin-bottom:1rem;">
          <label style="font-size:0.78rem;color:var(--text2);display:block;margin-bottom:0.4rem;">N√∫mero do destinat√°rio</label>
          <input id="wa-tel-input" type="tel" placeholder="(11) 99999-9999" 
            style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0.7rem 1rem;color:var(--text);font-size:0.9rem;font-family:'Sora';"
            oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        </div>
        <div style="margin-bottom:1.2rem;">
          <label style="font-size:0.78rem;color:var(--text2);display:block;margin-bottom:0.4rem;">Pr√©via da mensagem</label>
          <textarea id="wa-msg-preview" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0.7rem;color:var(--text2);font-size:0.75rem;font-family:'Sora';min-height:120px;resize:vertical;line-height:1.5;">${_waMsgPendente}</textarea>
        </div>
        <div style="display:flex;gap:0.7rem;">
          <button onclick="confirmarWA()" style="flex:1;background:#25D366;border:none;color:#fff;padding:0.8rem;border-radius:10px;font-family:'Sora';font-weight:600;font-size:0.88rem;cursor:pointer;">
            üì≤ Abrir WhatsApp
          </button>
          <button onclick="document.getElementById('wa-modal').remove()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:0.8rem 1.2rem;border-radius:10px;font-family:'Sora';font-size:0.88rem;cursor:pointer;">
            Cancelar
          </button>
        </div>
        <p style="font-size:0.68rem;color:var(--text3);text-align:center;margin-top:0.8rem;">O WhatsApp ser√° aberto com a mensagem pronta. Anexe o documento manualmente se necess√°rio.</p>
      </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if(e.target === modal) modal.remove(); });
  } else {
    document.getElementById('wa-msg-preview').value = msg;
    modal.style.display = 'flex';
  }
  setTimeout(() => document.getElementById('wa-tel-input')?.focus(), 300);
}

function confirmarWA() {
  const tel = document.getElementById('wa-tel-input')?.value.replace(/\D/g,'');
  const msg = document.getElementById('wa-msg-preview')?.value || _waMsgPendente;
  if (!tel || tel.length < 10) {
    document.getElementById('wa-tel-input').style.borderColor = '#ff6b35';
    document.getElementById('wa-tel-input').placeholder = 'Informe um n√∫mero v√°lido';
    return;
  }
  const numero = tel.startsWith('55') ? tel : '55' + tel;
  const url = `https://wa.me/${numero}?text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
  document.getElementById('wa-modal').remove();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RELAT√ìRIOS GERENCIAIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chartFat = null, chartAtend = null, chartTipos = null;

// Or√ßamentos salvos localmente
let orcamentosSalvos = [];
function loadOrcamentos() {
  try { orcamentosSalvos = JSON.parse(localStorage.getItem('th_orcamentos') || '[]'); } catch(e) { orcamentosSalvos = []; }
}
function saveOrcamento() {
  const g = id => document.getElementById(id)?.value || '';
  const n = id => parseFloat(document.getElementById(id)?.value || 0) || 0;
  // calc total
  const km = n('orc_km') * n('orc_km_val');
  const desl = km + n('orc_visita_val') + n('orc_pedagio');
  let mdo = 0; document.querySelectorAll('[id^="mdo-"]').forEach(c => { mdo += (parseFloat(c.querySelector('.mdo-qtd').value)||0)*(parseFloat(c.querySelector('.mdo-val').value)||0); });
  let mat = 0; document.querySelectorAll('[id^="mat-"]').forEach(c => { mat += (parseFloat(c.querySelector('.mat-qtd').value)||0)*(parseFloat(c.querySelector('.mat-val').value)||0); });
  const total = Math.max(0, desl + mdo + mat - n('orc_desc'));
  if (!g('orc_data') || total === 0) return;
  const orc = {
    id: Date.now(),
    num: g('orc_num'),
    data: g('orc_data'),
    cliente: g('orc_cliente'),
    tipo: g('orc_tipo'),
    total,
    pgto: g('orc_pgto'),
    status: 'Emitido'
  };
  orcamentosSalvos.unshift(orc);
  try { localStorage.setItem('th_orcamentos', JSON.stringify(orcamentosSalvos)); } catch(e) {}
}

// Hook into gerarOrcamento to auto-save
const _gerarOrcamentoOrig = gerarOrcamento;
gerarOrcamento = function() { _gerarOrcamentoOrig(); saveOrcamento(); };

// Date helpers
function parseDateStr(d) { if(!d) return null; const[a,m,dia]=d.split('-'); return new Date(+a,+m-1,+dia); }
function fmtMes(d) { const meses=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez']; return meses[d.getMonth()]+'/'+String(d.getFullYear()).slice(2); }
function dataF3(d) { if(!d)return'‚Äî'; const[a,m,dia]=d.split('-'); return`${dia}/${m}/${a}`; }

function aplicarPeriodo() {
  const v = document.getElementById('rel_periodo').value;
  const hoje = new Date();
  let de, ate;
  if (v === 'mes') {
    de = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    ate = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
  } else if (v === 'mes_ant') {
    de = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
    ate = new Date(hoje.getFullYear(), hoje.getMonth(), 0);
  } else if (v === 'trim') {
    de = new Date(hoje.getFullYear(), hoje.getMonth() - 2, 1);
    ate = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
  } else if (v === 'ano') {
    de = new Date(hoje.getFullYear(), 0, 1);
    ate = new Date(hoje.getFullYear(), 11, 31);
  } else if (v === 'tudo') {
    de = new Date(2020, 0, 1);
    ate = new Date(2099, 11, 31);
  } else { return; }
  const fmt = d => d.toISOString().split('T')[0];
  document.getElementById('rel_de').value = fmt(de);
  document.getElementById('rel_ate').value = fmt(ate);
  atualizarRelatorios();
}

function atualizarRelatorios() {
  loadOrcamentos();
  loadHist();
  const deStr = document.getElementById('rel_de')?.value;
  const ateStr = document.getElementById('rel_ate')?.value;
  const de = deStr ? parseDateStr(deStr) : new Date(2000,0,1);
  const ate = ateStr ? parseDateStr(ateStr) : new Date(2099,11,31);
  ate.setHours(23,59,59);

  // Filter data
  const orcs = orcamentosSalvos.filter(o => { const d = parseDateStr(o.data); return d >= de && d <= ate; });
  const atends = histAtends.filter(a => { const d = parseDateStr(a.data); return d >= de && d <= ate; });

  // KPIs
  const totalFat = orcs.reduce((s,o) => s+o.total, 0);
  const ticketMedio = orcs.length ? totalFat / orcs.length : 0;
  const proximos = histAtends.filter(a => a.prox && parseDateStr(a.prox) >= new Date()).length;

  renderKPIs(totalFat, orcs.length, atends.length, ticketMedio, proximos);
  renderChartFaturamento(de, ate);
  renderChartAtendimentos(de, ate);
  renderChartTipos(atends);
  renderAgenda();
  renderOrcamentosLista(orcs);
}

function renderKPIs(fat, nOrcs, nAtends, ticket, proximos) {
  const kpis = [
    { label: 'Faturamento', value: 'R$ ' + fat.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.'), icon: 'üí∞', color: '#ffd700' },
    { label: 'Or√ßamentos', value: nOrcs, icon: 'üìÑ', color: '#00d4aa' },
    { label: 'Atendimentos', value: nAtends, icon: 'üîß', color: '#0099ff' },
    { label: 'Ticket M√©dio', value: 'R$ ' + ticket.toFixed(2).replace('.',','), icon: 'üìä', color: '#ff6b35' },
    { label: 'Agendamentos', value: proximos, icon: 'üìÖ', color: '#b478ff' },
  ];
  document.getElementById('rel-kpis').innerHTML = kpis.map(k => `
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1rem;text-align:center;">
      <div style="font-size:1.5rem;margin-bottom:0.3rem;">${k.icon}</div>
      <div style="font-family:'DM Serif Display';font-size:1.4rem;color:${k.color};line-height:1.2;">${k.value}</div>
      <div style="font-size:0.65rem;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-top:0.2rem;">${k.label}</div>
    </div>`).join('');
}

function getLast6Months(de, ate) {
  // Build array of last 6 months in range, or just months in range
  const months = [];
  const cur = new Date(de.getFullYear(), de.getMonth(), 1);
  const end = new Date(ate.getFullYear(), ate.getMonth(), 1);
  while (cur <= end) {
    months.push(new Date(cur));
    cur.setMonth(cur.getMonth() + 1);
    if (months.length > 12) break;
  }
  return months;
}

function renderChartFaturamento(de, ate) {
  const months = getLast6Months(de, ate);
  const labels = months.map(m => fmtMes(m));
  const data = months.map(m => {
    return orcamentosSalvos.filter(o => {
      const d = parseDateStr(o.data);
      return d && d.getMonth() === m.getMonth() && d.getFullYear() === m.getFullYear();
    }).reduce((s,o) => s + o.total, 0);
  });

  const ctx = document.getElementById('chart-fat');
  if (!ctx) return;
  if (chartFat) chartFat.destroy();
  chartFat = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Faturamento (R$)',
        data,
        backgroundColor: 'rgba(255,215,0,0.7)',
        borderColor: '#ffd700',
        borderWidth: 1,
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#8b949e', font: { size: 11 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { ticks: { color: '#8b949e', font: { size: 11 }, callback: v => 'R$' + v.toLocaleString('pt-BR') }, grid: { color: 'rgba(255,255,255,0.06)' }, beginAtZero: true }
      }
    }
  });
}

function renderChartAtendimentos(de, ate) {
  const months = getLast6Months(de, ate);
  const labels = months.map(m => fmtMes(m));
  const data = months.map(m => {
    return histAtends.filter(a => {
      const d = parseDateStr(a.data);
      return d && d.getMonth() === m.getMonth() && d.getFullYear() === m.getFullYear();
    }).length;
  });

  const ctx = document.getElementById('chart-atend');
  if (!ctx) return;
  if (chartAtend) chartAtend.destroy();
  chartAtend = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Atendimentos',
        data,
        borderColor: '#00d4aa',
        backgroundColor: 'rgba(0,212,170,0.1)',
        borderWidth: 2,
        pointBackgroundColor: '#00d4aa',
        pointRadius: 5,
        tension: 0.4,
        fill: true,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#8b949e', font: { size: 11 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { ticks: { color: '#8b949e', font: { size: 11 }, stepSize: 1 }, grid: { color: 'rgba(255,255,255,0.06)' }, beginAtZero: true }
      }
    }
  });
}

function renderChartTipos(atends) {
  const ctx = document.getElementById('chart-tipos');
  if (!ctx) return;

  // Count by type
  const contagem = {};
  atends.forEach(a => { contagem[a.tipo] = (contagem[a.tipo] || 0) + 1; });
  const sorted = Object.entries(contagem).sort((a,b) => b[1]-a[1]);

  if (sorted.length === 0) {
    ctx.parentElement.innerHTML = '<div style="color:var(--text3);font-size:0.8rem;text-align:center;padding:2rem;">Nenhum atendimento no per√≠odo</div>';
    document.getElementById('chart-tipos-legenda').innerHTML = '';
    return;
  }

  const cores = ['#00d4aa','#ffd700','#0099ff','#ff6b35','#b478ff','#ff4081','#69f0ae'];
  const labels = sorted.map(s => s[0]);
  const data = sorted.map(s => s[1]);

  if (chartTipos) chartTipos.destroy();
  chartTipos = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data, backgroundColor: cores.slice(0, data.length), borderWidth: 0, hoverOffset: 8 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '65%',
      plugins: { legend: { display: false } }
    }
  });

  // Custom legend
  const total = data.reduce((s,v) => s+v, 0);
  document.getElementById('chart-tipos-legenda').innerHTML = sorted.map((s,i) => `
    <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
      <div style="width:10px;height:10px;border-radius:50%;background:${cores[i]};flex-shrink:0;"></div>
      <div style="flex:1;font-size:0.76rem;color:var(--text2);">${s[0]}</div>
      <div style="font-family:'DM Mono';font-size:0.75rem;color:var(--text);">${s[1]} <span style="color:var(--text3);">(${Math.round(s[1]/total*100)}%)</span></div>
    </div>`).join('');
}

function renderAgenda() {
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const proximos = histAtends
    .filter(a => a.prox && parseDateStr(a.prox) >= hoje)
    .sort((a,b) => parseDateStr(a.prox) - parseDateStr(b.prox))
    .slice(0, 10);

  const el = document.getElementById('rel-agenda');
  if (proximos.length === 0) {
    el.innerHTML = '<div style="padding:1rem;color:var(--text3);font-size:0.82rem;">Nenhum atendimento agendado.</div>';
    return;
  }

  el.innerHTML = proximos.map(a => {
    const dias = Math.ceil((parseDateStr(a.prox) - hoje) / (1000*60*60*24));
    const urgencia = dias === 0 ? '#ff6b35' : dias <= 3 ? '#ffd700' : dias <= 7 ? '#00d4aa' : '#8b949e';
    const urgLabel = dias === 0 ? 'HOJE' : dias === 1 ? 'AMANH√É' : `em ${dias}d`;
    return `
    <div style="display:flex;align-items:center;gap:0.8rem;padding:0.8rem;background:var(--bg3);border-radius:8px;margin-bottom:0.5rem;border-left:3px solid ${urgencia};">
      <div style="text-align:center;min-width:52px;">
        <div style="font-family:'DM Mono';font-size:0.65rem;font-weight:600;color:${urgencia};">${urgLabel}</div>
        <div style="font-size:0.7rem;color:var(--text2);">${dataF3(a.prox)}</div>
      </div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:0.85rem;font-weight:600;">${clienteNome(a.clienteId)}</div>
        <div style="font-size:0.72rem;color:var(--text2);">${a.tipo} ¬∑ <span style="color:var(--accent);font-family:'DM Mono';">${equipTag(a.equipId)}</span></div>
        ${a.desc ? `<div style="font-size:0.7rem;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${a.desc}</div>` : ''}
      </div>
      <button onclick="enviarLembreteWA('${a.id}')" title="Enviar lembrete por WhatsApp"
        style="background:rgba(37,211,102,0.15);border:1px solid rgba(37,211,102,0.3);color:#25D366;border-radius:8px;padding:0.4rem 0.5rem;cursor:pointer;font-size:1rem;flex-shrink:0;">üì≤</button>
    </div>`;
  }).join('');
}

function enviarLembreteWA(id) {
  const a = histAtends.find(x => x.id == id);
  if (!a) return;
  let cfg = { empresa: '' }; try { Object.assign(cfg, JSON.parse(localStorage.getItem('techar_config') || '{}')); } catch(e) {}
  const cliente = clienteNome(a.clienteId);
  const msg = `Ol√°, *${cliente}*! üëã

Este √© um lembrete do seu pr√≥ximo atendimento agendado:

üìÖ *Data:* ${dataF3(a.prox)}
üîß *Servi√ßo:* ${a.tipo}
‚ùÑÔ∏è *Equipamento:* ${equipTag(a.equipId)}
${a.desc ? `üìã *Obs:* ${a.desc}` : ''}

Qualquer d√∫vida, estou √† disposi√ß√£o!

_${cfg.empresa || 'TechAr Engenharia'}_`;
  mostrarModalWA(msg);
}

function renderOrcamentosLista(orcs) {
  const el = document.getElementById('rel-orcamentos-lista');
  if (orcs.length === 0) {
    el.innerHTML = '<div style="padding:1rem;color:var(--text3);font-size:0.82rem;">Nenhum or√ßamento no per√≠odo selecionado.</div>';
    return;
  }
  const total = orcs.reduce((s,o) => s+o.total, 0);
  el.innerHTML = `
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:0.8rem;">
        <thead>
          <tr style="background:var(--bg3);">
            <th style="padding:8px;text-align:left;color:var(--text2);font-weight:500;">N¬∫</th>
            <th style="padding:8px;text-align:left;color:var(--text2);font-weight:500;">Data</th>
            <th style="padding:8px;text-align:left;color:var(--text2);font-weight:500;">Cliente</th>
            <th style="padding:8px;text-align:left;color:var(--text2);font-weight:500;">Servi√ßo</th>
            <th style="padding:8px;text-align:right;color:var(--text2);font-weight:500;">Valor</th>
          </tr>
        </thead>
        <tbody>
          ${orcs.map((o,i) => `
          <tr style="border-top:1px solid var(--border);background:${i%2===0?'transparent':'rgba(255,255,255,0.01)'};">
            <td style="padding:7px 8px;font-family:'DM Mono';font-size:0.72rem;color:var(--text3);">${o.num||'‚Äî'}</td>
            <td style="padding:7px 8px;color:var(--text2);">${dataF3(o.data)}</td>
            <td style="padding:7px 8px;font-weight:500;">${o.cliente||'‚Äî'}</td>
            <td style="padding:7px 8px;color:var(--text2);font-size:0.75rem;">${o.tipo||'‚Äî'}</td>
            <td style="padding:7px 8px;text-align:right;font-weight:600;color:#ffd700;">R$ ${o.total.toFixed(2).replace('.',',')}</td>
          </tr>`).join('')}
        </tbody>
        <tfoot>
          <tr style="border-top:2px solid var(--border);">
            <td colspan="4" style="padding:8px;font-weight:600;">Total no per√≠odo</td>
            <td style="padding:8px;text-align:right;font-weight:700;color:#ffd700;font-size:0.95rem;">R$ ${total.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.')}</td>
          </tr>
        </tfoot>
      </table>
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTENTICA√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Senha padr√£o ‚Äî hash simples para n√£o ficar vis√≠vel no c√≥digo
// Senha inicial: techar2025
const SENHA_HASH_KEY = 'th_senha_hash';
const SESSION_KEY    = 'th_session';
const SESSION_TTL    = 8 * 60 * 60 * 1000; // 8 horas

function hashSenha(senha) {
  // Hash djb2 simples ‚Äî suficiente para prote√ß√£o b√°sica
  let hash = 5381;
  for (let i = 0; i < senha.length; i++) {
    hash = ((hash << 5) + hash) + senha.charCodeAt(i);
    hash = hash & hash; // 32bit
  }
  return String(hash >>> 0);
}

function getSenhaHash() {
  return localStorage.getItem(SENHA_HASH_KEY) || hashSenha('techar2025');
}

function verificarSessao() {
  try {
    const s = JSON.parse(localStorage.getItem(SESSION_KEY) || '{}');
    return s.ok && (Date.now() - s.ts) < SESSION_TTL;
  } catch(e) { return false; }
}

function iniciarSessao() {
  localStorage.setItem(SESSION_KEY, JSON.stringify({ ok: true, ts: Date.now() }));
}

function encerrarSessao() {
  localStorage.removeItem(SESSION_KEY);
}

function desbloquearApp() {
  document.getElementById('login-screen').classList.add('hide');
  document.body.classList.remove('locked');
}

function tentarLogin() {
  const input = document.getElementById('login-senha');
  const msg   = document.getElementById('login-msg');
  const senha = input.value;

  if (!senha) {
    msg.textContent = 'Digite a senha para continuar.';
    input.classList.add('erro');
    setTimeout(() => input.classList.remove('erro'), 500);
    return;
  }

  if (hashSenha(senha) === getSenhaHash()) {
    iniciarSessao();
    desbloquearApp();
    input.value = '';
    msg.textContent = '';
  } else {
    msg.textContent = 'Senha incorreta. Tente novamente.';
    input.value = '';
    input.classList.add('erro');
    setTimeout(() => input.classList.remove('erro'), 500);
    input.focus();
  }
}

function fazerLogout() {
  encerrarSessao();
  document.body.classList.add('locked');
  document.getElementById('login-screen').classList.remove('hide');
  document.getElementById('login-senha').value = '';
  document.getElementById('login-msg').textContent = '';
  closeDrawer();
}

function alterarSenha() {
  const atual = document.getElementById('seg_atual').value;
  const nova  = document.getElementById('seg_nova').value;
  const conf  = document.getElementById('seg_conf').value;
  const msg   = document.getElementById('seg-msg');

  if (hashSenha(atual) !== getSenhaHash()) {
    msg.textContent = '‚ùå Senha atual incorreta.';
    msg.style.color = '#ff6b35';
    return;
  }
  if (nova.length < 4) {
    msg.textContent = '‚ùå A nova senha deve ter pelo menos 4 caracteres.';
    msg.style.color = '#ff6b35';
    return;
  }
  if (nova !== conf) {
    msg.textContent = '‚ùå As senhas n√£o coincidem.';
    msg.style.color = '#ff6b35';
    return;
  }

  localStorage.setItem(SENHA_HASH_KEY, hashSenha(nova));
  msg.textContent = '‚úì Senha alterada com sucesso!';
  msg.style.color = 'var(--accent)';
  document.getElementById('seg_atual').value = '';
  document.getElementById('seg_nova').value  = '';
  document.getElementById('seg_conf').value  = '';
  setTimeout(() => msg.textContent = '', 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVRO DE REGISTRO DE MANUTEN√á√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const MESES_NOME = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const MESES_ABR  = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

let livroTipo    = 'pmoc';   // 'pmoc' ou 'saude'
let livroMesAtual = 0;       // 0-11
let livroEquipAtual = 0;

// Determina se atividade est√° agendada em dado m√™s (0-11)
function atividadeNoMes(freq, mesIdx) {
  if (freq === 'M') return true;
  if (freq === 'T') return [0,3,6,9].includes(mesIdx);
  if (freq === 'S') return [0,6].includes(mesIdx);
  if (freq === 'A') return mesIdx === 0;
  return false;
}

function freqLabel(freq) {
  return freq==='M'?'Mensal':freq==='T'?'Trimestral':freq==='S'?'Semestral':'Anual';
}
function freqCor(freq) {
  return freq==='M'?'#1565c0':freq==='T'?'#2e7d32':freq==='S'?'#e65100':'#6a1b9a';
}

// Coleta equipamentos do formul√°rio PMOC ativo
function coletarEquipamentos(tipo) {
  const equips = [];
  if (tipo === 'pmoc') {
    document.querySelectorAll('[id^="equip-"]').forEach(card => {
      const tag   = card.querySelector('[id^="e_tag"]')?.value   || card.querySelector('input')?.value || '';
      const model = card.querySelector('[id^="e_modelo"]')?.value || '';
      const local = card.querySelector('[id^="e_local"]')?.value  || '';
      const label = [tag, model, local].filter(Boolean).join(' ‚Äî ') || `Equipamento`;
      equips.push({ label, tag, model, local });
    });
  } else {
    document.querySelectorAll('[id^="od-equip-"]').forEach(card => {
      const tag   = card.querySelector('input')?.value || '';
      const label = tag || `Equipamento`;
      equips.push({ label, tag });
    });
  }
  if (equips.length === 0) equips.push({ label: 'Equipamento 01', tag: 'EQ-01' });
  return equips;
}

// Chave para salvar dados no localStorage
function livroKey(tipo, equipIdx, mesIdx) {
  return `livro_${tipo}_e${equipIdx}_m${mesIdx}`;
}

function salvarDadosMes(tipo, equipIdx, mesIdx) {
  const ativs = (tipo === 'pmoc' ? atividadesPMOC : atividadesOdonto).filter(a => atividadeNoMes(a.freq, mesIdx));
  const dados = { checklist: {}, data: '', tecnico: '', proprietario: '', obs: '', produtos: [] };

  ativs.forEach((_, i) => {
    const sel = document.getElementById(`lv-chk-${i}`);
    if (sel) dados.checklist[i] = sel.value;
  });

  dados.data       = document.getElementById('lv-data')?.value || '';
  dados.tecnico    = document.getElementById('lv-tec-nome')?.value || '';
  dados.proprietario = document.getElementById('lv-prop-nome')?.value || '';
  dados.obs        = document.getElementById('lv-obs')?.value || '';

  // Produtos
  document.querySelectorAll('[id^="lv-prod-"]').forEach(row => {
    const idx = row.id.replace('lv-prod-','');
    dados.produtos.push({
      nome:      document.getElementById(`lv-pnome-${idx}`)?.value || '',
      fabricante:document.getElementById(`lv-pfab-${idx}`)?.value  || '',
      lote:      document.getElementById(`lv-plote-${idx}`)?.value  || '',
      validade:  document.getElementById(`lv-pval-${idx}`)?.value   || '',
      diluicao:  document.getElementById(`lv-pdil-${idx}`)?.value   || '',
    });
  });

  localStorage.setItem(livroKey(tipo, equipIdx, mesIdx), JSON.stringify(dados));
  mostrarToast('‚úì Registro salvo!');
}

function carregarDadosMes(tipo, equipIdx, mesIdx) {
  try { return JSON.parse(localStorage.getItem(livroKey(tipo, equipIdx, mesIdx)) || 'null'); } catch(e) { return null; }
}

function abrirLivro(tipo) {
  livroTipo = tipo;
  livroMesAtual = new Date().getMonth();
  livroEquipAtual = 0;

  const modal = document.getElementById('livro-modal');
  modal.style.display = 'block';
  document.body.style.overflow = 'hidden';

  const equips = coletarEquipamentos(tipo);
  const sel = document.getElementById('livro-equip-sel');
  sel.innerHTML = equips.map((e,i) => `<option value="${i}">${e.label}</option>`).join('');

  const titulo = tipo === 'pmoc' ? 'PMOC Geral ‚Äî NBR 16401' : 'PMOC Sa√∫de ‚Äî RDC ANVISA 50/2002';
  document.getElementById('livro-subtitulo').textContent = titulo;

  renderMesTabs();
  renderMesConteudo();
}

function fecharLivro() {
  document.getElementById('livro-modal').style.display = 'none';
  document.body.style.overflow = '';
}

function trocarEquipLivro() {
  livroEquipAtual = parseInt(document.getElementById('livro-equip-sel').value) || 0;
  renderMesConteudo();
}

function renderMesTabs() {
  const tabs = document.getElementById('livro-mes-tabs');
  tabs.innerHTML = MESES_ABR.map((m, i) => {
    const dados = carregarDadosMes(livroTipo, livroEquipAtual, i);
    const temDados = dados && (dados.data || dados.tecnico || Object.keys(dados.checklist||{}).length > 0);
    const ativo = i === livroMesAtual;
    return `<button onclick="mudarMes(${i})"
      style="padding:0.35rem 0.6rem;border-radius:6px;font-size:0.72rem;font-family:'DM Mono';cursor:pointer;
             border:1px solid ${ativo?'#4caf50':temDados?'rgba(76,175,80,0.3)':'var(--border)'};
             background:${ativo?'rgba(76,175,80,0.15)':'transparent'};
             color:${ativo?'#4caf50':temDados?'#81c784':'var(--text2)'};
             font-weight:${ativo?'700':'400'};">
      ${m}${temDados?'<span style="color:#4caf50;font-size:0.6rem;vertical-align:super;">‚úì</span>':''}
    </button>`;
  }).join('');
}

function mudarMes(idx) {
  livroMesAtual = idx;
  renderMesTabs();
  renderMesConteudo();
}

let produtoLivroNum = 0;

function renderMesConteudo() {
  produtoLivroNum = 0;
  const tipo     = livroTipo;
  const mesIdx   = livroMesAtual;
  const equipIdx = livroEquipAtual;
  const ativs    = (tipo === 'pmoc' ? atividadesPMOC : atividadesOdonto).filter(a => atividadeNoMes(a.freq, mesIdx));
  const dados    = carregarDadosMes(tipo, equipIdx, mesIdx) || {};
  const equips   = coletarEquipamentos(tipo);
  const equip    = equips[equipIdx] || equips[0];
  const cor      = tipo === 'pmoc' ? '#0d3b6e' : '#0077bb';

  // Agrupa atividades por grupo
  const grupos = {};
  ativs.forEach((a, i) => {
    if (!grupos[a.grupo]) grupos[a.grupo] = [];
    grupos[a.grupo].push({ ...a, idx: i });
  });

  let atvsHTML = '';
  Object.entries(grupos).forEach(([grp, lista]) => {
    atvsHTML += `<div style="margin-bottom:0.8rem;">
      <div style="font-size:0.68rem;font-family:'DM Mono';text-transform:uppercase;letter-spacing:1px;color:var(--text3);padding:0.3rem 0;border-bottom:1px solid var(--border);margin-bottom:0.4rem;">${grp}</div>`;
    lista.forEach(a => {
      const val = dados.checklist?.[a.idx] || 'pendente';
      const badgeCor = freqCor(a.freq);
      atvsHTML += `
        <div style="display:flex;align-items:center;gap:0.7rem;padding:0.5rem 0.3rem;border-bottom:1px solid rgba(255,255,255,0.04);">
          <select id="lv-chk-${a.idx}"
            style="flex-shrink:0;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:0.3rem 0.4rem;font-size:0.72rem;font-family:'Sora';color:var(--text);">
            <option value="pendente" ${val==='pendente'?'selected':''}>‚è≥ Pendente</option>
            <option value="realizado" ${val==='realizado'?'selected':''}>‚úÖ Realizado</option>
            <option value="nao_aplicavel" ${val==='nao_aplicavel'?'selected':''}>‚Äî N/A</option>
            <option value="nao_realizado" ${val==='nao_realizado'?'selected':''}>‚ùå N√£o realizado</option>
          </select>
          <div style="flex:1;font-size:0.8rem;color:var(--text);">${a.atividade}</div>
          <span style="font-size:0.62rem;font-family:'DM Mono';color:${badgeCor};background:rgba(${badgeCor==='#1565c0'?'21,101,192':badgeCor==='#2e7d32'?'46,125,50':badgeCor==='#e65100'?'230,81,0':'106,27,154'},0.1);border-radius:4px;padding:0.1rem 0.4rem;white-space:nowrap;">${freqLabel(a.freq)}</span>
        </div>`;
    });
    atvsHTML += `</div>`;
  });

  if (ativs.length === 0) {
    atvsHTML = `<div style="padding:2rem;text-align:center;color:var(--text3);font-size:0.85rem;">Nenhuma manuten√ß√£o programada para ${MESES_NOME[mesIdx]}.<br><span style="font-size:0.75rem;">Atividades mensais s√£o exibidas em todos os meses.</span></div>`;
  }

  // Produtos qu√≠micos existentes
  const prods = dados.produtos || [];
  let prodsHTML = prods.map((p, i) => renderProdutoRow(i, p)).join('');

  document.getElementById('livro-mes-content').innerHTML = `
    <!-- CABE√áALHO DO M√äS -->
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1rem 1.2rem;margin-bottom:1rem;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.5rem;">
        <div>
          <div style="font-family:'DM Serif Display';font-size:1.1rem;color:#4caf50;">${MESES_NOME[mesIdx]}</div>
          <div style="font-size:0.72rem;color:var(--text2);">Equipamento: <strong style="color:var(--text);">${equip.label}</strong></div>
        </div>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <div style="font-size:0.72rem;color:var(--text2);">Data de execu√ß√£o:</div>
          <input type="date" id="lv-data" value="${dados.data||''}"
            style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:0.35rem 0.6rem;color:var(--text);font-size:0.8rem;font-family:'Sora';">
        </div>
      </div>
    </div>

    <!-- ATIVIDADES DO M√äS -->
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1rem 1.2rem;margin-bottom:1rem;">
      <div style="font-weight:600;font-size:0.88rem;margin-bottom:0.8rem;display:flex;align-items:center;gap:0.5rem;">
        üîß Atividades Programadas
        <span style="font-size:0.68rem;font-family:'DM Mono';color:var(--text3);font-weight:400;">${ativs.length} atividade(s)</span>
      </div>
      ${atvsHTML}
    </div>

    <!-- PRODUTOS QU√çMICOS -->
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1rem 1.2rem;margin-bottom:1rem;">
      <div style="font-weight:600;font-size:0.88rem;margin-bottom:0.8rem;">üß™ Produtos Qu√≠micos Utilizados</div>
      <p style="font-size:0.75rem;color:var(--text2);margin-bottom:0.8rem;">Registre todos os saneantes, desinfetantes e produtos utilizados na manuten√ß√£o.</p>
      <div id="lv-produtos-lista">${prodsHTML}</div>
      <button onclick="addProdutoLivro()" style="background:none;border:1px dashed var(--border);color:var(--text2);padding:0.5rem 1rem;border-radius:8px;cursor:pointer;font-size:0.78rem;font-family:'Sora';width:100%;margin-top:0.5rem;">
        + Adicionar Produto
      </button>
    </div>

    <!-- ASSINATURAS -->
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1rem 1.2rem;margin-bottom:1rem;">
      <div style="font-weight:600;font-size:0.88rem;margin-bottom:1rem;">‚úçÔ∏è Assinaturas</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <!-- T√©cnico -->
        <div>
          <div style="font-size:0.72rem;color:var(--text2);margin-bottom:0.4rem;font-weight:600;">T√âCNICO RESPONS√ÅVEL</div>
          <input type="text" id="lv-tec-nome" value="${dados.tecnico||''}" placeholder="Nome do t√©cnico"
            style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:0.5rem;font-size:0.8rem;font-family:'Sora';color:var(--text);margin-bottom:0.5rem;">
          <div style="background:white;border-radius:8px;overflow:hidden;border:1px solid var(--border);">
            <canvas id="lv-sig-tec" width="400" height="100" style="width:100%;height:75px;cursor:crosshair;display:block;"></canvas>
          </div>
          <div style="display:flex;gap:0.4rem;margin-top:0.3rem;">
            <button onclick="limparSigLivro('tec')" style="background:none;border:1px solid var(--border);color:var(--text2);padding:0.25rem 0.6rem;border-radius:4px;cursor:pointer;font-size:0.68rem;font-family:'Sora';">üóë Limpar</button>
            <button onclick="salvarSigLivro('tec')" style="background:var(--accent);border:none;color:#0d1117;padding:0.25rem 0.7rem;border-radius:4px;cursor:pointer;font-size:0.68rem;font-weight:600;font-family:'Sora';">‚úì Salvar</button>
            <span id="lv-sig-tec-ok" style="font-size:0.68rem;color:var(--accent);align-self:center;"></span>
          </div>
        </div>
        <!-- Propriet√°rio -->
        <div>
          <div style="font-size:0.72rem;color:var(--text2);margin-bottom:0.4rem;font-weight:600;">PROPRIET√ÅRIO / RESPONS√ÅVEL</div>
          <input type="text" id="lv-prop-nome" value="${dados.proprietario||''}" placeholder="Nome do propriet√°rio"
            style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:0.5rem;font-size:0.8rem;font-family:'Sora';color:var(--text);margin-bottom:0.5rem;">
          <div style="background:white;border-radius:8px;overflow:hidden;border:1px solid var(--border);">
            <canvas id="lv-sig-prop" width="400" height="100" style="width:100%;height:75px;cursor:crosshair;display:block;"></canvas>
          </div>
          <div style="display:flex;gap:0.4rem;margin-top:0.3rem;">
            <button onclick="limparSigLivro('prop')" style="background:none;border:1px solid var(--border);color:var(--text2);padding:0.25rem 0.6rem;border-radius:4px;cursor:pointer;font-size:0.68rem;font-family:'Sora';">üóë Limpar</button>
            <button onclick="salvarSigLivro('prop')" style="background:var(--accent);border:none;color:#0d1117;padding:0.25rem 0.7rem;border-radius:4px;cursor:pointer;font-size:0.68rem;font-weight:600;font-family:'Sora';">‚úì Salvar</button>
            <span id="lv-sig-prop-ok" style="font-size:0.68rem;color:var(--accent);align-self:center;"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- OBSERVA√á√ïES -->
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1rem 1.2rem;margin-bottom:1rem;">
      <div style="font-weight:600;font-size:0.88rem;margin-bottom:0.6rem;">üìù Observa√ß√µes do T√©cnico</div>
      <textarea id="lv-obs" placeholder="Registre aqui observa√ß√µes sobre o estado dos equipamentos, intercorr√™ncias, recomenda√ß√µes..." 
        style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0.7rem;color:var(--text);font-family:'Sora';font-size:0.82rem;min-height:80px;resize:vertical;">${dados.obs||''}</textarea>
    </div>

    <!-- BOT√ÉO SALVAR -->
    <div style="display:flex;gap:0.8rem;flex-wrap:wrap;">
      <button onclick="salvarDadosMes('${tipo}',${equipIdx},${mesIdx})"
        style="background:#2e7d32;border:none;color:white;padding:0.8rem 1.5rem;border-radius:10px;font-family:'Sora';font-weight:700;font-size:0.9rem;cursor:pointer;flex:1;">
        üíæ Salvar Registro de ${MESES_NOME[mesIdx]}
      </button>
      <button onclick="gerarLivroImpressao()"
        style="background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:0.8rem 1.2rem;border-radius:10px;font-family:'Sora';font-size:0.88rem;cursor:pointer;">
        üñ®Ô∏è Imprimir
      </button>
    </div>
  `;

  // Recarregar assinaturas salvas
  initSigLivro('tec');
  initSigLivro('prop');
  const sigTecSalva  = localStorage.getItem(`livro_sig_tec_${tipo}_e${equipIdx}_m${mesIdx}`);
  const sigPropSalva = localStorage.getItem(`livro_sig_prop_${tipo}_e${equipIdx}_m${mesIdx}`);
  if (sigTecSalva)  { desenharSigSalva('tec',  sigTecSalva);  document.getElementById('lv-sig-tec-ok').textContent  = '‚úì Salva'; }
  if (sigPropSalva) { desenharSigSalva('prop', sigPropSalva); document.getElementById('lv-sig-prop-ok').textContent = '‚úì Salva'; }

  // Restaurar produtos
  if (prods.length > 0) produtoLivroNum = prods.length;
}

function renderProdutoRow(i, p) {
  return `<div id="lv-prod-${i}" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0.7rem;margin-bottom:0.5rem;position:relative;">
    <button onclick="document.getElementById('lv-prod-${i}').remove()" style="position:absolute;top:0.4rem;right:0.4rem;background:none;border:none;color:var(--text3);cursor:pointer;font-size:0.9rem;">‚úï</button>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
      <div><div style="font-size:0.68rem;color:var(--text2);margin-bottom:0.2rem;">Produto / Saneante</div>
        <input id="lv-pnome-${i}" type="text" value="${p?.nome||''}" placeholder="Ex: Biocida Clean-A" style="width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:0.35rem 0.5rem;font-size:0.78rem;font-family:'Sora';color:var(--text);"></div>
      <div><div style="font-size:0.68rem;color:var(--text2);margin-bottom:0.2rem;">Fabricante</div>
        <input id="lv-pfab-${i}" type="text" value="${p?.fabricante||''}" placeholder="Fabricante" style="width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:0.35rem 0.5rem;font-size:0.78rem;font-family:'Sora';color:var(--text);"></div>
      <div><div style="font-size:0.68rem;color:var(--text2);margin-bottom:0.2rem;">N¬∫ do Lote</div>
        <input id="lv-plote-${i}" type="text" value="${p?.lote||''}" placeholder="LOT-00000" style="width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:0.35rem 0.5rem;font-size:0.78rem;font-family:'Sora';color:var(--text);"></div>
      <div><div style="font-size:0.68rem;color:var(--text2);margin-bottom:0.2rem;">Data de Validade</div>
        <input id="lv-pval-${i}" type="date" value="${p?.validade||''}" style="width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:0.35rem 0.5rem;font-size:0.78rem;font-family:'Sora';color:var(--text);"></div>
      <div style="grid-column:span 2;"><div style="font-size:0.68rem;color:var(--text2);margin-bottom:0.2rem;">Dilui√ß√£o (quando aplic√°vel)</div>
        <input id="lv-pdil-${i}" type="text" value="${p?.diluicao||''}" placeholder="Ex: 1:10 em √°gua, 100ml/L" style="width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:0.35rem 0.5rem;font-size:0.78rem;font-family:'Sora';color:var(--text);"></div>
    </div>
  </div>`;
}

function addProdutoLivro() {
  const lista = document.getElementById('lv-produtos-lista');
  const div = document.createElement('div');
  div.innerHTML = renderProdutoRow(produtoLivroNum, {});
  lista.appendChild(div.firstElementChild);
  produtoLivroNum++;
}

// ‚îÄ‚îÄ ASSINATURAS DO LIVRO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const lvSig = {};

function initSigLivro(quem) {
  const canvas = document.getElementById(`lv-sig-${quem}`);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  lvSig[quem] = { canvas, ctx, drawing: false, hasMark: false };
  ctx.strokeStyle = '#1a1a2e'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
  // Linha guia
  ctx.save(); ctx.strokeStyle = '#ddd'; ctx.lineWidth = 1; ctx.setLineDash([3,3]);
  ctx.beginPath(); ctx.moveTo(10, canvas.height*0.75); ctx.lineTo(canvas.width-10, canvas.height*0.75); ctx.stroke();
  ctx.restore(); ctx.setLineDash([]);

  function pos(e) {
    const r = canvas.getBoundingClientRect(), sx = canvas.width/r.width, sy = canvas.height/r.height;
    const src = e.touches ? e.touches[0] : e;
    return { x: (src.clientX-r.left)*sx, y: (src.clientY-r.top)*sy };
  }
  canvas.onmousedown = e => { lvSig[quem].drawing=true; lvSig[quem].hasMark=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); };
  canvas.onmousemove = e => { if(!lvSig[quem].drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); };
  canvas.onmouseup = () => lvSig[quem].drawing=false;
  canvas.onmouseleave = () => lvSig[quem].drawing=false;
  canvas.ontouchstart = e => { e.preventDefault(); lvSig[quem].drawing=true; lvSig[quem].hasMark=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); };
  canvas.ontouchmove = e => { e.preventDefault(); if(!lvSig[quem].drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); };
  canvas.ontouchend = e => { e.preventDefault(); lvSig[quem].drawing=false; };
}

function limparSigLivro(quem) {
  const s = lvSig[quem]; if (!s) return;
  s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height);
  s.ctx.save(); s.ctx.strokeStyle='#ddd'; s.ctx.lineWidth=1; s.ctx.setLineDash([3,3]);
  s.ctx.beginPath(); s.ctx.moveTo(10,s.canvas.height*0.75); s.ctx.lineTo(s.canvas.width-10,s.canvas.height*0.75); s.ctx.stroke();
  s.ctx.restore(); s.ctx.setLineDash([]); s.hasMark=false;
  document.getElementById(`lv-sig-${quem}-ok`).textContent = '';
}

function salvarSigLivro(quem) {
  const s = lvSig[quem]; if (!s || !s.hasMark) { document.getElementById(`lv-sig-${quem}-ok`).textContent='Assine primeiro'; return; }
  const dataURL = s.canvas.toDataURL('image/png');
  localStorage.setItem(`livro_sig_${quem}_${livroTipo}_e${livroEquipAtual}_m${livroMesAtual}`, dataURL);
  document.getElementById(`lv-sig-${quem}-ok`).textContent = '‚úì Salva!';
}

function desenharSigSalva(quem, dataURL) {
  const s = lvSig[quem]; if (!s) return;
  const img = new Image(); img.onload = () => { s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height); s.ctx.drawImage(img,0,0); s.hasMark=true; };
  img.src = dataURL;
}

// ‚îÄ‚îÄ GERA√á√ÉO DO LIVRO PARA IMPRESS√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function gerarLivroImpressao() {
  let cfg = { empresa:'', cor:'#0d3b6e' };
  try { Object.assign(cfg, JSON.parse(localStorage.getItem('techar_config')||'{}')); } catch(e) {}
  const cor = cfg.cor || '#0d3b6e';
  const tipo = livroTipo;
  const equipIdx = livroEquipAtual;
  const equips = coletarEquipamentos(tipo);
  const equip  = equips[equipIdx] || equips[0];
  const hoje   = new Date().toLocaleDateString('pt-BR');
  const titulo = tipo === 'pmoc' ? 'PMOC ‚Äî NBR 16401' : 'PMOC Sa√∫de ‚Äî RDC ANVISA 50/2002';

  let paginasHTML = '';

  MESES_NOME.forEach((mesNome, mesIdx) => {
    const ativs = (tipo === 'pmoc' ? atividadesPMOC : atividadesOdonto).filter(a => atividadeNoMes(a.freq, mesIdx));
    const dados = carregarDadosMes(tipo, equipIdx, mesIdx) || {};
    const sigTec  = localStorage.getItem(`livro_sig_tec_${tipo}_e${equipIdx}_m${mesIdx}`) || '';
    const sigProp = localStorage.getItem(`livro_sig_prop_${tipo}_e${equipIdx}_m${mesIdx}`) || '';
    const dataF   = d => { if(!d)return'___/___/______'; const[a,m,di]=d.split('-'); return`${di}/${m}/${a}`; };

    // Agrupa atividades
    const grupos = {};
    ativs.forEach((a,i) => { if(!grupos[a.grupo]) grupos[a.grupo]=[]; grupos[a.grupo].push({...a,idx:i}); });

    let atvsTabela = '';
    Object.entries(grupos).forEach(([grp, lista]) => {
      atvsTabela += `<tr><td colspan="3" style="background:#f0f4f8;font-size:0.68rem;font-weight:700;color:${cor};padding:4px 6px;text-transform:uppercase;letter-spacing:0.5px;">${grp}</td></tr>`;
      lista.forEach(a => {
        const status = dados.checklist?.[a.idx] || 'pendente';
        const statusTxt = status==='realizado'?'‚úÖ Realizado':status==='nao_aplicavel'?'‚Äî N/A':status==='nao_realizado'?'‚ùå N√£o realizado':'‚è≥ Pendente';
        const statusCor = status==='realizado'?'#2e7d32':status==='nao_realizado'?'#c62828':status==='nao_aplicavel'?'#555':'#e65100';
        atvsTabela += `<tr style="border-bottom:1px solid #eee;">
          <td style="padding:4px 6px;font-size:0.75rem;">${a.atividade}</td>
          <td style="padding:4px 6px;font-size:0.7rem;text-align:center;white-space:nowrap;color:${freqCor(a.freq)};">${freqLabel(a.freq)}</td>
          <td style="padding:4px 6px;font-size:0.72rem;text-align:center;color:${statusCor};font-weight:bold;">${statusTxt}</td>
        </tr>`;
      });
    });

    if (ativs.length === 0) {
      atvsTabela = `<tr><td colspan="3" style="text-align:center;color:#999;padding:1rem;font-size:0.8rem;">Nenhuma atividade programada neste m√™s</td></tr>`;
    }

    // Produtos
    let prodsTabela = '';
    if (dados.produtos && dados.produtos.length > 0) {
      dados.produtos.forEach(p => {
        prodsTabela += `<tr style="border-bottom:1px solid #eee;">
          <td style="padding:3px 5px;font-size:0.72rem;">${p.nome||'‚Äî'}</td>
          <td style="padding:3px 5px;font-size:0.72rem;">${p.fabricante||'‚Äî'}</td>
          <td style="padding:3px 5px;font-size:0.72rem;text-align:center;">${p.lote||'‚Äî'}</td>
          <td style="padding:3px 5px;font-size:0.72rem;text-align:center;">${dataF(p.validade)}</td>
          <td style="padding:3px 5px;font-size:0.72rem;">${p.diluicao||'‚Äî'}</td>
        </tr>`;
      });
    } else {
      prodsTabela = `<tr><td colspan="5" style="text-align:center;color:#bbb;padding:0.5rem;font-size:0.75rem;">Nenhum produto registrado</td></tr>`;
    }

    paginasHTML += `
    <div style="page-break-after:always;padding:1.5cm;font-family:serif;color:#111;font-size:10pt;">
      <!-- Cabe√ßalho -->
      <div style="border-bottom:2px solid ${cor};padding-bottom:0.5rem;margin-bottom:0.8rem;display:flex;justify-content:space-between;align-items:flex-end;">
        <div>
          <div style="font-size:13pt;font-weight:bold;color:${cor};">Livro de Registro de Manuten√ß√£o</div>
          <div style="font-size:8pt;color:#555;">${titulo} ¬∑ ${equip.label}</div>
        </div>
        <div style="text-align:right;font-size:8pt;color:#777;">
          <div>Data de execu√ß√£o: <strong>${dataF(dados.data)}</strong></div>
          <div>Emiss√£o: ${hoje}</div>
        </div>
      </div>

      <!-- M√™s -->
      <div style="background:${cor};color:white;padding:0.4rem 0.8rem;font-size:11pt;font-weight:bold;margin-bottom:0.8rem;border-radius:3px;">
        ${mesNome} ‚Äî Manuten√ß√µes Programadas
      </div>

      <!-- Tabela de atividades -->
      <table style="width:100%;border-collapse:collapse;margin-bottom:0.8rem;">
        <thead>
          <tr style="background:#e8edf2;">
            <th style="padding:5px 6px;text-align:left;font-size:8pt;color:${cor};border-bottom:1px solid #ccc;">Atividade</th>
            <th style="padding:5px 6px;text-align:center;font-size:8pt;color:${cor};border-bottom:1px solid #ccc;width:80px;">Periodicidade</th>
            <th style="padding:5px 6px;text-align:center;font-size:8pt;color:${cor};border-bottom:1px solid #ccc;width:100px;">Situa√ß√£o</th>
          </tr>
        </thead>
        <tbody>${atvsTabela}</tbody>
      </table>

      <!-- Produtos -->
      <div style="font-size:9pt;font-weight:bold;color:${cor};margin-bottom:0.3rem;border-bottom:1px solid ${cor};padding-bottom:0.2rem;">Produtos Qu√≠micos Utilizados</div>
      <table style="width:100%;border-collapse:collapse;margin-bottom:0.8rem;">
        <thead>
          <tr style="background:#e8edf2;">
            <th style="padding:3px 5px;text-align:left;font-size:7.5pt;color:${cor};">Produto</th>
            <th style="padding:3px 5px;text-align:left;font-size:7.5pt;color:${cor};">Fabricante</th>
            <th style="padding:3px 5px;text-align:center;font-size:7.5pt;color:${cor};">Lote</th>
            <th style="padding:3px 5px;text-align:center;font-size:7.5pt;color:${cor};">Validade</th>
            <th style="padding:3px 5px;text-align:left;font-size:7.5pt;color:${cor};">Dilui√ß√£o</th>
          </tr>
        </thead>
        <tbody>${prodsTabela}</tbody>
      </table>

      <!-- Observa√ß√µes -->
      <div style="font-size:9pt;font-weight:bold;color:${cor};margin-bottom:0.3rem;">Observa√ß√µes:</div>
      <div style="border:1px solid #ccc;min-height:40px;padding:0.4rem;font-size:8.5pt;color:#333;border-radius:2px;margin-bottom:0.8rem;">
        ${dados.obs || ''}
      </div>

      <!-- Assinaturas -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-top:0.5rem;">
        <div style="text-align:center;">
          ${sigTec ? `<img src="${sigTec}" style="height:50px;max-width:180px;object-fit:contain;display:block;margin:0 auto 0.3rem;">` : '<div style="height:50px;"></div>'}
          <div style="border-top:1px solid #333;padding-top:0.3rem;font-size:8pt;">
            <strong>${dados.tecnico || '_______________________________'}</strong><br>T√©cnico Respons√°vel<br>
          </div>
        </div>
        <div style="text-align:center;">
          ${sigProp ? `<img src="${sigProp}" style="height:50px;max-width:180px;object-fit:contain;display:block;margin:0 auto 0.3rem;">` : '<div style="height:50px;"></div>'}
          <div style="border-top:1px solid #333;padding-top:0.3rem;font-size:8pt;">
            <strong>${dados.proprietario || '_______________________________'}</strong><br>Propriet√°rio / Respons√°vel<br>
          </div>
        </div>
      </div>
    </div>`;
  });

  // Abre em nova janela para impress√£o
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Livro de Registro ‚Äî ${equip.label}</title>
    <style>@media print { body{margin:0} } body{margin:0;padding:0;}</style></head>
    <body>${paginasHTML}<script>window.onload=()=>{window.print();}<\/script></body></html>`);
  win.document.close();
}

function mostrarToast(msg) {
  let t = document.getElementById('livro-toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'livro-toast';
    t.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#2e7d32;color:white;padding:0.6rem 1.2rem;border-radius:20px;font-family:Sora,sans-serif;font-size:0.82rem;font-weight:600;z-index:99999;transition:opacity 0.3s;';
    document.body.appendChild(t);
  }
  t.textContent = msg; t.style.opacity = '1';
  setTimeout(() => t.style.opacity = '0', 2000);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
  // Verificar sess√£o ativa
  if (verificarSessao()) {
    desbloquearApp();
  } else {
    document.getElementById('login-senha').focus();
  }

  addEquipamento();
  buildChecklist();
  initSignature();
  initSigCliente();
  carregarConfigSalva();
  loadHist();
  loadOrcamentos();
  calcCarga();
  document.getElementById('l_data').value = today;
  document.getElementById('c_data').value = today;
  document.getElementById('rv_data').value = today;
  document.getElementById('orc_data').value = today;
  // Set default period to current month for dashboard
  const now = new Date();
  const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  const lastDay = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().split('T')[0];
  if(document.getElementById('rel_de'))  document.getElementById('rel_de').value = firstDay;
  if(document.getElementById('rel_ate')) document.getElementById('rel_ate').value = lastDay;
  if(document.getElementById('rel_periodo')) document.getElementById('rel_periodo').value = 'mes';
});


</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIVRO DE REGISTRO MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="livro-modal" style="display:none;position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,0.85);overflow-y:auto;">
  <div style="max-width:900px;margin:1rem auto;padding:0 0.5rem 3rem;">
    <!-- HEADER DO MODAL -->
    <div style="background:var(--bg2);border:1px solid #2e7d32;border-radius:14px;padding:1.2rem 1.5rem;margin-bottom:1rem;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
      <div style="flex:1;">
        <div style="font-family:'DM Serif Display';font-size:1.3rem;color:#4caf50;">üìí Livro de Registro de Manuten√ß√£o</div>
        <div id="livro-subtitulo" style="font-size:0.78rem;color:var(--text2);margin-top:0.2rem;"></div>
      </div>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
        <select id="livro-equip-sel" onchange="trocarEquipLivro()"
          style="background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:0.5rem 0.8rem;border-radius:8px;font-family:'Sora';font-size:0.82rem;">
        </select>
        <button onclick="gerarLivroImpressao()" style="background:#2e7d32;border:none;color:white;padding:0.5rem 1rem;border-radius:8px;font-family:'Sora';font-weight:600;font-size:0.82rem;cursor:pointer;">üñ®Ô∏è Imprimir</button>
        <button onclick="fecharLivro()" style="background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:0.5rem 1rem;border-radius:8px;font-family:'Sora';font-size:0.82rem;cursor:pointer;">‚úï Fechar</button>
      </div>
    </div>

    <!-- NAVEGA√á√ÉO DE MESES -->
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:0.8rem;margin-bottom:1rem;">
      <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
        <span style="font-size:0.72rem;color:var(--text2);font-family:'DM Mono';text-transform:uppercase;letter-spacing:1px;margin-right:0.3rem;">M√™s:</span>
        <div id="livro-mes-tabs" style="display:flex;gap:0.3rem;flex-wrap:wrap;"></div>
      </div>
    </div>

    <!-- CONTE√öDO DO M√äS ATUAL -->
    <div id="livro-mes-content"></div>
  </div>
</div>

<!-- LIVRO PRINT AREA -->
<div id="livro-print-area" style="display:none;"></div>

<div id="install-banner" style="display:none;position:fixed;bottom:0;left:0;right:0;z-index:9999;
  background:linear-gradient(135deg,#161b22,#21262d);border-top:1px solid #00d4aa;
  padding:1rem 1.5rem;display:flex;align-items:center;gap:1rem;animation:slideUp 0.4s ease;">
  <div style="width:44px;height:44px;border-radius:10px;overflow:hidden;flex-shrink:0;">
    <img id="banner-icon" style="width:100%;height:100%;">
  </div>
  <div style="flex:1;">
    <div style="font-family:Sora,sans-serif;font-weight:600;color:#e6edf3;font-size:0.9rem;">Instalar TechAr</div>
    <div style="font-family:Sora,sans-serif;color:#8b949e;font-size:0.75rem;">Adicionar √† tela inicial como app</div>
  </div>
  <button onclick="installApp()" style="background:#00d4aa;color:#0d1117;border:none;padding:0.5rem 1.2rem;
    border-radius:8px;font-family:Sora,sans-serif;font-weight:600;font-size:0.82rem;cursor:pointer;">
    Instalar
  </button>
  <button onclick="dismissBanner()" style="background:none;border:none;color:#8b949e;font-size:1.2rem;cursor:pointer;padding:0.3rem;">‚úï</button>
</div>

<style>
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
#install-banner { display: none; }
#install-banner.show { display: flex !important; }
</style>

<script>
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const banner = document.getElementById('install-banner');
  document.getElementById('banner-icon').src = icon192;
  banner.classList.add('show');
});

function installApp() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(choice => {
    deferredPrompt = null;
    dismissBanner();
  });
}

function dismissBanner() {
  document.getElementById('install-banner').classList.remove('show');
}

window.addEventListener('appinstalled', () => {
  dismissBanner();
  deferredPrompt = null;
});
</script>

</body>
</html>
